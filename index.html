
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Processing Tool</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #ffeef0 0%, #fdf2f8 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1200px; margin: 0 auto; background: white;
            border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden; display: flex; flex-direction: column;
            min-height: calc(100vh - 40px);
        }
        .header {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: white; padding: 30px; text-align: center;
        }
        .header h1 { font-size: 32px; font-weight: 600; margin-bottom: 10px; }
        .main-content { flex: 1; padding: 40px; }
        .upload-section {
            background: #f8f9fa; border-radius: 12px; padding: 30px;
            margin-bottom: 30px; border: 2px dashed #cbd5e0;
            transition: all 0.3s;
        }
        .upload-section:hover { border-color: #ff9a9e; background: #f7fafc; }
        .file-input-group {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .file-input-item { display: flex; flex-direction: column; }
        .file-input-item label { font-weight: 500; color: #4a5568; margin-bottom: 8px; }
        .file-input { position: absolute; left: -9999px; }
        .file-input-button {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 12px 20px; background: #ff9a9e; color: white;
            border: none; border-radius: 8px; cursor: pointer;
            transition: all 0.3s; font-size: 14px; font-weight: 500;
            width: 100%; justify-content: center;
        }
        .file-input-button:hover { background: #ff8a8a; transform: translateY(-2px); }
        .file-name { margin-top: 8px; font-size: 12px; color: #666; word-break: break-all; }
        .file-name.has-file { color: #48bb78; font-weight: 500; }
        .process-section { text-align: center; margin: 40px 0; }
        .btn {
            padding: 15px 30px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 500; cursor: pointer;
            transition: all 0.3s; display: inline-flex; align-items: center;
            gap: 10px; margin: 0 10px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: #ff9a9e; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .progress-section { margin: 30px 0; display: none; }
        .progress-bar {
            width: 100%; height: 20px; background: #e2e8f0;
            border-radius: 10px; overflow: hidden; margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #ff9a9e, #fecfef);
            width: 0%; transition: width 0.3s;
        }
        .progress-text { text-align: center; color: #666; font-size: 14px; }
        .results-section { margin-top: 30px; display: none; }
        .results-section h3 { color: #2d3748; margin-bottom: 20px; }
        .download-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .download-item {
            background: #f8f9fa; padding: 15px; border-radius: 8px;
            border: 1px solid #e2e8f0; display: flex;
            justify-content: space-between; align-items: center;
        }
        .download-btn {
            padding: 8px 16px; background: #48bb78; color: white;
            border: none; border-radius: 6px; cursor: pointer;
            font-size: 12px; transition: background 0.3s;
        }
        .download-btn:hover { background: #38a169; }
        .log-section { margin-top: 30px; display: none; }
        .log-container {
            background: #1a202c; color: #e2e8f0; padding: 20px;
            border-radius: 8px; font-family: 'Courier New', monospace;
            font-size: 13px; line-height: 1.5; max-height: 300px; overflow-y: auto;
        }
        .log-entry { margin-bottom: 5px; }
        .log-entry.success { color: #48bb78; }
        .log-entry.error { color: #f56565; }
        .log-entry.info { color: #4299e1; }
        .instructions {
            background: #edf2f7; padding: 20px; border-radius: 8px; margin-bottom: 30px;
        }
        .instructions h3 { color: #2d3748; margin-bottom: 15px; }
        .instructions ul { list-style: none; padding: 0; }
        .instructions li {
            margin: 8px 0; padding-left: 20px; position: relative;
            color: #4a5568;
        }
        .instructions li:before {
            content: "‚Ä¢"; position: absolute; left: 0;
            color: #ff9a9e; font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Inventory Processing</h1>
        </div>
        <div class="main-content">
            <div class="instructions">
                <h3>üí° Instructions</h3>
                <ul>
                    <li>Select a folder</li>
                    <li>Excel files in the folder must be named starting with numbers 1-9</li>
                    <li>The system will automatically identify and match file types</li>
                    <li>Download result files after processing is complete</li>
                    <li>Large files are automatically split (when row limit is exceeded)</li>
                </ul>
            </div>
            <div class="upload-section">
                <h2>üìÅ Folder Upload</h2>
                <div style="text-align: center; margin-bottom: 20px;">
                    <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;" accept=".xlsx,.xls">
                    <button class="btn btn-primary" onclick="document.getElementById('folderInput').click()" style="font-size: 18px; padding: 20px 40px;">
                        üìÇ Select Folder Containing Excel Files
                    </button>
                    <div style="margin-top: 15px; color: #666; font-size: 14px;">
                        Please ensure Excel files in the folder are named starting with numbers 1-9 (e.g., 1Inventory.xlsx, 2StoreNames.xlsx, etc.)
                    </div>
                </div>
                
                <div id="fileMapping" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: #2d3748;">üìã File Recognition Results</h3>
                    <div class="file-mapping-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px;">
                        <div class="mapping-item" id="mapping-1" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">1Ô∏è‚É£ Meidede Inventory</div>
                                    <div id="file-1-name" style="font-size: 12px; color: #666; margin-top: 5px;">Not Found</div>
                                </div>
                                <div id="file-1-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">Missing</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-2" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">2Ô∏è‚É£ Store Names</div>
                                    <div id="file-2-name" style="font-size: 12px; color: #666; margin-top: 5px;">Not Found</div>
                                </div>
                                <div id="file-2-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">Missing</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-3" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">3Ô∏è‚É£ Meituan Product Catalog</div>
                                    <div id="file-3-name" style="font-size: 12px; color: #666; margin-top: 5px;">Not Found</div>
                                </div>
                                <div id="file-3-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">Missing</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-4" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">4Ô∏è‚É£ Store & Product Sales Info</div>
                                    <div id="file-4-name" style="font-size: 12px; color: #666; margin-top: 5px;">Not Found</div>
                                </div>
                                <div id="file-4-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">Missing</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-5" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">5Ô∏è‚É£ Eleme</div>
                                    <div id="file-5-name" style="font-size: 12px; color: #666; margin-top: 5px;">Not Found</div>
                                </div>
                                <div id="file-5-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">Missing</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-6" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">6Ô∏è‚É£ Eleme Product Catalog</div>
                                    <div id="file-6-name" style="font-size: 12px; color: #666; margin-top: 5px;">Not Found</div>
                                </div>
                                <div id="file-6-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">Missing</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-7" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">7Ô∏è‚É£ Douyin Pickup Voucher</div>
                                    <div id="file-7-name" style="font-size: 12px; color: #666; margin-top: 5px;">Not Found</div>
                                </div>
                                <div id="file-7-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">Missing</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-8" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">8Ô∏è‚É£ JD Takeout Template</div>
                                    <div id="file-8-name" style="font-size: 12px; color: #666; margin-top: 5px;">Not Found</div>
                                </div>
                                <div id="file-8-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">Missing</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-9" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">9Ô∏è‚É£ JD Takeout Product Catalog</div>
                                    <div id="file-9-name" style="font-size: 12px; color: #666; margin-top: 5px;">Not Found</div>
                                </div>
                                <div id="file-9-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">Missing</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="file-input-group" style="display: none;">
                    <div class="file-input-item">
                        <label>Meidede_Inventory.xlsx</label>
                        <input type="file" class="file-input" id="inventory" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('inventory').click()">üìä Select File</button>
                        <div class="file-name" id="inventory-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>Store_Names.xlsx</label>
                        <input type="file" class="file-input" id="stores" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('stores').click()">üè™ Select File</button>
                        <div class="file-name" id="stores-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>Meituan_Product_Catalog.xlsx</label>
                        <input type="file" class="file-input" id="mtwm-goods" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('mtwm-goods').click()">üõí Select File</button>
                        <div class="file-name" id="mtwm-goods-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>Store_Product_Sales_Info.xlsx</label>
                        <input type="file" class="file-input" id="dst" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('dst').click()">üìã Select File</button>
                        <div class="file-name" id="dst-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>Eleme.xlsx</label>
                        <input type="file" class="file-input" id="eleme" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('eleme').click()">üçú Select File</button>
                        <div class="file-name" id="eleme-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>Eleme_Product_Catalog.xlsx</label>
                        <input type="file" class="file-input" id="eleme-goods" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('eleme-goods').click()">üõçÔ∏è Select File</button>
                        <div class="file-name" id="eleme-goods-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>Douyin_Pickup_Voucher.xlsx</label>
                        <input type="file" class="file-input" id="douyin" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('douyin').click()">üéµ Select File</button>
                        <div class="file-name" id="douyin-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>JD_Takeout_Template.xlsx</label>
                        <input type="file" class="file-input" id="jd-template" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('jd-template').click()">üõí Select File</button>
                        <div class="file-name" id="jd-template-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>JD_Takeout_Product_Catalog.xlsx</label>
                        <input type="file" class="file-input" id="jd-goods" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('jd-goods').click()">üì¶ Select File</button>
                        <div class="file-name" id="jd-goods-name"></div>
                    </div>
                </div>
            </div>
            <div class="process-section">
                <button class="btn btn-primary" onclick="processFiles()" id="processBtn">üöÄ Start Processing</button>
                <button class="btn btn-success" onclick="downloadAllAsZip()" id="downloadAllBtn" style="display: none;">üì¶ Download All as ZIP</button>
            </div>
            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Preparing to process...</div>
            </div>
            <div class="results-section" id="resultsSection">
                <h3>üìã Processing Results</h3>
                <div class="download-list" id="downloadList"></div>
            </div>
            <div class="log-section" id="logSection">
                <h3>üìù Processing Log</h3>
                <div class="log-container" id="logContainer"></div>
            </div>
        </div>
    </div>
    <script>
        // Global variables
        let uploadedFiles = {};
        let processedFiles = {};
        let fileMapping = {
            '1': 'inventory',
            '2': 'stores',
            '3': 'mtwm-goods',
            '4': 'dst',
            '5': 'eleme',
            '6': 'eleme-goods',
            '7': 'douyin',
            '8': 'jd-template',
            '9': 'jd-goods'
        };
        let fileNames = {
            '1': 'Meidede Inventory',
            '2': 'Store Names',
            '3': 'Meituan Product Catalog', 
            '4': 'Store & Product Sales Info',
            '5': 'Eleme',
            '6': 'Eleme Product Catalog',
            '7': 'Douyin Pickup Voucher',
            '8': 'JD Takeout Template',
            '9': 'JD Takeout Product Catalog'
        };

        // Folder upload listener
        document.getElementById('folderInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            log(`üìÇ Selected folder containing ${files.length} files`, 'info');
            
            // Reset file mapping display
            resetFileMapping();
            
            // Process files
            files.forEach(file => {
                if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                    const firstChar = file.name.charAt(0);
                    if (fileMapping[firstChar]) {
                        uploadedFiles[fileMapping[firstChar]] = file;
                        updateFileMapping(firstChar, file.name);
                        log(`‚úÖ File recognized: ${file.name} ‚Üí ${fileNames[firstChar]}`, 'success');
                    } else {
                        log(`‚ö†Ô∏è Cannot recognize file: ${file.name} (filename does not start with 1-9)`, 'warning');
                    }
                }
            });
            
            // Show file mapping results
            document.getElementById('fileMapping').style.display = 'block';
            
            // Check if all required files have been uploaded
            const missingFiles = Object.keys(fileMapping).filter(num => !uploadedFiles[fileMapping[num]]);
            if (missingFiles.length === 0) {
                log('‚úÖ All required files found, ready to process', 'success');
            } else {
                log(`‚ö†Ô∏è Missing files: ${missingFiles.map(num => fileNames[num]).join(', ')}`, 'warning');
            }
        });

        // Reset file mapping display
        function resetFileMapping() {
            for (let i = 1; i <= 9; i++) {
                document.getElementById(`file-${i}-name`).textContent = 'Not Found';
                document.getElementById(`file-${i}-status`).textContent = 'Missing';
                document.getElementById(`file-${i}-status`).style.background = '#f56565';
                document.getElementById(`mapping-${i}`).style.borderColor = '#e2e8f0';
            }
        }

        // Update file mapping display
        function updateFileMapping(number, fileName) {
            document.getElementById(`file-${number}-name`).textContent = fileName;
            document.getElementById(`file-${number}-status`).textContent = 'Found';
            document.getElementById(`file-${number}-status`).style.background = '#48bb78';
            document.getElementById(`mapping-${number}`).style.borderColor = '#48bb78';
        }

        // Log function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logSection = document.getElementById('logSection');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            logSection.style.display = 'block';
        }

        // Update progress
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // Show progress bar
        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('processBtn').disabled = true;
        }

        // Hide progress bar
        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
        }

        // Read Excel file - improved version with better compatibility
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        
                        // Use more lenient read options for better compatibility
                        const workbook = XLSX.read(data, {
                            type: 'array',
                            cellDates: false,
                            cellNF: false,
                            cellText: false,
                            raw: false,
                            dateNF: 'yyyy-mm-dd',
                            sheetStubs: true,
                            bookDeps: false,
                            bookProps: false,
                            bookSheets: false,
                            bookVBA: false,
                            password: '',
                            WTF: false
                        });
                        
                        resolve(workbook);
                    } catch (error) {
                        log(`Error reading file ${file.name}: ${error.message}`, 'error');
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Create workbook
        function createWorkbook(data, sheetName = 'Sheet1') {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            return wb;
        }

        // Get sheet data - improved version, ensures all columns are read
        function getSheetData(workbook, sheetName = null) {
            const sheet = sheetName ? workbook.Sheets[sheetName] : workbook.Sheets[workbook.SheetNames[0]];
            
            // Get worksheet range
            let range = XLSX.utils.decode_range(sheet['!ref']);
            
            // Force extend range to ensure at least 10 columns are read
            range.e.c = Math.max(range.e.c, 10);
            
            // Reset range
            sheet['!ref'] = XLSX.utils.encode_range(range);
            
            // Use more reliable method to read data
            const data = [];
            for (let row = range.s.r; row <= range.e.r; row++) {
                const rowData = [];
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({r: row, c: col});
                    const cell = sheet[cellAddress];
                    rowData.push(cell ? cell.v : '');
                }
                data.push(rowData);
            }
            
            return data;
        }

        // Download file
        function downloadFile(workbook, filename) {
            const wbout = XLSX.write(workbook, {bookType: 'xlsx', type: 'array'});
            const blob = new Blob([wbout], {type: 'application/octet-stream'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Add download item to results list
        function addDownloadItem(filename, workbook) {
            const downloadList = document.getElementById('downloadList');
            const item = document.createElement('div');
            item.className = 'download-item';
            
            const wbout = XLSX.write(workbook, {bookType: 'xlsx', type: 'array'});
            const blob = new Blob([wbout], {type: 'application/octet-stream'});
            const size = (blob.size / 1024).toFixed(1) + ' KB';
            
            item.innerHTML = `
                <div class="file-info">
                    <div class="file-name">${filename}</div>
                    <div class="file-size">Size: ${size}</div>
                </div>
                <button class="download-btn" onclick="downloadFile(processedFiles['${filename}'], '${filename}')">Download</button>
            `;
            
            downloadList.appendChild(item);
            processedFiles[filename] = workbook;
        }

        // Main processing function - fully implemented following Python logic
        async function processFiles() {
            const missingFiles = Object.keys(fileMapping).filter(num => !uploadedFiles[fileMapping[num]]);
            if (missingFiles.length > 0) {
                const missingFileNames = missingFiles.map(num => fileNames[num]);
                alert(`Please upload all required files first!\nMissing files: ${missingFileNames.join(', ')}`);
                return;
            }

            showProgress();
            log('üöÄ Starting Excel file processing...', 'info');

            try {
                updateProgress(5, 'Reading Excel files...');
                const workbooks = {};
                for (const [id, file] of Object.entries(uploadedFiles)) {
                    log(`Reading file: ${file.name}`, 'info');
                    workbooks[id] = await readExcelFile(file);
                }

                updateProgress(10, 'Processing store data...');
                const storeData = await processStoreData(workbooks);

                updateProgress(15, 'Processing product data...');
                const goodsData = await processGoodsData(workbooks);

                updateProgress(20, 'Processing store & product sales info...');
                const dstData = await processDstData(workbooks, storeData, goodsData);

                updateProgress(30, 'Processing Meidede inventory data...');
                const inventoryData = await processInventoryData(workbooks, storeData);

                updateProgress(35, 'Marking column U...');
                const markedInventoryData = await markUColumn(workbooks, goodsData, inventoryData);

                updateProgress(40, 'Syncing inventory data...');
                const finalDstData = await syncInventoryData(workbooks, storeData, dstData, markedInventoryData);

                updateProgress(50, 'Processing Eleme data...');
                const elemeData = await processElemeData(workbooks, storeData, markedInventoryData);

                updateProgress(55, 'Checking Eleme file split...');
                await checkAndSplitElemeFile(elemeData);

                updateProgress(60, 'Processing Douyin pickup voucher data...');
                const douyinData = await processDouyinData(workbooks, storeData, markedInventoryData);

                updateProgress(65, 'Comparing Douyin voucher with Meidede inventory...');
                const finalInventoryData = await processDouyinComparison(workbooks, storeData, markedInventoryData);

                updateProgress(70, 'Processing JD takeout data...');
                const jdResult = await processJdData(workbooks, storeData, finalInventoryData);

                updateProgress(75, 'Checking JD takeout template file split...');
                await checkAndSplitJdTemplateFile(jdResult.jdTemplateData);

                updateProgress(85, 'Generating result files...');
                await generateResultFiles(workbooks, {
                    storeData,
                    goodsData,
                    dstData: finalDstData,
                    inventoryData: finalInventoryData,
                    elemeData,
                    douyinData,
                    jdResult
                });

                updateProgress(100, 'Processing complete!');
                log('‚úÖ All files processed successfully!', 'success');

                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('downloadAllBtn').style.display = 'inline-flex';
                hideProgress();

            } catch (error) {
                log(`‚ùå Error during processing: ${error.message}`, 'error');
                console.error('Processing error:', error);
                hideProgress();
            }
        }

        // 1. Read store IDs (corresponds to Python lines 31-38)
        async function processStoreData(workbooks) {
            log('Processing store data...', 'info');
            const storeTable = getSheetData(workbooks['stores']);
            
            const storeIds = [];
            // Start from row 2, read column C (3rd column)
            for (let i = 1; i < storeTable.length; i++) {
                const val = storeTable[i][2]; // Column C
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    storeIds.push(String(val).trim());
                }
            }
            
            log(`Found ${storeIds.length} store IDs`, 'success');
            return { storeIds, storeTable };
        }

        // 2. Read Meituan product catalog column B (from B3), sync columns E, K, A, T (corresponds to Python lines 40-61)
        async function processGoodsData(workbooks) {
            log('Processing product data...', 'info');
            const goodsData = getSheetData(workbooks['mtwm-goods']);
            const goodsInfo = [];
            
            // Start from row 3, adapt to actual file structure
            for (let i = 2; i < goodsData.length; i++) {
                const bVal = goodsData[i][1];  // Column B (barcode)
                const eVal = goodsData[i][4];  // Column E (may be empty)
                const oVal = goodsData[i][10]; // Column K (may be empty)
                const aVal = goodsData[i][0];  // Column A (sku_id)
                const tVal = goodsData[i][19]; // Column T (may be empty)
                
                // Check if column B has valid barcode data
                if (bVal !== null && bVal !== undefined && 
                    String(bVal).trim() !== '' && 
                    !String(bVal).includes('barcode') &&
                    String(bVal).trim().length >= 8) { // Ensure valid barcode length
                    
                    goodsInfo.push({
                        barcode: String(bVal).trim(),
                        e_col: eVal || '', // If column E is empty, use empty string
                        o_col: oVal || '', // If column K is empty, use empty string
                        a_col: aVal || '', // Column A data
                        t_col: tVal || ''  // If column T is empty, use empty string
                    });
                }
            }
            
            log(`Found ${goodsInfo.length} product entries`, 'success');
            return goodsInfo;
        }

        // 3. Process store & product sales info (corresponds to Python lines 63-82)
        async function processDstData(workbooks, storeData, goodsData) {
            log('Processing store & product sales info...', 'info');
            const dstData = getSheetData(workbooks['dst']);
            
            // Start pasting from D5, implement Cartesian product
            let rowIdx = 5; // Start from row 5 (index 4)
            
            for (const storeId of storeData.storeIds) {
                for (const info of goodsData) {
                    // Ensure row exists, extend if needed
                    while (dstData.length <= rowIdx - 1) {
                        dstData.push(new Array(20).fill('')); // Extend with enough columns
                    }
                    
                    dstData[rowIdx - 1][0] = storeId;           // Column A: store ID
                    dstData[rowIdx - 1][3] = info.barcode;        // Column D: barcode
                    dstData[rowIdx - 1][1] = info.e_col;          // Column B: Meituan catalog column E
                    dstData[rowIdx - 1][2] = info.o_col;          // Column C: Meituan catalog column K
                    dstData[rowIdx - 1][4] = info.a_col;          // Column E: Meituan catalog column A
                    // Column J no longer filled (commented out in Python)
                    
                    if (info.barcode) {  // If column D has content
                        dstData[rowIdx - 1][5] = 0;              // Column F: write 0
                    }
                    rowIdx++;
                }
            }
            
            log('Completed batch paste of store IDs and product barcodes', 'success');
            
            // Add price matching logic: match Meidede inventory column G prices to column K via column D barcodes
            await matchPricesFromKucun(workbooks, dstData);
            
            return dstData;
        }

        // Price matching function: match Meidede inventory column G prices to column K via column D barcodes
        async function matchPricesFromKucun(workbooks, dstData) {
            log('Starting price matching...', 'info');
            
            // 1. Build mapping from Meidede inventory column D barcodes to column G prices
            const inventoryData = getSheetData(workbooks['inventory']);
            const barcodeToPrice = {};
            
            for (let i = 1; i < inventoryData.length; i++) { // Start from row 2
                const barcode = inventoryData[i][3]; // Column D (barcode)
                const price = inventoryData[i][6];   // Column G (price)
                
                if (barcode !== null && barcode !== undefined && String(barcode).trim() !== '') {
                    barcodeToPrice[String(barcode).trim()] = price;
                }
            }
            
            log(`Built ${Object.keys(barcodeToPrice).length} barcode-to-price mappings from Meidede inventory`, 'info');
            
            // 2. Iterate column D barcodes in store & product sales info, match prices and fill column K
            let matchedCount = 0;
            for (let i = 4; i < dstData.length; i++) { // Start from row 5
                const dstBarcode = dstData[i][3]; // Column D (barcode)
                
                if (dstBarcode !== null && dstBarcode !== undefined && String(dstBarcode).trim() !== '') {
                    const barcodeKey = String(dstBarcode).trim();
                    const price = barcodeToPrice[barcodeKey];
                    
                    if (price !== null && price !== undefined) {
                        dstData[i][10] = price; // Column K (11th column): fill price
                        matchedCount++;
                    }
                }
            }
            
            log(`Price matching complete: successfully matched ${matchedCount} price records to column K`, 'success');
        }

        // 4. Process Meidede inventory (corresponds to Python lines 84-130)
        async function processInventoryData(workbooks, storeData) {
            log('Processing Meidede inventory data...', 'info');
            const rawInventoryData = getSheetData(workbooks['inventory']);
            const processedInventoryData = rawInventoryData.map(row => [...row]);
            
            // Build mapping from "Store Names" column B to columns A and D
            const bToA = {};
            const bToD = {};
            for (let i = 1; i < storeData.storeTable.length; i++) {
                const storeColA = storeData.storeTable[i][0];  // Column A
                const storeColB = storeData.storeTable[i][1];  // Column B
                const storeColD = storeData.storeTable[i][3];  // Column D
                const key = storeColB !== null ? String(storeColB).trim() : '';
                if (key) {
                    bToA[key] = storeColA;
                    bToD[key] = storeColD;
                }
            }
            
            // Set V2, W2 cell headers
            if (processedInventoryData.length > 1) {
                processedInventoryData[1][21] = 'Meituan Store'; // Column V
                processedInventoryData[1][22] = 'Eleme';          // Column W
            }
            
            // Write new names in columns V, W, column A content unchanged
            for (let i = 1; i < processedInventoryData.length; i++) {
                const cell = processedInventoryData[i][0]; // Column A
                const key = cell !== null ? String(cell).trim() : '';
                
                if (key && bToA[key]) {
                    processedInventoryData[i][21] = bToA[key]; // Column V
                }
                if (key && bToD[key]) {
                    processedInventoryData[i][22] = bToD[key]; // Column W
                }
            }
            
            log('Generated new table and completed column A replacement', 'success');
            return processedInventoryData;
        }

        // 5. Compare Meidede inventory column D with product catalog column B, mark in column U (corresponds to Python lines 132-158)
        async function markUColumn(workbooks, goodsData, inventoryData) {
            log('Marking column U...', 'info');
            
            // Get all product catalog barcodes
            const goodsBarcodesSet = new Set();
            for (const info of goodsData) {
                goodsBarcodesSet.add(info.barcode);
            }
            
            // Set column U header
            if (inventoryData.length > 1) {
                inventoryData[1][20] = 'Meituan/Eleme'; // Column U
            }
            
            // Iterate column D, starting from row 2
            for (let i = 1; i < inventoryData.length; i++) {
                const dVal = inventoryData[i][3]; // Column D
                if (dVal !== null && goodsBarcodesSet.has(String(dVal).trim())) {
                    inventoryData[i][20] = 'Yes'; // Column U
                }
            }
            
            log('Column U marking complete', 'success');
            return inventoryData;
        }


        // 6. Inventory sync logic (corresponds to Python lines 160-240)
        async function syncInventoryData(workbooks, storeData, dstData, inventoryData) {
            log('Syncing inventory data...', 'info');
            
            // 1. Read "Store Names" column A->C (store name->store ID) mapping
            const storeNameToId = {};
            for (let i = 1; i < storeData.storeTable.length; i++) {
                const name = storeData.storeTable[i][0];  // Column A
                const id = storeData.storeTable[i][2];    // Column C
                if (name !== null && String(name).trim() !== '' && id !== null) {
                    storeNameToId[String(name).trim()] = String(id).trim();
                }
            }
            
            // 2. Read all rows from "Store & Product Sales Info", build (store ID, barcode) to row mapping
            const dstIdBarcodeToRow = {};
            for (let i = 4; i < dstData.length; i++) { // Start from row 5
                const dstId = dstData[i][0];    // Column A
                const dstBarcode = dstData[i][3]; // Column D
                if (dstId !== null && dstBarcode !== null) {
                    const key = `${String(dstId).trim()}_${String(dstBarcode).trim()}`;
                    dstIdBarcodeToRow[key] = i; // Store row index
                }
            }
            
            // 3. Iterate Meidede inventory, rows where column U is "Yes"
            let syncCount = 0;
            for (let i = 1; i < inventoryData.length; i++) {
                const uVal = inventoryData[i][20]; // Column U
                if (uVal === 'Yes') {
                    const inventoryStoreName = inventoryData[i][21]; // Column V (store name)
                    const inventoryBarcode = inventoryData[i][3];  // Column D (barcode)
                    const inventoryQty = inventoryData[i][7];    // Column H (inventory quantity)
                    
                    if (inventoryStoreName === null || inventoryBarcode === null) {
                        continue;
                    }
                    
                    const storeId = storeNameToId[String(inventoryStoreName).trim()];
                    if (!storeId) {
                        continue;
                    }
                    
                    // Find corresponding row in "Store & Product Sales Info"
                    const key = `${storeId}_${String(inventoryBarcode).trim()}`;
                    const dstRowIdx = dstIdBarcodeToRow[key];
                    if (dstRowIdx !== undefined) {
                        dstData[dstRowIdx][11] = inventoryQty; // Column L (12th column)
                        syncCount++;
                    }
                }
            }
            
            log(`Inventory sync to Store & Product Sales Info column L complete, synced ${syncCount} records`, 'success');
            
            // 4. Iterate "Store & Product Sales Info", fill "0" in column L where column D has content but column L is empty
            let zeroFillCount = 0;
            for (let i = 4; i < dstData.length; i++) { // Start from row 5
                const dVal = dstData[i][3];  // Column D
                const lVal = dstData[i][11]; // Column L
                if (dVal !== null && String(dVal).trim() !== '' && 
                    (lVal === null || lVal === undefined || String(lVal).trim() === '')) {
                    dstData[i][11] = 0; // Column L: write 0
                    zeroFillCount++;
                }
            }
            log(`Column L empty fill complete, filled ${zeroFillCount} records with zero`, 'success');
            
            // 5. Change all negative values in "Store & Product Sales Info" column L to 0
            let negativeCount = 0;
            for (let i = 4; i < dstData.length; i++) { // Start from row 5
                const lVal = dstData[i][11]; // Column L
                try {
                    if (lVal !== null && lVal !== undefined && String(lVal).trim() !== '' && parseFloat(lVal) < 0) {
                        dstData[i][11] = 0;
                        negativeCount++;
                    }
                } catch (e) {
                    // If not a number, skip
                }
            }
            log(`Column L negative values zeroed, zeroed ${negativeCount} records`, 'success');
            
            // 6. If column L inventory is 0, fill column F with 1
            let fColumnFillCount = 0;
            for (let i = 4; i < dstData.length; i++) { // Start from row 5
                const lVal = dstData[i][11]; // Column L (inventory quantity)
                try {
                    if (lVal !== null && lVal !== undefined && String(lVal).trim() !== '' && parseFloat(lVal) === 0) {
                        dstData[i][5] = 1; // Column F: write 1
                        fColumnFillCount++;
                    }
                } catch (e) {
                    // If not a number, skip
                }
            }
            log(`Column F fill when column L inventory is 0 complete, processed ${fColumnFillCount} records`, 'success');
            
            // 7. If column A has content but column C is empty, fill "pcs" in column C
            let unitFillCount = 0;
            for (let i = 4; i < dstData.length; i++) { // Start from row 5
                const aVal = dstData[i][0]; // Column A (store ID)
                const cVal = dstData[i][2]; // Column C
                
                if (aVal !== null && String(aVal).trim() !== '' && 
                    (cVal === null || cVal === undefined || String(cVal).trim() === '')) {
                    dstData[i][2] = 'pcs'; // Column C: fill "pcs"
                    unitFillCount++;
                }
            }
            log(`Column C empty fill complete, filled ${unitFillCount} records`, 'success');
            
            return dstData;
        }

        // 7. Eleme data processing (corresponds to Python lines 242-378)
        async function processElemeData(workbooks, storeData, inventoryData) {
            log('Processing Eleme data...', 'info');
            
            // Read Eleme store IDs (column E, 5th column)
            const elemeIds = [];
            for (let i = 1; i < storeData.storeTable.length; i++) {
                const val = storeData.storeTable[i][4]; // Column E
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    elemeIds.push(String(val).trim());
                }
            }
            
            // Read Eleme product catalog data
            const elemeGoodsData = getSheetData(workbooks['eleme-goods']);
            const barcodes = [];
            const eColVals = [];
            
            // Read barcodes from Eleme product catalog (column A, from A2)
            for (let i = 1; i < elemeGoodsData.length; i++) {
                const bVal = elemeGoodsData[i][0]; // Column A
                barcodes.push(bVal !== null ? String(bVal).trim() : '');
            }
            
            // Read column B content from Eleme product catalog (from B2)
            for (let i = 1; i < elemeGoodsData.length; i++) {
                const eVal = elemeGoodsData[i][1]; // Column B
                eColVals.push(eVal !== null ? String(eVal).trim() : '');
            }
            
            // Get Eleme table data and extend
            const elemeData = getSheetData(workbooks['eleme']);
            
            // Start batch writing from row 3
            let rowIdx = 3; // Start from row 3 (index 2)
            
            for (const elemeId of elemeIds) {
                for (let i = 0; i < barcodes.length; i++) {
                    // Ensure row exists
                    while (elemeData.length <= rowIdx - 1) {
                        elemeData.push(new Array(15).fill('')); // Extend with enough columns
                    }
                    
                    elemeData[rowIdx - 1][0] = elemeId;           // Column A: store ID
                    elemeData[rowIdx - 1][2] = barcodes[i];       // Column C: barcode
                    elemeData[rowIdx - 1][3] = eColVals[i];       // Column D: Eleme catalog column B content
                    rowIdx++;
                }
            }
            
            log(`Batch copied product catalog to Eleme table, generated ${rowIdx - 3} rows of data`, 'success');
            
            // Sync Meidede inventory to Eleme column H, write "Listed" in column J for rows with column A content
            await syncElemeInventory(elemeData, storeData, inventoryData);
            
            // Based on Eleme column A store ID, get column D content from Store Names and fill Eleme column B
            await fillElemeStoreNames(elemeData, storeData);
            
            // When column H inventory is "0", fill "Delisted" in column J
            await markElemeOffline(elemeData);
            
            return elemeData;
        }

        // Sync Meidede inventory to Eleme column H
        async function syncElemeInventory(elemeData, storeData, inventoryData) {
            log('Syncing inventory to Eleme table...', 'info');
            
            // 1. Build mapping using "Store Names.xlsx" column D (Eleme store name) and column E (Eleme ID)
            const elemeNameToId = {};
            for (let i = 1; i < storeData.storeTable.length; i++) {
                const elemeName = storeData.storeTable[i][3]; // Column D (Eleme store name)
                const elemeId = storeData.storeTable[i][4];   // Column E (Eleme store ID)
                if (elemeName !== null && String(elemeName).trim() !== '' && elemeId !== null) {
                    elemeNameToId[String(elemeName).trim()] = String(elemeId).trim();
                }
            }
            
            // 2. In "Eleme.xlsx", build (store ID, barcode) to row mapping
            const elemeIdBarcodeToRow = {};
            for (let i = 2; i < elemeData.length; i++) { // Start from row 3
                const elemeId = elemeData[i][0];    // Column A (Eleme store ID)
                const elemeBarcode = elemeData[i][2]; // Column C (barcode)
                if (elemeId !== null && elemeBarcode !== null) {
                    const key = `${String(elemeId).trim()}_${String(elemeBarcode).trim()}`;
                    elemeIdBarcodeToRow[key] = i; // Store row index
                }
            }
            
            // 3. Iterate all rows, write inventory to "Eleme.xlsx" column H (corresponds to Python lines 312-325)
            let syncCount = 0;
            for (let i = 1; i < inventoryData.length; i++) {
                const elemeName = inventoryData[i][22]; // Column W (23rd column, Eleme store name)
                const barcode = inventoryData[i][3];    // Column D (4th column, barcode)
                const inventoryQty = inventoryData[i][7]; // Column H (8th column, inventory quantity)
                
                if (elemeName === null || barcode === null) {
                    continue;
                }
                
                const elemeId = elemeNameToId[String(elemeName).trim()];
                if (!elemeId) {
                    continue;
                }
                
                const key = `${elemeId}_${String(barcode).trim()}`;
                const elemeRowIdx = elemeIdBarcodeToRow[key];
                if (elemeRowIdx !== undefined) {
                    elemeData[elemeRowIdx][7] = inventoryQty; // Column H (8th column)
                    syncCount++;
                }
            }
            
            log(`Inventory sync to Eleme column H complete, synced ${syncCount} records`, 'success');
            
            // 4. For rows with column A content, write "Listed" in column J
            for (let i = 2; i < elemeData.length; i++) { // Start from row 3
                const aVal = elemeData[i][0]; // Column A
                if (aVal !== null && String(aVal).trim() !== '') {
                    elemeData[i][9] = 'Listed'; // Column J (10th column)
                }
            }
            
            // 5. Only fill 0 in column H for rows with column A content
            for (let i = 2; i < elemeData.length; i++) { // Start from row 3
                const aVal = elemeData[i][0]; // Column A
                const hVal = elemeData[i][7]; // Column H
                if (aVal !== null && String(aVal).trim() !== '') {
                    if (hVal === null || hVal === undefined || String(hVal).trim() === '') {
                        elemeData[i][7] = 0; // Column H: write 0
                    }
                }
            }
            
            log('Eleme table column H empty fill complete (only for rows with column A content)', 'success');
        }

        // Fill Eleme column B store name based on column A store ID
        async function fillElemeStoreNames(elemeData, storeData) {
            log('Filling Eleme store names...', 'info');
            
            // 1. Build mapping from "Store Names.xlsx" column E (Eleme store ID) to column D (Eleme store name)
            const elemeIdToName = {};
            for (let i = 1; i < storeData.storeTable.length; i++) {
                const elemeId = storeData.storeTable[i][4];    // Column E (Eleme store ID)
                const elemeName = storeData.storeTable[i][3];  // Column D (Eleme store name)
                if (elemeId !== null && String(elemeId).trim() !== '' && elemeName !== null) {
                    elemeIdToName[String(elemeId).trim()] = String(elemeName).trim();
                }
            }
            
            // 2. Iterate "Eleme.xlsx", fill column B based on column A store ID
            for (let i = 2; i < elemeData.length; i++) { // Start from row 3
                const elemeId = elemeData[i][0]; // Column A (Eleme store ID)
                if (elemeId !== null && String(elemeId).trim() in elemeIdToName) {
                    const elemeName = elemeIdToName[String(elemeId).trim()];
                    elemeData[i][1] = elemeName; // Column B: fill Eleme store name
                }
            }
            
            log('Eleme column A store ID to column B store name fill complete', 'success');
        }

        // When column H inventory is "0", fill "Delisted" in column J
        async function markElemeOffline(elemeData) {
            log('Marking Eleme delisted products...', 'info');
            
            for (let i = 2; i < elemeData.length; i++) { // Start from row 3
                const hVal = elemeData[i][7]; // Column H (inventory quantity)
                if (hVal !== null && String(hVal).trim() === '0') {
                    elemeData[i][9] = 'Delisted'; // Column J: fill "Delisted"
                }
            }
            
            log('Eleme column H inventory 0 products marked as delisted in column J', 'success');
        }

        // 8. Douyin pickup voucher processing (corresponds to Python lines 380-559)
        async function processDouyinData(workbooks, storeData, inventoryData) {
            log('Processing Douyin pickup voucher data...', 'info');
            
            // Copy Douyin pickup voucher data
            const douyinData = getSheetData(workbooks['douyin']);
            const processedDouyinData = douyinData.map(row => [...row]);
            
            // Build mapping from "Store Names.xlsx" column F (Douyin ID) to column B (Meidede store name)
            const douyinIdToStoreName = {};
            for (let i = 1; i < storeData.storeTable.length; i++) {
                const storeName = storeData.storeTable[i][1]; // Column B (Meidede store name)
                const douyinId = storeData.storeTable[i][5];     // Column F (Douyin ID)
                if (douyinId !== null && String(douyinId).trim() !== '' && storeName !== null) {
                    douyinIdToStoreName[String(douyinId).trim()] = String(storeName).trim();
                }
            }
            
            // Build mapping from "Meidede Inventory" (warehouse name, product barcode) to inventory quantity (corresponds to Python lines 399-408)
            // Note: Python version uses the original inventory file, not the processed file
            const originalKucunData = getSheetData(workbooks['inventory']);
            const inventoryMap = {};
            for (let i = 1; i < originalKucunData.length; i++) {
                const warehouseName = originalKucunData[i][0];  // Column A (warehouse name)
                const barcode = originalKucunData[i][3];         // Column D (product barcode)
                const stockCount = originalKucunData[i][7];      // Column H (total inventory)
                if (warehouseName !== null && barcode !== null) {
                    const key = `${String(warehouseName).trim()}_${String(barcode).trim()}`;
                    inventoryMap[key] = stockCount !== null ? stockCount : 0;
                }
            }
            
            // Process Douyin pickup voucher data
            let processedCount = 0;
            for (let i = 1; i < processedDouyinData.length; i++) { // Assume data starts from row 2
                const poiId = processedDouyinData[i][5];      // Column F (POIID)
                const merchantCode = processedDouyinData[i][4]; // Column E (merchant code)
                const douyinStock = processedDouyinData[i][7];  // Column H (available inventory at export)
                
                if (poiId === null || merchantCode === null) {
                    continue;
                }
                
                // Find Meidede store name by POIID
                const storeName = douyinIdToStoreName[String(poiId).trim()];
                if (!storeName) {
                    continue;
                }
                
                // Find inventory quantity by Meidede store name and merchant code
                const key = `${storeName}_${String(merchantCode).trim()}`;
                const inventoryStock = inventoryMap[key] || 0;
                
                // Calculate inventory difference
                let inventoryStockNum = inventoryStock === null ? 0 : parseFloat(inventoryStock);
                let douyinStockNum = douyinStock === null ? 0 : parseFloat(douyinStock);
                
                try {
                    const difference = inventoryStockNum - douyinStockNum;
                    
                    // Fill columns I and J based on difference
                    if (difference > 0) {
                        processedDouyinData[i][8] = 'Add';  // Column I
                        processedDouyinData[i][9] = difference;  // Column J (inventory change quantity)
                        processedCount++;
                    } else if (difference < 0) {
                        processedDouyinData[i][8] = 'Reduce';  // Column I
                        processedDouyinData[i][9] = Math.abs(difference);  // Column J (absolute value)
                        processedCount++;
                    }
                    // If difference == 0, don't fill anything
                    
                } catch (e) {
                    // If number conversion fails, skip this row
                    continue;
                }
            }
            
            log(`Douyin pickup voucher processing complete, processed ${processedCount} inventory difference records`, 'success');
            return processedDouyinData;
        }

        // 9. Douyin pickup voucher vs Meidede inventory comparison processing (corresponds to Python lines 455-559)
        async function processDouyinComparison(workbooks, storeData, inventoryData) {
            log('Processing Douyin voucher vs Meidede inventory comparison...', 'info');
            
            // 1. Fill "Douyin" in X2 cell and "Douyin Store" in Y2 cell of "Meidede Inventory_Processed"
            if (inventoryData.length > 1) {
                inventoryData[1][23] = 'Douyin';       // Column X (24th column)
                inventoryData[1][24] = 'Douyin Store'; // Column Y (25th column)
            }
            
            // 2. Build mapping from "Store Names" column F (Douyin ID) to column B (Meidede store name)
            const douyinIdToStoreName = {};
            for (let i = 1; i < storeData.storeTable.length; i++) {
                const storeName = storeData.storeTable[i][1]; // Column B (Meidede store name)
                const douyinId = storeData.storeTable[i][5];     // Column F (Douyin ID)
                if (douyinId !== null && String(douyinId).trim() !== '' && storeName !== null) {
                    douyinIdToStoreName[String(douyinId).trim()] = String(storeName).trim();
                }
            }
            
            // 3. Build mapping from "Store Names" column B (Meidede store name) to column G
            const storeNameToGCol = {};
            for (let i = 1; i < storeData.storeTable.length; i++) {
                const storeName = storeData.storeTable[i][1]; // Column B (Meidede store name)
                const gColVal = storeData.storeTable[i][6];     // Column G
                if (storeName !== null && String(storeName).trim() !== '') {
                    storeNameToGCol[String(storeName).trim()] = gColVal;
                }
            }
            
            // 4. Read "Douyin Pickup Voucher" data
            const douyinData = getSheetData(workbooks['douyin']);
            
            // 5. Build set of (warehouse name, product barcode) from "Meidede Inventory" for fast lookup (corresponds to Python lines 509-516)
            // Note: Python version uses the original inventory file, not the processed file
            const originalKucunData = getSheetData(workbooks['inventory']);
            const inventoryBarcodeSet = new Set();
            for (let i = 1; i < originalKucunData.length; i++) {
                const warehouseName = originalKucunData[i][0];  // Column A (warehouse name)
                const barcode = originalKucunData[i][3];         // Column D (product barcode)
                if (warehouseName !== null && barcode !== null) {
                    const key = `${String(warehouseName).trim()}_${String(barcode).trim()}`;
                    inventoryBarcodeSet.add(key);
                }
            }
            
            // 6. Process Douyin pickup voucher data, compare with Meidede inventory
            let matchCount = 0;
            for (let i = 1; i < douyinData.length; i++) { // Assume data starts from row 2
                const poiId = douyinData[i][5];      // Column F (POIID)
                const merchantCode = douyinData[i][4]; // Column E (merchant code)
                
                if (poiId === null || merchantCode === null) {
                    continue;
                }
                
                // Find Meidede store name by POIID
                const storeName = douyinIdToStoreName[String(poiId).trim()];
                if (!storeName) {
                    continue;
                }
                
                // Check if duplicate product barcode exists
                const key = `${storeName}_${String(merchantCode).trim()}`;
                if (inventoryBarcodeSet.has(key)) {
                    matchCount++;
                    
                    // Found duplicate, mark in "Meidede Inventory_Processed"
                    for (let j = 1; j < inventoryData.length; j++) {
                        const inventoryWarehouse = inventoryData[j][0]; // Column A (warehouse name)
                        const inventoryBarcode = inventoryData[j][3];    // Column D (product barcode)
                        
                        if (inventoryWarehouse !== null && inventoryBarcode !== null &&
                            String(inventoryWarehouse).trim() === storeName &&
                            String(inventoryBarcode).trim() === String(merchantCode).trim()) {
                            
                            // Mark column X as "Yes"
                            inventoryData[j][23] = 'Yes'; // Column X
                            
                            // Mark column Y with Store Names column G content
                            const gColContent = storeNameToGCol[storeName] || '';
                            inventoryData[j][24] = gColContent; // Column Y
                            break;
                        }
                    }
                }
            }
            
            log(`Douyin voucher vs Meidede inventory comparison complete, marked ${matchCount} duplicate products`, 'success');
            return inventoryData;
        }

        // 9. JD takeout processing (corresponds to Python lines 640-911)
        async function processJdData(workbooks, storeData, inventoryData) {
            log('Processing JD takeout data...', 'info');
            
            // Mark JD takeout products
            const markedInventoryData = await markJdGoods(workbooks, inventoryData);
            
            // Process JD takeout template data
            const jdTemplateData = await processJdTemplate(workbooks, storeData, markedInventoryData);
            
            return { markedInventoryData, jdTemplateData };
        }

        // Mark JD takeout in Meidede Inventory_Processed
        async function markJdGoods(workbooks, inventoryData) {
            log('Marking JD takeout products...', 'info');
            
            // Set Z2 cell header (red background black text style - corresponds to Python lines 653-655)
            // Note: JavaScript version cannot directly set Excel styles, but data logic is identical
            if (inventoryData.length > 1) {
                inventoryData[1][25] = 'JD Takeout'; // Column Z (26th column)
            }
            
            // Get all barcodes from JD takeout product catalog column F
            const jdGoodsData = getSheetData(workbooks['jd-goods']);
            const jdBarcodesSet = new Set();
            for (let i = 1; i < jdGoodsData.length; i++) {
                const val = jdGoodsData[i][5]; // Column F is 6th column (index 5)
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    jdBarcodesSet.add(String(val).trim());
                }
            }
            
            log(`Read ${jdBarcodesSet.size} barcodes from JD takeout product catalog column F`, 'info');
            
            // Compare Meidede Inventory_Processed column D with JD takeout product catalog column F
            let matchCount = 0;
            for (let i = 1; i < inventoryData.length; i++) {
                const dVal = inventoryData[i][3]; // Column D (product barcode)
                const zCell = inventoryData[i][25]; // Column Z (26th column)
                
                if (dVal !== null && jdBarcodesSet.has(String(dVal).trim())) {
                    inventoryData[i][25] = 'Yes'; // Column Z: mark "Yes"
                    matchCount++;
                }
            }
            
            log(`JD takeout marking complete: marked ${matchCount} matching products in column Z`, 'success');
            return inventoryData;
        }

        // Process JD takeout template data
        async function processJdTemplate(workbooks, storeData, inventoryData) {
            log('Processing JD takeout template data...', 'info');
            
            // Read JD store IDs from Store Names column I
            const jdStoreIds = [];
            for (let i = 1; i < storeData.storeTable.length; i++) {
                const val = storeData.storeTable[i][8]; // Column I is 9th column (index 8)
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    jdStoreIds.push(String(val).trim());
                }
            }
            
            log(`Read ${jdStoreIds.length} JD store IDs from Store Names column I`, 'info');
            
            // Read JD takeout product catalog column F data (from row 2)
            const jdGoodsData = getSheetData(workbooks['jd-goods']);
            const jdSkuData = [];
            for (let i = 1; i < jdGoodsData.length; i++) {
                const val = jdGoodsData[i][5]; // Column F is 6th column (index 5)
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    jdSkuData.push(String(val).trim());
                }
            }
            
            log(`Read ${jdSkuData.length} valid merchant SKU records from JD takeout product catalog column F`, 'info');
            
            // Get JD takeout template data and extend
            const jdTemplateData = getSheetData(workbooks['jd-template']);
            
            // Implement Cartesian product: each store ID maps to all merchant SKUs
            let rowIdx = 2; // Start from row 2 (index 1)
            const totalRows = jdStoreIds.length * jdSkuData.length;
            log(`Generating ${totalRows} rows of data (${jdStoreIds.length} stores √ó ${jdSkuData.length} SKUs)`, 'info');
            
            for (const storeId of jdStoreIds) {
                for (const skuValue of jdSkuData) {
                    // Ensure row exists
                    while (jdTemplateData.length <= rowIdx - 1) {
                        jdTemplateData.push(new Array(10).fill('')); // Extend with enough columns
                    }
                    
                    // Column A: store ID
                    jdTemplateData[rowIdx - 1][0] = storeId;
                    // Column C: merchant SKU
                    jdTemplateData[rowIdx - 1][2] = skuValue;
                    rowIdx++;
                }
            }
            
            log(`JD takeout template data generation complete: ${totalRows} rows`, 'success');
            
            // Sync Meidede inventory to JD takeout template column E
            await syncJdInventory(workbooks, jdTemplateData, storeData, inventoryData);
            
            return jdTemplateData;
        }

        // Sync Meidede inventory to JD takeout template column E
        async function syncJdInventory(workbooks, jdTemplateData, storeData, inventoryData) {
            log('Syncing inventory data to JD takeout template...', 'info');
            
            // 1. Build mapping from "Store Names" column B (Meidede store name) to column I (JD store ID)
            const storeNameToJdId = {};
            for (let i = 1; i < storeData.storeTable.length; i++) {
                const storeName = storeData.storeTable[i][1]; // Column B (Meidede store name)
                const jdId = storeData.storeTable[i][8];        // Column I (JD store ID)
                if (storeName !== null && jdId !== null && 
                    String(storeName).trim() !== '' && String(jdId).trim() !== '') {
                    storeNameToJdId[String(storeName).trim()] = String(jdId).trim();
                }
            }
            
            log(`Built ${Object.keys(storeNameToJdId).length} store name to JD store ID mappings`, 'info');
            
            // 2. Build mapping from "Meidede Inventory" (warehouse name, product barcode) to inventory quantity (corresponds to Python lines 749-758)
            // Note: Python version uses the original inventory file, not the processed file
            const originalKucunData = getSheetData(workbooks['inventory']);
            const inventoryQuantityMap = {};
            for (let i = 1; i < originalKucunData.length; i++) {
                const warehouseName = originalKucunData[i][0];  // Column A (warehouse name)
                const barcode = originalKucunData[i][3];         // Column D (product barcode)
                const stockCount = originalKucunData[i][7];      // Column H (total inventory)
                if (warehouseName !== null && barcode !== null) {
                    const key = `${String(warehouseName).trim()}_${String(barcode).trim()}`;
                    inventoryQuantityMap[key] = stockCount !== null ? stockCount : 0;
                }
            }
            
            log(`Built ${Object.keys(inventoryQuantityMap).length} inventory data mappings`, 'info');
            
            // 3. Iterate JD takeout template, match and sync inventory data
            let matchedCount = 0;
            for (let i = 1; i < jdTemplateData.length; i++) { // Start from row 2
                const jdStoreId = jdTemplateData[i][0]; // Column A (JD store ID)
                const jdSku = jdTemplateData[i][2];     // Column C (merchant SKU)
                
                if (jdStoreId === null || jdSku === null) {
                    continue;
                }
                
                // Find Meidede store name by JD store ID
                let storeNameFound = null;
                for (const [name, id] of Object.entries(storeNameToJdId)) {
                    if (String(id).trim() === String(jdStoreId).trim()) {
                        storeNameFound = name;
                        break;
                    }
                }
                
                if (!storeNameFound) {
                    continue;
                }
                
                // Find inventory by Meidede store name and SKU
                const key = `${storeNameFound}_${String(jdSku).trim()}`;
                const inventory = inventoryQuantityMap[key];
                
                if (inventory !== undefined) {
                    // Fill column E (stock on hand)
                    jdTemplateData[i][4] = inventory; // Column E is 5th column (index 4)
                    matchedCount++;
                }
            }
            
            log(`Inventory data sync complete: matched ${matchedCount} inventory records`, 'success');
            
            // 4. Fill "0" for rows with no inventory data
            let zeroFillCount = 0;
            for (let i = 1; i < jdTemplateData.length; i++) { // Start from row 2
                const eVal = jdTemplateData[i][4]; // Column E (stock on hand)
                if (eVal === null || eVal === undefined || String(eVal).trim() === '') {
                    jdTemplateData[i][4] = 0; // Column E: fill 0
                    zeroFillCount++;
                }
            }
            log(`Filled 0 for ${zeroFillCount} rows with no inventory data`, 'success');
            
            // 5. Fill sales status in column D based on column E inventory value
            let availableCount = 0;
            let unavailableCount = 0;
            for (let i = 1; i < jdTemplateData.length; i++) { // Start from row 2
                const eVal = jdTemplateData[i][4]; // Column E (stock on hand)
                const dCell = jdTemplateData[i][3]; // Column D (sales status)
                
                try {
                    // Try to convert to number for comparison
                    if (eVal !== null && eVal !== undefined && String(eVal).trim() !== '') {
                        const stockValue = parseFloat(String(eVal).trim());
                        if (stockValue > 0) {
                            jdTemplateData[i][3] = 'Available';
                            availableCount++;
                        } else {
                            jdTemplateData[i][3] = 'Unavailable';
                            unavailableCount++;
                        }
                    } else {
                        jdTemplateData[i][3] = 'Unavailable';
                        unavailableCount++;
                    }
                } catch (e) {
                    // If cannot convert to number, default to Unavailable
                    jdTemplateData[i][3] = 'Unavailable';
                    unavailableCount++;
                }
            }
            
            log(`Sales status set: ${availableCount} rows set to 'Available', ${unavailableCount} rows set to 'Unavailable'`, 'success');
        }


        // Check and split Eleme file
        async function checkAndSplitElemeFile(elemeData) {
            const totalRows = elemeData.length;
            log(`Eleme table total rows: ${totalRows}`, 'info');
            
            if (totalRows > 60000) {
                log('Eleme table exceeds 60000 rows, splitting...', 'info');
                
                // Create second table (rows 60001 and after)
                const eleme2Data = [];
                
                // Copy first two header rows to new table
                if (totalRows >= 2) {
                    eleme2Data.push([...elemeData[0]]);
                    eleme2Data.push([...elemeData[1]]);
                }
                
                // Move rows 60001 and after to new table
                for (let i = 60001; i <= totalRows; i++) {
                    if (elemeData[i - 1]) {
                        eleme2Data.push([...elemeData[i - 1]]);
                    }
                }
                
                // Remove rows 60001 and after from original table
                elemeData.splice(60000);
                
                // Add second file to download list
                const eleme2Workbook = createWorkbook(eleme2Data, 'Eleme Data 2');
                addDownloadItem('Eleme_Processed_2.xlsx', eleme2Workbook);
                
                log(`Successfully split Eleme table: original keeps first 60000 rows, second table contains remaining ${totalRows - 60000} rows`, 'success');
            } else {
                log('Eleme table does not exceed 60000 rows, no split needed', 'info');
            }
        }

        // Check and split JD takeout template file
        async function checkAndSplitJdTemplateFile(jdTemplateData) {
            const totalRows = jdTemplateData.length;
            log(`JD takeout template total rows: ${totalRows}`, 'info');
            
            if (totalRows > 100000) {
                log('JD takeout template exceeds 100000 rows, splitting...', 'info');
                
                // Create second table (rows 100001 and after)
                const jdTemplate2Data = [];
                
                // Copy first header row to new table
                if (totalRows >= 1) {
                    jdTemplate2Data.push([...jdTemplateData[0]]);
                }
                
                // Move rows 100001 and after to new table
                for (let i = 100001; i <= totalRows; i++) {
                    if (jdTemplateData[i - 1]) {
                        jdTemplate2Data.push([...jdTemplateData[i - 1]]);
                    }
                }
                
                // Remove rows 100001 and after from original table
                jdTemplateData.splice(100000);
                
                // Add second file to download list
                const jdTemplate2Workbook = createWorkbook(jdTemplate2Data, 'JD Takeout Template 2');
                addDownloadItem('JD_Takeout_Template_Processed_2.xlsx', jdTemplate2Workbook);
                
                log(`Successfully split JD takeout template: original keeps first 100000 rows, second table contains remaining ${totalRows - 100000} rows`, 'success');
            } else {
                log('JD takeout template does not exceed 100000 rows, no split needed', 'info');
            }
        }

        // Generate result files - full version, generates all files per Python logic
        async function generateResultFiles(workbooks, processedData) {
            log('Generating result files...', 'info');
            
            // 1. Store_Product_Sales_Info_Processed.xlsx
            if (processedData.dstData) {
                const dstWorkbook = createWorkbook(processedData.dstData, 'Store Product Info');
                addDownloadItem('Store_Product_Sales_Info_Processed.xlsx', dstWorkbook);
                log('Generated Store_Product_Sales_Info_Processed.xlsx', 'success');
            }
            
            // 2. Meidede_Inventory_Processed.xlsx
            if (processedData.inventoryData) {
                const inventoryWorkbook = createWorkbook(processedData.inventoryData, 'Meidede Inventory');
                addDownloadItem('Meidede_Inventory_Processed.xlsx', inventoryWorkbook);
                log('Generated Meidede_Inventory_Processed.xlsx', 'success');
            }
            
            // 3. Eleme_Processed.xlsx
            if (processedData.elemeData) {
                const elemeWorkbook = createWorkbook(processedData.elemeData, 'Eleme Data');
                addDownloadItem('Eleme_Processed.xlsx', elemeWorkbook);
                log('Generated Eleme_Processed.xlsx', 'success');
            }
            
            // 4. Douyin_Pickup_Voucher_Processed.xlsx
            if (processedData.douyinData) {
                const douyinWorkbook = createWorkbook(processedData.douyinData, 'Douyin Pickup Voucher');
                addDownloadItem('Douyin_Pickup_Voucher_Processed.xlsx', douyinWorkbook);
                log('Generated Douyin_Pickup_Voucher_Processed.xlsx', 'success');
            }
            
            // 5. JD_Takeout_Template_Processed.xlsx
            if (processedData.jdResult && processedData.jdResult.jdTemplateData) {
                const jdTemplateWorkbook = createWorkbook(processedData.jdResult.jdTemplateData, 'JD Takeout Template');
                addDownloadItem('JD_Takeout_Template_Processed.xlsx', jdTemplateWorkbook);
                log('Generated JD_Takeout_Template_Processed.xlsx', 'success');
            }
            
            log('All result files generated', 'success');
        }

        // Download all files as ZIP archive
        async function downloadAllAsZip() {
            if (Object.keys(processedFiles).length === 0) {
                alert('No files to download!');
                return;
            }

            log('üì¶ Creating ZIP archive...', 'info');
            
            try {
                // Create ZIP instance
                const zip = new JSZip();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                
                // Add each file to ZIP
            Object.keys(processedFiles).forEach(filename => {
                    const workbook = processedFiles[filename];
                    const wbout = XLSX.write(workbook, {bookType: 'xlsx', type: 'array'});
                    zip.file(filename, wbout);
                    log(`üìÅ Adding file to archive: ${filename}`, 'info');
                });
                
                log('üì¶ Generating ZIP file...', 'info');
                
                // Generate ZIP file
                const zipBlob = await zip.generateAsync({type: 'blob'});
                
                // Create download link
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Excel_Processing_Results_${timestamp}.zip`;
                a.click();
                
                // Revoke URL object
                URL.revokeObjectURL(url);
                
                log('‚úÖ ZIP archive download complete!', 'success');
                log(`üì¶ Archive contains ${Object.keys(processedFiles).length} Excel files`, 'info');
                
            } catch (error) {
                log(`‚ùå Failed to create ZIP file: ${error.message}`, 'error');
                console.error('ZIP creation error:', error);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üìä Inventory processing tool is ready', 'success');
            log('Please select a folder containing the 9 required Excel files', 'info');
        });
    </script>
</body>
</html>
