<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelæ•°æ®å¤„ç†å·¥å…· - ç½‘é¡µç‰ˆ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1200px; margin: 0 auto; background: white;
            border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden; display: flex; flex-direction: column;
            min-height: calc(100vh - 40px);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; text-align: center;
        }
        .header h1 { font-size: 32px; font-weight: 600; margin-bottom: 10px; }
        .main-content { flex: 1; padding: 40px; }
        .upload-section {
            background: #f8f9fa; border-radius: 12px; padding: 30px;
            margin-bottom: 30px; border: 2px dashed #cbd5e0;
            transition: all 0.3s;
        }
        .upload-section:hover { border-color: #667eea; background: #f7fafc; }
        .file-input-group {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .file-input-item { display: flex; flex-direction: column; }
        .file-input-item label { font-weight: 500; color: #4a5568; margin-bottom: 8px; }
        .file-input { position: absolute; left: -9999px; }
        .file-input-button {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 12px 20px; background: #667eea; color: white;
            border: none; border-radius: 8px; cursor: pointer;
            transition: all 0.3s; font-size: 14px; font-weight: 500;
            width: 100%; justify-content: center;
        }
        .file-input-button:hover { background: #5568d3; transform: translateY(-2px); }
        .file-name { margin-top: 8px; font-size: 12px; color: #666; word-break: break-all; }
        .file-name.has-file { color: #48bb78; font-weight: 500; }
        .process-section { text-align: center; margin: 40px 0; }
        .btn {
            padding: 15px 30px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 500; cursor: pointer;
            transition: all 0.3s; display: inline-flex; align-items: center;
            gap: 10px; margin: 0 10px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .progress-section { margin: 30px 0; display: none; }
        .progress-bar {
            width: 100%; height: 20px; background: #e2e8f0;
            border-radius: 10px; overflow: hidden; margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%; transition: width 0.3s;
        }
        .progress-text { text-align: center; color: #666; font-size: 14px; }
        .results-section { margin-top: 30px; display: none; }
        .results-section h3 { color: #2d3748; margin-bottom: 20px; }
        .download-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .download-item {
            background: #f8f9fa; padding: 15px; border-radius: 8px;
            border: 1px solid #e2e8f0; display: flex;
            justify-content: space-between; align-items: center;
        }
        .download-btn {
            padding: 8px 16px; background: #48bb78; color: white;
            border: none; border-radius: 6px; cursor: pointer;
            font-size: 12px; transition: background 0.3s;
        }
        .download-btn:hover { background: #38a169; }
        .log-section { margin-top: 30px; display: none; }
        .log-container {
            background: #1a202c; color: #e2e8f0; padding: 20px;
            border-radius: 8px; font-family: 'Courier New', monospace;
            font-size: 13px; line-height: 1.5; max-height: 300px; overflow-y: auto;
        }
        .log-entry { margin-bottom: 5px; }
        .log-entry.success { color: #48bb78; }
        .log-entry.error { color: #f56565; }
        .log-entry.info { color: #4299e1; }
        .instructions {
            background: #edf2f7; padding: 20px; border-radius: 8px; margin-bottom: 30px;
        }
        .instructions h3 { color: #2d3748; margin-bottom: 15px; }
        .instructions ul { list-style: none; padding: 0; }
        .instructions li {
            margin: 8px 0; padding-left: 20px; position: relative;
            color: #4a5568;
        }
        .instructions li:before {
            content: "â€¢"; position: absolute; left: 0;
            color: #667eea; font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Excelæ•°æ®å¤„ç†å·¥å…·</h1>
            <p>ç½‘é¡µç‰ˆ - æ”¯æŒå¤šæ–‡ä»¶æ‰¹é‡å¤„ç†å’Œæ™ºèƒ½æ•°æ®åŒæ­¥</p>
        </div>
        <div class="main-content">
            <div class="instructions">
                <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
                <ul>
                    <li>é€‰æ‹©ä¸€ä¸ªåŒ…å«Excelæ–‡ä»¶çš„æ–‡ä»¶å¤¹</li>
                    <li>æ–‡ä»¶å¤¹ä¸­çš„Excelæ–‡ä»¶éœ€è¦ä»¥æ•°å­—1-9å¼€å¤´å‘½å</li>
                    <li>ç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«å¹¶åŒ¹é…å¯¹åº”çš„æ–‡ä»¶ç±»å‹</li>
                    <li>å¤„ç†å®Œæˆåå¯ä¸‹è½½ç»“æœæ–‡ä»¶</li>
                    <li>æ”¯æŒå¤§æ–‡ä»¶è‡ªåŠ¨åˆ†å‰²ï¼ˆè¶…è¿‡è¡Œæ•°é™åˆ¶æ—¶ï¼‰</li>
                </ul>
            </div>
            <div class="upload-section">
                <h2>ğŸ“ æ–‡ä»¶å¤¹ä¸Šä¼ </h2>
                <div style="text-align: center; margin-bottom: 20px;">
                    <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;" accept=".xlsx,.xls">
                    <button class="btn btn-primary" onclick="document.getElementById('folderInput').click()" style="font-size: 18px; padding: 20px 40px;">
                        ğŸ“‚ é€‰æ‹©åŒ…å«Excelæ–‡ä»¶çš„æ–‡ä»¶å¤¹
                    </button>
                    <div style="margin-top: 15px; color: #666; font-size: 14px;">
                        è¯·ç¡®ä¿æ–‡ä»¶å¤¹ä¸­çš„Excelæ–‡ä»¶ä»¥æ•°å­—1-9å¼€å¤´å‘½åï¼ˆå¦‚ï¼š1ç¾å¾—å¾—åº“å­˜.xlsx, 2é—¨åº—å.xlsxç­‰ï¼‰
                    </div>
                </div>
                
                <div id="fileMapping" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: #2d3748;">ğŸ“‹ æ–‡ä»¶è¯†åˆ«ç»“æœ</h3>
                    <div class="file-mapping-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px;">
                        <div class="mapping-item" id="mapping-1" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">1ï¸âƒ£ ç¾å¾—å¾—åº“å­˜</div>
                                    <div id="file-1-name" style="font-size: 12px; color: #666; margin-top: 5px;">æœªæ‰¾åˆ°</div>
                                </div>
                                <div id="file-1-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">ç¼ºå¤±</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-2" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">2ï¸âƒ£ é—¨åº—å</div>
                                    <div id="file-2-name" style="font-size: 12px; color: #666; margin-top: 5px;">æœªæ‰¾åˆ°</div>
                                </div>
                                <div id="file-2-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">ç¼ºå¤±</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-3" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">3ï¸âƒ£ ç¾å›¢å•†å“åº“</div>
                                    <div id="file-3-name" style="font-size: 12px; color: #666; margin-top: 5px;">æœªæ‰¾åˆ°</div>
                                </div>
                                <div id="file-3-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">ç¼ºå¤±</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-4" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">4ï¸âƒ£ é—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯</div>
                                    <div id="file-4-name" style="font-size: 12px; color: #666; margin-top: 5px;">æœªæ‰¾åˆ°</div>
                                </div>
                                <div id="file-4-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">ç¼ºå¤±</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-5" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">5ï¸âƒ£ é¥¿äº†ä¹ˆ</div>
                                    <div id="file-5-name" style="font-size: 12px; color: #666; margin-top: 5px;">æœªæ‰¾åˆ°</div>
                                </div>
                                <div id="file-5-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">ç¼ºå¤±</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-6" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">6ï¸âƒ£ é¥¿äº†ä¹ˆå•†å“åº“</div>
                                    <div id="file-6-name" style="font-size: 12px; color: #666; margin-top: 5px;">æœªæ‰¾åˆ°</div>
                                </div>
                                <div id="file-6-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">ç¼ºå¤±</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-7" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">7ï¸âƒ£ æŠ–éŸ³æè´§åˆ¸</div>
                                    <div id="file-7-name" style="font-size: 12px; color: #666; margin-top: 5px;">æœªæ‰¾åˆ°</div>
                                </div>
                                <div id="file-7-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">ç¼ºå¤±</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-8" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">8ï¸âƒ£ äº¬ä¸œå¤–å–æ¨¡ç‰ˆ</div>
                                    <div id="file-8-name" style="font-size: 12px; color: #666; margin-top: 5px;">æœªæ‰¾åˆ°</div>
                                </div>
                                <div id="file-8-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">ç¼ºå¤±</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-9" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">9ï¸âƒ£ äº¬ä¸œå¤–å–å•†å“åº“</div>
                                    <div id="file-9-name" style="font-size: 12px; color: #666; margin-top: 5px;">æœªæ‰¾åˆ°</div>
                                </div>
                                <div id="file-9-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">ç¼ºå¤±</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="file-input-group" style="display: none;">
                    <div class="file-input-item">
                        <label>ç¾å¾—å¾—åº“å­˜.xlsx</label>
                        <input type="file" class="file-input" id="kucun" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('kucun').click()">ğŸ“Š é€‰æ‹©æ–‡ä»¶</button>
                        <div class="file-name" id="kucun-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>é—¨åº—å.xlsx</label>
                        <input type="file" class="file-input" id="mendian" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('mendian').click()">ğŸª é€‰æ‹©æ–‡ä»¶</button>
                        <div class="file-name" id="mendian-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>ç¾å›¢å•†å“åº“.xlsx</label>
                        <input type="file" class="file-input" id="mtwm-goods" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('mtwm-goods').click()">ğŸ›’ é€‰æ‹©æ–‡ä»¶</button>
                        <div class="file-name" id="mtwm-goods-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>é—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯.xlsx</label>
                        <input type="file" class="file-input" id="dst" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('dst').click()">ğŸ“‹ é€‰æ‹©æ–‡ä»¶</button>
                        <div class="file-name" id="dst-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>é¥¿äº†ä¹ˆ.xlsx</label>
                        <input type="file" class="file-input" id="eleme" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('eleme').click()">ğŸœ é€‰æ‹©æ–‡ä»¶</button>
                        <div class="file-name" id="eleme-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>é¥¿äº†ä¹ˆå•†å“åº“.xlsx</label>
                        <input type="file" class="file-input" id="eleme-goods" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('eleme-goods').click()">ğŸ›ï¸ é€‰æ‹©æ–‡ä»¶</button>
                        <div class="file-name" id="eleme-goods-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>æŠ–éŸ³æè´§åˆ¸.xlsx</label>
                        <input type="file" class="file-input" id="douyin" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('douyin').click()">ğŸµ é€‰æ‹©æ–‡ä»¶</button>
                        <div class="file-name" id="douyin-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>äº¬ä¸œå¤–å–æ¨¡ç‰ˆ.xlsx</label>
                        <input type="file" class="file-input" id="jd-template" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('jd-template').click()">ğŸ›’ é€‰æ‹©æ–‡ä»¶</button>
                        <div class="file-name" id="jd-template-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>äº¬ä¸œå¤–å–å•†å“åº“.xlsx</label>
                        <input type="file" class="file-input" id="jd-goods" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('jd-goods').click()">ğŸ“¦ é€‰æ‹©æ–‡ä»¶</button>
                        <div class="file-name" id="jd-goods-name"></div>
                    </div>
                </div>
            </div>
            <div class="process-section">
                <button class="btn btn-primary" onclick="processFiles()" id="processBtn">ğŸš€ å¼€å§‹å¤„ç†</button>
                <button class="btn btn-success" onclick="downloadAllAsZip()" id="downloadAllBtn" style="display: none;">ğŸ“¦ æ‰“åŒ…ä¸‹è½½å…¨éƒ¨</button>
            </div>
            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">å‡†å¤‡å¼€å§‹å¤„ç†...</div>
            </div>
            <div class="results-section" id="resultsSection">
                <h3>ğŸ“‹ å¤„ç†ç»“æœ</h3>
                <div class="download-list" id="downloadList"></div>
            </div>
            <div class="log-section" id="logSection">
                <h3>ğŸ“ å¤„ç†æ—¥å¿—</h3>
                <div class="log-container" id="logContainer"></div>
            </div>
        </div>
    </div>
    <script>
        // å…¨å±€å˜é‡
        let uploadedFiles = {};
        let processedFiles = {};
        let fileMapping = {
            '1': 'kucun',
            '2': 'mendian', 
            '3': 'mtwm-goods',
            '4': 'dst',
            '5': 'eleme',
            '6': 'eleme-goods',
            '7': 'douyin',
            '8': 'jd-template',
            '9': 'jd-goods'
        };
        let fileNames = {
            '1': 'ç¾å¾—å¾—åº“å­˜',
            '2': 'é—¨åº—å',
            '3': 'ç¾å›¢å•†å“åº“', 
            '4': 'é—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯',
            '5': 'é¥¿äº†ä¹ˆ',
            '6': 'é¥¿äº†ä¹ˆå•†å“åº“',
            '7': 'æŠ–éŸ³æè´§åˆ¸',
            '8': 'äº¬ä¸œå¤–å–æ¨¡ç‰ˆ',
            '9': 'äº¬ä¸œå¤–å–å•†å“åº“'
        };

        // æ–‡ä»¶å¤¹ä¸Šä¼ ç›‘å¬å™¨
        document.getElementById('folderInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            log(`ğŸ“‚ é€‰æ‹©äº†æ–‡ä»¶å¤¹ï¼ŒåŒ…å« ${files.length} ä¸ªæ–‡ä»¶`, 'info');
            
            // é‡ç½®æ–‡ä»¶æ˜ å°„æ˜¾ç¤º
            resetFileMapping();
            
            // å¤„ç†æ–‡ä»¶
            files.forEach(file => {
                if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                    const firstChar = file.name.charAt(0);
                    if (fileMapping[firstChar]) {
                        uploadedFiles[fileMapping[firstChar]] = file;
                        updateFileMapping(firstChar, file.name);
                        log(`âœ… è¯†åˆ«æ–‡ä»¶: ${file.name} â†’ ${fileNames[firstChar]}`, 'success');
                    } else {
                        log(`âš ï¸ æ— æ³•è¯†åˆ«æ–‡ä»¶: ${file.name} (æ–‡ä»¶åä¸æ˜¯ä»¥1-9å¼€å¤´)`, 'warning');
                    }
                }
            });
            
            // æ˜¾ç¤ºæ–‡ä»¶æ˜ å°„ç»“æœ
            document.getElementById('fileMapping').style.display = 'block';
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¿…éœ€æ–‡ä»¶éƒ½å·²ä¸Šä¼ 
            const missingFiles = Object.keys(fileMapping).filter(num => !uploadedFiles[fileMapping[num]]);
            if (missingFiles.length === 0) {
                log('âœ… æ‰€æœ‰å¿…éœ€æ–‡ä»¶å·²æ‰¾åˆ°ï¼Œå¯ä»¥å¼€å§‹å¤„ç†', 'success');
            } else {
                log(`âš ï¸ ç¼ºå°‘æ–‡ä»¶: ${missingFiles.map(num => fileNames[num]).join(', ')}`, 'warning');
            }
        });

        // é‡ç½®æ–‡ä»¶æ˜ å°„æ˜¾ç¤º
        function resetFileMapping() {
            for (let i = 1; i <= 9; i++) {
                document.getElementById(`file-${i}-name`).textContent = 'æœªæ‰¾åˆ°';
                document.getElementById(`file-${i}-status`).textContent = 'ç¼ºå¤±';
                document.getElementById(`file-${i}-status`).style.background = '#f56565';
                document.getElementById(`mapping-${i}`).style.borderColor = '#e2e8f0';
            }
        }

        // æ›´æ–°æ–‡ä»¶æ˜ å°„æ˜¾ç¤º
        function updateFileMapping(number, fileName) {
            document.getElementById(`file-${number}-name`).textContent = fileName;
            document.getElementById(`file-${number}-status`).textContent = 'å·²æ‰¾åˆ°';
            document.getElementById(`file-${number}-status`).style.background = '#48bb78';
            document.getElementById(`mapping-${number}`).style.borderColor = '#48bb78';
        }

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logSection = document.getElementById('logSection');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            logSection.style.display = 'block';
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // æ˜¾ç¤ºè¿›åº¦æ¡
        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('processBtn').disabled = true;
        }

        // éšè—è¿›åº¦æ¡
        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
        }

        // è¯»å–Excelæ–‡ä»¶ - æ”¹è¿›ç‰ˆæœ¬ï¼Œæé«˜å…¼å®¹æ€§
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        
                        // ä½¿ç”¨æ›´å®½æ¾çš„è¯»å–é€‰é¡¹æé«˜å…¼å®¹æ€§
                        const workbook = XLSX.read(data, {
                            type: 'array',
                            cellDates: false,
                            cellNF: false,
                            cellText: false,
                            raw: false,
                            dateNF: 'yyyy-mm-dd',
                            sheetStubs: true,
                            bookDeps: false,
                            bookProps: false,
                            bookSheets: false,
                            bookVBA: false,
                            password: '',
                            WTF: false
                        });
                        
                        resolve(workbook);
                    } catch (error) {
                        log(`è¯»å–æ–‡ä»¶ ${file.name} æ—¶å‡ºé”™: ${error.message}`, 'error');
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // åˆ›å»ºå·¥ä½œç°¿
        function createWorkbook(data, sheetName = 'Sheet1') {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            return wb;
        }

        // è·å–å·¥ä½œè¡¨æ•°æ® - æ”¹è¿›ç‰ˆæœ¬ï¼Œç¡®ä¿è¯»å–æ‰€æœ‰åˆ—
        function getSheetData(workbook, sheetName = null) {
            const sheet = sheetName ? workbook.Sheets[sheetName] : workbook.Sheets[workbook.SheetNames[0]];
            
            // è·å–å·¥ä½œè¡¨èŒƒå›´
            let range = XLSX.utils.decode_range(sheet['!ref']);
            
            // å¼ºåˆ¶æ‰©å±•èŒƒå›´ï¼Œç¡®ä¿è‡³å°‘è¯»å–åˆ°ç¬¬10åˆ—
            range.e.c = Math.max(range.e.c, 10);
            
            // é‡æ–°è®¾ç½®èŒƒå›´
            sheet['!ref'] = XLSX.utils.encode_range(range);
            
            // ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•è¯»å–æ•°æ®
            const data = [];
            for (let row = range.s.r; row <= range.e.r; row++) {
                const rowData = [];
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({r: row, c: col});
                    const cell = sheet[cellAddress];
                    rowData.push(cell ? cell.v : '');
                }
                data.push(rowData);
            }
            
            return data;
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(workbook, filename) {
            const wbout = XLSX.write(workbook, {bookType: 'xlsx', type: 'array'});
            const blob = new Blob([wbout], {type: 'application/octet-stream'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ·»åŠ ä¸‹è½½é¡¹åˆ°ç»“æœåˆ—è¡¨
        function addDownloadItem(filename, workbook) {
            const downloadList = document.getElementById('downloadList');
            const item = document.createElement('div');
            item.className = 'download-item';
            
            const wbout = XLSX.write(workbook, {bookType: 'xlsx', type: 'array'});
            const blob = new Blob([wbout], {type: 'application/octet-stream'});
            const size = (blob.size / 1024).toFixed(1) + ' KB';
            
            item.innerHTML = `
                <div class="file-info">
                    <div class="file-name">${filename}</div>
                    <div class="file-size">å¤§å°: ${size}</div>
                </div>
                <button class="download-btn" onclick="downloadFile(processedFiles['${filename}'], '${filename}')">ä¸‹è½½</button>
            `;
            
            downloadList.appendChild(item);
            processedFiles[filename] = workbook;
        }

        // ä¸»è¦å¤„ç†å‡½æ•° - æŒ‰ç…§Pythoné€»è¾‘å®Œæ•´å®ç°
        async function processFiles() {
            const missingFiles = Object.keys(fileMapping).filter(num => !uploadedFiles[fileMapping[num]]);
            if (missingFiles.length > 0) {
                const missingFileNames = missingFiles.map(num => fileNames[num]);
                alert(`è¯·å…ˆä¸Šä¼ æ‰€æœ‰å¿…éœ€çš„æ–‡ä»¶ï¼\nç¼ºå°‘çš„æ–‡ä»¶ï¼š${missingFileNames.join(', ')}`);
                return;
            }

            showProgress();
            log('ğŸš€ å¼€å§‹å¤„ç†Excelæ–‡ä»¶...', 'info');

            try {
                updateProgress(5, 'æ­£åœ¨è¯»å–Excelæ–‡ä»¶...');
                const workbooks = {};
                for (const [id, file] of Object.entries(uploadedFiles)) {
                    log(`è¯»å–æ–‡ä»¶: ${file.name}`, 'info');
                    workbooks[id] = await readExcelFile(file);
                }

                updateProgress(10, 'å¤„ç†é—¨åº—æ•°æ®...');
                const storeData = await processStoreData(workbooks);

                updateProgress(15, 'å¤„ç†å•†å“æ•°æ®...');
                const goodsData = await processGoodsData(workbooks);

                updateProgress(20, 'å¤„ç†é—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯...');
                const dstData = await processDstData(workbooks, storeData, goodsData);

                updateProgress(30, 'å¤„ç†ç¾å¾—å¾—åº“å­˜æ•°æ®...');
                const kucunData = await processKucunData(workbooks, storeData);

                updateProgress(35, 'æ ‡è®°Uåˆ—...');
                const markedKucunData = await markUColumn(workbooks, goodsData, kucunData);

                updateProgress(40, 'åŒæ­¥åº“å­˜æ•°æ®...');
                const finalDstData = await syncInventoryData(workbooks, storeData, dstData, markedKucunData);

                updateProgress(50, 'å¤„ç†é¥¿äº†ä¹ˆæ•°æ®...');
                const elemeData = await processElemeData(workbooks, storeData, markedKucunData);

                updateProgress(55, 'æ£€æŸ¥é¥¿äº†ä¹ˆæ–‡ä»¶åˆ†å‰²...');
                await checkAndSplitElemeFile(elemeData);

                updateProgress(60, 'å¤„ç†æŠ–éŸ³æè´§åˆ¸æ•°æ®...');
                const douyinData = await processDouyinData(workbooks, storeData, markedKucunData);

                updateProgress(65, 'å¤„ç†æŠ–éŸ³æè´§åˆ¸ä¸ç¾å¾—å¾—åº“å­˜å¯¹æ¯”...');
                const finalKucunData = await processDouyinComparison(workbooks, storeData, markedKucunData);

                updateProgress(70, 'å¤„ç†äº¬ä¸œå¤–å–æ•°æ®...');
                const jdResult = await processJdData(workbooks, storeData, finalKucunData);

                updateProgress(75, 'æ£€æŸ¥äº¬ä¸œå¤–å–æ¨¡ç‰ˆæ–‡ä»¶åˆ†å‰²...');
                await checkAndSplitJdTemplateFile(jdResult.jdTemplateData);

                updateProgress(85, 'ç”Ÿæˆç»“æœæ–‡ä»¶...');
                await generateResultFiles(workbooks, {
                    storeData,
                    goodsData,
                    dstData: finalDstData,
                    kucunData: finalKucunData,
                    elemeData,
                    douyinData,
                    jdResult
                });

                updateProgress(100, 'å¤„ç†å®Œæˆï¼');
                log('âœ… æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆï¼', 'success');

                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('downloadAllBtn').style.display = 'inline-flex';
                hideProgress();

            } catch (error) {
                log(`âŒ å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`, 'error');
                console.error('å¤„ç†é”™è¯¯:', error);
                hideProgress();
            }
        }

        // 1. è¯»å–é—¨åº—IDï¼ˆå¯¹åº”Pythonç¬¬31-38è¡Œï¼‰
        async function processStoreData(workbooks) {
            log('å¤„ç†é—¨åº—æ•°æ®...', 'info');
            const mendianData = getSheetData(workbooks['mendian']);
            
            const mendianIds = [];
            // ä»ç¬¬2è¡Œå¼€å§‹ï¼Œè¯»å–Cåˆ—ï¼ˆç¬¬3åˆ—ï¼‰
            for (let i = 1; i < mendianData.length; i++) {
                const val = mendianData[i][2]; // Cåˆ—
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    mendianIds.push(String(val).trim());
                }
            }
            
            log(`æ‰¾åˆ° ${mendianIds.length} ä¸ªé—¨åº—ID`, 'success');
            return { mendianIds, mendianData };
        }

        // 2. è¯»å–ç¾å›¢å•†å“åº“Båˆ—ï¼ˆä»B3å¼€å§‹ï¼‰ï¼Œå¹¶åŒæ­¥Eã€Kã€Aã€Tåˆ—ï¼ˆå¯¹åº”Pythonç¬¬40-61è¡Œï¼‰
        async function processGoodsData(workbooks) {
            log('å¤„ç†å•†å“æ•°æ®...', 'info');
            const goodsData = getSheetData(workbooks['mtwm-goods']);
            const goodsInfo = [];
            
            // ä»ç¬¬3è¡Œå¼€å§‹ï¼Œé€‚åº”å®é™…æ–‡ä»¶ç»“æ„
            for (let i = 2; i < goodsData.length; i++) {
                const bVal = goodsData[i][1];  // Båˆ—ï¼ˆæ¡ç ï¼‰
                const eVal = goodsData[i][4];  // Eåˆ—ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
                const oVal = goodsData[i][10]; // Kåˆ—ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
                const aVal = goodsData[i][0];  // Aåˆ—ï¼ˆsku_idï¼‰
                const tVal = goodsData[i][19]; // Tåˆ—ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
                
                // æ£€æŸ¥Båˆ—æ˜¯å¦æœ‰æœ‰æ•ˆæ¡ç æ•°æ®
                if (bVal !== null && bVal !== undefined && 
                    String(bVal).trim() !== '' && 
                    !String(bVal).includes('æ¡å½¢ç ä¸ºå›½å®¶ç¼–ç ç½‘æ”¶å½•çš„æ¡ç ') &&
                    !String(bVal).includes('æ¡å½¢ç ') && // æ’é™¤æ ‡é¢˜è¡Œ
                    String(bVal).trim().length >= 8) { // ç¡®ä¿æ˜¯æœ‰æ•ˆçš„æ¡ç é•¿åº¦
                    
                    goodsInfo.push({
                        barcode: String(bVal).trim(),
                        e_col: eVal || '', // å¦‚æœEåˆ—ä¸ºç©ºï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²
                        o_col: oVal || '', // å¦‚æœKåˆ—ä¸ºç©ºï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²
                        a_col: aVal || '', // Aåˆ—æ•°æ®
                        t_col: tVal || ''  // å¦‚æœTåˆ—ä¸ºç©ºï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²
                    });
                }
            }
            
            log(`æ‰¾åˆ° ${goodsInfo.length} ä¸ªå•†å“ä¿¡æ¯`, 'success');
            return goodsInfo;
        }

        // 3. å¤„ç†é—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯ï¼ˆå¯¹åº”Pythonç¬¬63-82è¡Œï¼‰
        async function processDstData(workbooks, storeData, goodsData) {
            log('å¤„ç†é—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯...', 'info');
            const dstData = getSheetData(workbooks['dst']);
            
            // ä»D5å¼€å§‹ç²˜è´´ï¼Œå®ç°ç¬›å¡å°”ç§¯
            let rowIdx = 5; // ä»ç¬¬5è¡Œå¼€å§‹ï¼ˆç´¢å¼•ä¸º4ï¼‰
            
            for (const mendianId of storeData.mendianIds) {
                for (const info of goodsData) {
                    // ç¡®ä¿è¡Œå­˜åœ¨ï¼Œå¦‚æœä¸å¤Ÿå°±æ‰©å±•
                    while (dstData.length <= rowIdx - 1) {
                        dstData.push(new Array(20).fill('')); // æ‰©å±•è¶³å¤Ÿçš„åˆ—
                    }
                    
                    dstData[rowIdx - 1][0] = mendianId;           // Aåˆ—å†™é—¨åº—ID
                    dstData[rowIdx - 1][3] = info.barcode;        // Dåˆ—å†™æ¡ç 
                    dstData[rowIdx - 1][1] = info.e_col;          // Båˆ—å†™ç¾å›¢å•†å“åº“Eåˆ—
                    dstData[rowIdx - 1][2] = info.o_col;          // Cåˆ—å†™ç¾å›¢å•†å“åº“Kåˆ—
                    dstData[rowIdx - 1][4] = info.a_col;          // Eåˆ—å†™ç¾å›¢å•†å“åº“Aåˆ—
                    // Jåˆ—ä¸å†å¡«å†™ï¼ˆPythonæ³¨é‡Šæ‰äº†ï¼‰
                    
                    if (info.barcode) {  // Dåˆ—æœ‰å†…å®¹
                        dstData[rowIdx - 1][5] = 0;              // Fåˆ—å†™0
                    }
                    rowIdx++;
                }
            }
            
            log('å·²å®Œæˆé—¨åº—IDä¸å•†å“æ¡ç çš„æ‰¹é‡ç²˜è´´', 'success');
            return dstData;
        }

        // 4. å¤„ç†ç¾å¾—å¾—åº“å­˜ï¼ˆå¯¹åº”Pythonç¬¬84-130è¡Œï¼‰
        async function processKucunData(workbooks, storeData) {
            log('å¤„ç†ç¾å¾—å¾—åº“å­˜æ•°æ®...', 'info');
            const kucunData = getSheetData(workbooks['kucun']);
            const processedKucunData = kucunData.map(row => [...row]);
            
            // å»ºç«‹"é—¨åº—å"Båˆ—åˆ°Aåˆ—å’ŒDåˆ—çš„æ˜ å°„
            const bToA = {};
            const bToD = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const mendianA = storeData.mendianData[i][0];  // Aåˆ—
                const mendianB = storeData.mendianData[i][1];  // Båˆ—
                const mendianD = storeData.mendianData[i][3];  // Dåˆ—
                const key = mendianB !== null ? String(mendianB).trim() : '';
                if (key) {
                    bToA[key] = mendianA;
                    bToD[key] = mendianD;
                }
            }
            
            // è®¾ç½®V2ã€W2å•å…ƒæ ¼æ ‡é¢˜
            if (processedKucunData.length > 1) {
                processedKucunData[1][21] = 'ç¾å›¢åº—å'; // Våˆ—
                processedKucunData[1][22] = 'é¥¿äº†ä¹ˆ';    // Wåˆ—
            }
            
            // åœ¨Vã€Wåˆ—å†™æ–°åå­—ï¼ŒAåˆ—å†…å®¹ä¸å˜
            for (let i = 1; i < processedKucunData.length; i++) {
                const cell = processedKucunData[i][0]; // Aåˆ—
                const key = cell !== null ? String(cell).trim() : '';
                
                if (key && bToA[key]) {
                    processedKucunData[i][21] = bToA[key]; // Våˆ—
                }
                if (key && bToD[key]) {
                    processedKucunData[i][22] = bToD[key]; // Wåˆ—
                }
            }
            
            log('å·²ç”Ÿæˆæ–°è¡¨æ ¼å¹¶å®ŒæˆAåˆ—æ›¿æ¢', 'success');
            return processedKucunData;
        }

        // 5. å¯¹æ¯”ç¾å¾—å¾—åº“å­˜Dåˆ—å’Œå•†å“åº“Båˆ—ï¼Œåœ¨Uåˆ—æ ‡è®°ï¼ˆå¯¹åº”Pythonç¬¬132-158è¡Œï¼‰
        async function markUColumn(workbooks, goodsData, kucunData) {
            log('æ ‡è®°Uåˆ—...', 'info');
            
            // è·å–å•†å“åº“æ‰€æœ‰æ¡ç 
            const goodsBarcodesSet = new Set();
            for (const info of goodsData) {
                goodsBarcodesSet.add(info.barcode);
            }
            
            // è®¾ç½®Uåˆ—æ ‡é¢˜
            if (kucunData.length > 1) {
                kucunData[1][20] = 'ç¾å›¢å¤–å–/é¥¿äº†ä¹ˆ'; // Uåˆ—
            }
            
            // éå†Dåˆ—ï¼Œä»ç¬¬2è¡Œå¼€å§‹
            for (let i = 1; i < kucunData.length; i++) {
                const dVal = kucunData[i][3]; // Dåˆ—
                if (dVal !== null && goodsBarcodesSet.has(String(dVal).trim())) {
                    kucunData[i][20] = 'æœ‰'; // Uåˆ—
                }
            }
            
            log('å·²å®ŒæˆUåˆ—æ ‡è®°', 'success');
            return kucunData;
        }


        // 6. åº“å­˜åŒæ­¥é€»è¾‘ï¼ˆå¯¹åº”Pythonç¬¬160-240è¡Œï¼‰
        async function syncInventoryData(workbooks, storeData, dstData, kucunData) {
            log('åŒæ­¥åº“å­˜æ•°æ®...', 'info');
            
            // 1. è¯»å–"é—¨åº—å"Aåˆ—->Cåˆ—ï¼ˆé—¨åº—å->é—¨åº—IDï¼‰æ˜ å°„
            const mendianNameToId = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const name = storeData.mendianData[i][0];  // Aåˆ—
                const id = storeData.mendianData[i][2];    // Cåˆ—
                if (name !== null && String(name).trim() !== '' && id !== null) {
                    mendianNameToId[String(name).trim()] = String(id).trim();
                }
            }
            
            // 2. è¯»å–"é—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯"æ‰€æœ‰è¡Œï¼Œå»ºç«‹(é—¨åº—ID, æ¡ç )åˆ°è¡Œå·çš„æ˜ å°„
            const dstIdBarcodeToRow = {};
            for (let i = 4; i < dstData.length; i++) { // ä»ç¬¬5è¡Œå¼€å§‹
                const dstId = dstData[i][0];    // Aåˆ—
                const dstBarcode = dstData[i][3]; // Dåˆ—
                if (dstId !== null && dstBarcode !== null) {
                    const key = `${String(dstId).trim()}_${String(dstBarcode).trim()}`;
                    dstIdBarcodeToRow[key] = i; // å­˜å‚¨è¡Œç´¢å¼•
                }
            }
            
            // 3. éå†ç¾å¾—å¾—åº“å­˜ï¼ŒUåˆ—ä¸º"æœ‰"çš„è¡Œ
            let syncCount = 0;
            for (let i = 1; i < kucunData.length; i++) {
                const uVal = kucunData[i][20]; // Uåˆ—
                if (uVal === 'æœ‰') {
                    const kucunMendian = kucunData[i][21]; // Våˆ—ï¼ˆé—¨åº—åï¼‰
                    const kucunBarcode = kucunData[i][3];  // Dåˆ—ï¼ˆæ¡ç ï¼‰
                    const kucunKucun = kucunData[i][7];    // Håˆ—ï¼ˆåº“å­˜æ•°é‡ï¼‰
                    
                    if (kucunMendian === null || kucunBarcode === null) {
                        continue;
                    }
                    
                    const mendianId = mendianNameToId[String(kucunMendian).trim()];
                    if (!mendianId) {
                        continue;
                    }
                    
                    // æŸ¥æ‰¾"é—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯"ä¸­å¯¹åº”çš„è¡Œ
                    const key = `${mendianId}_${String(kucunBarcode).trim()}`;
                    const dstRowIdx = dstIdBarcodeToRow[key];
                    if (dstRowIdx !== undefined) {
                        dstData[dstRowIdx][11] = kucunKucun; // Låˆ—ï¼ˆç¬¬12åˆ—ï¼‰
                        syncCount++;
                    }
                }
            }
            
            log(`å·²å®Œæˆåº“å­˜æ•°é‡åŒæ­¥åˆ°é—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯Låˆ—ï¼ŒåŒæ­¥äº† ${syncCount} æ¡è®°å½•`, 'success');
            
            // 4. éå†"é—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯"ï¼ŒDåˆ—æœ‰å†…å®¹ä½†Låˆ—æ²¡æœ‰çš„ï¼Œåœ¨Låˆ—æ ‡è®°ä¸º"0"
            let zeroFillCount = 0;
            for (let i = 4; i < dstData.length; i++) { // ä»ç¬¬5è¡Œå¼€å§‹
                const dVal = dstData[i][3];  // Dåˆ—
                const lVal = dstData[i][11]; // Låˆ—
                if (dVal !== null && String(dVal).trim() !== '' && 
                    (lVal === null || lVal === undefined || String(lVal).trim() === '')) {
                    dstData[i][11] = 0; // Låˆ—å†™0
                    zeroFillCount++;
                }
            }
            log(`å·²å®ŒæˆLåˆ—ç©ºç¼ºè¡¥é›¶ï¼Œè¡¥é›¶äº† ${zeroFillCount} æ¡è®°å½•`, 'success');
            
            // 5. å°†"é—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯"Låˆ—å°äº0çš„éƒ½æ”¹æˆ0
            let negativeCount = 0;
            for (let i = 4; i < dstData.length; i++) { // ä»ç¬¬5è¡Œå¼€å§‹
                const lVal = dstData[i][11]; // Låˆ—
                try {
                    if (lVal !== null && lVal !== undefined && String(lVal).trim() !== '' && parseFloat(lVal) < 0) {
                        dstData[i][11] = 0;
                        negativeCount++;
                    }
                } catch (e) {
                    // å¦‚æœä¸æ˜¯æ•°å­—ï¼Œè·³è¿‡
                }
            }
            log(`å·²å®ŒæˆLåˆ—å°äº0çš„æ•°å€¼å½’é›¶ï¼Œå½’é›¶äº† ${negativeCount} æ¡è®°å½•`, 'success');
            
            // 6. å¦‚æœLåˆ—åº“å­˜æ•°æ®ä¸º0ï¼ŒFåˆ—å¡«å†™ä¸º1
            let fColumnFillCount = 0;
            for (let i = 4; i < dstData.length; i++) { // ä»ç¬¬5è¡Œå¼€å§‹
                const lVal = dstData[i][11]; // Låˆ—ï¼ˆåº“å­˜æ•°é‡ï¼‰
                try {
                    if (lVal !== null && lVal !== undefined && String(lVal).trim() !== '' && parseFloat(lVal) === 0) {
                        dstData[i][5] = 1; // Fåˆ—å†™1
                        fColumnFillCount++;
                    }
                } catch (e) {
                    // å¦‚æœä¸æ˜¯æ•°å­—ï¼Œè·³è¿‡
                }
            }
            log(`å·²å®ŒæˆLåˆ—åº“å­˜ä¸º0æ—¶Fåˆ—å¡«å†™1çš„å¤„ç†ï¼Œå¤„ç†äº† ${fColumnFillCount} æ¡è®°å½•`, 'success');
            
            // 7. å¦‚æœAåˆ—æœ‰å†…å®¹ä½†Cåˆ—æ²¡æœ‰å†…å®¹ï¼Œåœ¨Cåˆ—å¡«å†™"ä¸ª"
            let unitFillCount = 0;
            for (let i = 4; i < dstData.length; i++) { // ä»ç¬¬5è¡Œå¼€å§‹
                const aVal = dstData[i][0]; // Aåˆ—ï¼ˆé—¨åº—IDï¼‰
                const cVal = dstData[i][2]; // Cåˆ—
                
                if (aVal !== null && String(aVal).trim() !== '' && 
                    (cVal === null || cVal === undefined || String(cVal).trim() === '')) {
                    dstData[i][2] = 'ä¸ª'; // Cåˆ—å¡«å†™"ä¸ª"
                    unitFillCount++;
                }
            }
            log(`å·²å®ŒæˆCåˆ—ç©ºç¼ºå¡«å……ï¼Œå¡«å……äº† ${unitFillCount} æ¡è®°å½•`, 'success');
            
            return dstData;
        }

        // 7. é¥¿äº†ä¹ˆæ•°æ®å¤„ç†ï¼ˆå¯¹åº”Pythonç¬¬242-378è¡Œï¼‰
        async function processElemeData(workbooks, storeData, kucunData) {
            log('å¤„ç†é¥¿äº†ä¹ˆæ•°æ®...', 'info');
            
            // è¯»å–é¥¿äº†ä¹ˆé—¨åº—IDï¼ˆEåˆ—ï¼Œç¬¬5åˆ—ï¼‰
            const elemeIds = [];
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const val = storeData.mendianData[i][4]; // Eåˆ—
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    elemeIds.push(String(val).trim());
                }
            }
            
            // è¯»å–é¥¿äº†ä¹ˆå•†å“åº“æ•°æ®
            const elemeGoodsData = getSheetData(workbooks['eleme-goods']);
            const barcodes = [];
            const eColVals = [];
            
            // ä»é¥¿äº†ä¹ˆå•†å“åº“è¯»å–æ¡ç ï¼ˆAåˆ—ï¼Œä»A2å¼€å§‹ï¼‰
            for (let i = 1; i < elemeGoodsData.length; i++) {
                const bVal = elemeGoodsData[i][0]; // Aåˆ—
                barcodes.push(bVal !== null ? String(bVal).trim() : '');
            }
            
            // ä»é¥¿äº†ä¹ˆå•†å“åº“è¯»å–Båˆ—å†…å®¹ï¼ˆä»B2å¼€å§‹ï¼‰
            for (let i = 1; i < elemeGoodsData.length; i++) {
                const eVal = elemeGoodsData[i][1]; // Båˆ—
                eColVals.push(eVal !== null ? String(eVal).trim() : '');
            }
            
            // è·å–é¥¿äº†ä¹ˆè¡¨æ ¼æ•°æ®å¹¶æ‰©å±•
            const elemeData = getSheetData(workbooks['eleme']);
            
            // ä»ç¬¬3è¡Œå¼€å§‹æ‰¹é‡å†™å…¥
            let rowIdx = 3; // ä»ç¬¬3è¡Œå¼€å§‹ï¼ˆç´¢å¼•ä¸º2ï¼‰
            
            for (const elemeId of elemeIds) {
                for (let i = 0; i < barcodes.length; i++) {
                    // ç¡®ä¿è¡Œå­˜åœ¨
                    while (elemeData.length <= rowIdx - 1) {
                        elemeData.push(new Array(15).fill('')); // æ‰©å±•è¶³å¤Ÿçš„åˆ—
                    }
                    
                    elemeData[rowIdx - 1][0] = elemeId;           // Aåˆ—ï¼šé—¨åº—ID
                    elemeData[rowIdx - 1][2] = barcodes[i];       // Cåˆ—ï¼šæ¡ç 
                    elemeData[rowIdx - 1][3] = eColVals[i];       // Dåˆ—ï¼šé¥¿äº†ä¹ˆå•†å“åº“Båˆ—å†…å®¹
                    rowIdx++;
                }
            }
            
            log(`å·²å°†å•†å“åº“å†…å®¹æ‰¹é‡å¤åˆ¶åˆ°é¥¿äº†ä¹ˆè¡¨æ ¼ï¼Œç”Ÿæˆäº† ${rowIdx - 3} è¡Œæ•°æ®`, 'success');
            
            // åŒæ­¥ç¾å¾—å¾—åº“å­˜åˆ°é¥¿äº†ä¹ˆHåˆ—ï¼Œå¹¶Aåˆ—æœ‰å†…å®¹çš„Jåˆ—å†™"ä¸Šæ¶"
            await syncElemeInventory(elemeData, storeData, kucunData);
            
            // æ ¹æ®é¥¿äº†ä¹ˆAåˆ—é—¨åº—IDï¼Œä»é—¨åº—åè¡¨è·å–Dåˆ—å†…å®¹å¡«å†™åˆ°é¥¿äº†ä¹ˆBåˆ—
            await fillElemeStoreNames(elemeData, storeData);
            
            // è¯†åˆ«Håˆ—åº“å­˜ä¸º"0"æ—¶ï¼Œåœ¨Jåˆ—å¡«å†™"ä¸‹æ¶"
            await markElemeOffline(elemeData);
            
            return elemeData;
        }

        // åŒæ­¥ç¾å¾—å¾—åº“å­˜åˆ°é¥¿äº†ä¹ˆHåˆ—
        async function syncElemeInventory(elemeData, storeData, kucunData) {
            log('åŒæ­¥åº“å­˜åˆ°é¥¿äº†ä¹ˆè¡¨æ ¼...', 'info');
            
            // 1. ç”¨"é—¨åº—å.xlsx"Dåˆ—ï¼ˆé¥¿äº†ä¹ˆåº—åï¼‰å’ŒEåˆ—ï¼ˆé¥¿äº†ä¹ˆIDï¼‰å»ºç«‹æ˜ å°„
            const elemeNameToId = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const elemeName = storeData.mendianData[i][3]; // Dåˆ—ï¼ˆé¥¿äº†ä¹ˆåº—åï¼‰
                const elemeId = storeData.mendianData[i][4];   // Eåˆ—ï¼ˆé¥¿äº†ä¹ˆé—¨åº—IDï¼‰
                if (elemeName !== null && String(elemeName).trim() !== '' && elemeId !== null) {
                    elemeNameToId[String(elemeName).trim()] = String(elemeId).trim();
                }
            }
            
            // 2. åœ¨"é¥¿äº†ä¹ˆ.xlsx"ä¸­ï¼Œå»ºç«‹(é—¨åº—ID, æ¡ç )åˆ°è¡Œçš„æ˜ å°„
            const elemeIdBarcodeToRow = {};
            for (let i = 2; i < elemeData.length; i++) { // ä»ç¬¬3è¡Œå¼€å§‹
                const elemeId = elemeData[i][0];    // Aåˆ—ï¼ˆé¥¿äº†ä¹ˆé—¨åº—IDï¼‰
                const elemeBarcode = elemeData[i][2]; // Cåˆ—ï¼ˆæ¡ç ï¼‰
                if (elemeId !== null && elemeBarcode !== null) {
                    const key = `${String(elemeId).trim()}_${String(elemeBarcode).trim()}`;
                    elemeIdBarcodeToRow[key] = i; // å­˜å‚¨è¡Œç´¢å¼•
                }
            }
            
            // 3. éå†æ‰€æœ‰è¡Œï¼Œå†™å…¥åº“å­˜åˆ°"é¥¿äº†ä¹ˆ.xlsx"Håˆ—ï¼ˆå¯¹åº”Pythonç¬¬312-325è¡Œï¼‰
            let syncCount = 0;
            for (let i = 1; i < kucunData.length; i++) {
                const elemeName = kucunData[i][22]; // Wåˆ—ï¼ˆç¬¬23åˆ—ï¼Œé¥¿äº†ä¹ˆåº—åï¼‰
                const barcode = kucunData[i][3];    // Dåˆ—ï¼ˆç¬¬4åˆ—ï¼Œæ¡ç ï¼‰
                const kucunKucun = kucunData[i][7]; // Håˆ—ï¼ˆç¬¬8åˆ—ï¼Œåº“å­˜æ•°é‡ï¼‰
                
                if (elemeName === null || barcode === null) {
                    continue;
                }
                
                const elemeId = elemeNameToId[String(elemeName).trim()];
                if (!elemeId) {
                    continue;
                }
                
                const key = `${elemeId}_${String(barcode).trim()}`;
                const elemeRowIdx = elemeIdBarcodeToRow[key];
                if (elemeRowIdx !== undefined) {
                    elemeData[elemeRowIdx][7] = kucunKucun; // Håˆ—ï¼ˆç¬¬8åˆ—ï¼‰
                    syncCount++;
                }
            }
            
            log(`å·²å®Œæˆåº“å­˜åŒæ­¥åˆ°é¥¿äº†ä¹ˆHåˆ—ï¼ŒåŒæ­¥äº† ${syncCount} æ¡è®°å½•`, 'success');
            
            // 4. Aåˆ—æœ‰å†…å®¹çš„ï¼ŒJåˆ—å†™"ä¸Šæ¶"
            for (let i = 2; i < elemeData.length; i++) { // ä»ç¬¬3è¡Œå¼€å§‹
                const aVal = elemeData[i][0]; // Aåˆ—
                if (aVal !== null && String(aVal).trim() !== '') {
                    elemeData[i][9] = 'ä¸Šæ¶'; // Jåˆ—ï¼ˆç¬¬10åˆ—ï¼‰
                }
            }
            
            // 5. åªæœ‰Aåˆ—æœ‰å†…å®¹çš„ï¼ŒHåˆ—æ‰è¦è¡¥0
            for (let i = 2; i < elemeData.length; i++) { // ä»ç¬¬3è¡Œå¼€å§‹
                const aVal = elemeData[i][0]; // Aåˆ—
                const hVal = elemeData[i][7]; // Håˆ—
                if (aVal !== null && String(aVal).trim() !== '') {
                    if (hVal === null || hVal === undefined || String(hVal).trim() === '') {
                        elemeData[i][7] = 0; // Håˆ—å†™0
                    }
                }
            }
            
            log('å·²å®Œæˆé¥¿äº†ä¹ˆè¡¨æ ¼Håˆ—ç©ºç¼ºè¡¥é›¶ï¼ˆä»…Aåˆ—æœ‰å†…å®¹çš„è¡Œï¼‰', 'success');
        }

        // æ ¹æ®é¥¿äº†ä¹ˆAåˆ—é—¨åº—IDå¡«å†™Båˆ—åº—å
        async function fillElemeStoreNames(elemeData, storeData) {
            log('å¡«å†™é¥¿äº†ä¹ˆåº—å...', 'info');
            
            // 1. å»ºç«‹"é—¨åº—å.xlsx"Eåˆ—ï¼ˆé¥¿äº†ä¹ˆé—¨åº—IDï¼‰åˆ°Dåˆ—ï¼ˆé¥¿äº†ä¹ˆåº—åï¼‰çš„æ˜ å°„
            const elemeIdToName = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const elemeId = storeData.mendianData[i][4];    // Eåˆ—ï¼ˆé¥¿äº†ä¹ˆé—¨åº—IDï¼‰
                const elemeName = storeData.mendianData[i][3];  // Dåˆ—ï¼ˆé¥¿äº†ä¹ˆåº—åï¼‰
                if (elemeId !== null && String(elemeId).trim() !== '' && elemeName !== null) {
                    elemeIdToName[String(elemeId).trim()] = String(elemeName).trim();
                }
            }
            
            // 2. éå†"é¥¿äº†ä¹ˆ.xlsx"ï¼Œæ ¹æ®Aåˆ—é—¨åº—IDå¡«å†™Båˆ—
            for (let i = 2; i < elemeData.length; i++) { // ä»ç¬¬3è¡Œå¼€å§‹
                const elemeId = elemeData[i][0]; // Aåˆ—ï¼ˆé¥¿äº†ä¹ˆé—¨åº—IDï¼‰
                if (elemeId !== null && String(elemeId).trim() in elemeIdToName) {
                    const elemeName = elemeIdToName[String(elemeId).trim()];
                    elemeData[i][1] = elemeName; // Båˆ—å¡«å†™é¥¿äº†ä¹ˆåº—å
                }
            }
            
            log('å·²å®Œæˆé¥¿äº†ä¹ˆAåˆ—é—¨åº—IDå¯¹åº”åº—åå¡«å†™åˆ°Båˆ—', 'success');
        }

        // è¯†åˆ«Håˆ—åº“å­˜ä¸º"0"æ—¶ï¼Œåœ¨Jåˆ—å¡«å†™"ä¸‹æ¶"
        async function markElemeOffline(elemeData) {
            log('æ ‡è®°é¥¿äº†ä¹ˆä¸‹æ¶å•†å“...', 'info');
            
            for (let i = 2; i < elemeData.length; i++) { // ä»ç¬¬3è¡Œå¼€å§‹
                const hVal = elemeData[i][7]; // Håˆ—ï¼ˆåº“å­˜æ•°é‡ï¼‰
                if (hVal !== null && String(hVal).trim() === '0') {
                    elemeData[i][9] = 'ä¸‹æ¶'; // Jåˆ—å¡«å†™"ä¸‹æ¶"
                }
            }
            
            log('å·²å®Œæˆé¥¿äº†ä¹ˆHåˆ—åº“å­˜ä¸º0çš„å•†å“åœ¨Jåˆ—æ ‡è®°ä¸ºä¸‹æ¶', 'success');
        }

        // 8. æŠ–éŸ³æè´§åˆ¸å¤„ç†ï¼ˆå¯¹åº”Pythonç¬¬380-559è¡Œï¼‰
        async function processDouyinData(workbooks, storeData, kucunData) {
            log('å¤„ç†æŠ–éŸ³æè´§åˆ¸æ•°æ®...', 'info');
            
            // å¤åˆ¶æŠ–éŸ³æè´§åˆ¸æ•°æ®
            const douyinData = getSheetData(workbooks['douyin']);
            const processedDouyinData = douyinData.map(row => [...row]);
            
            // å»ºç«‹"é—¨åº—å.xlsx"Fåˆ—ï¼ˆæŠ–éŸ³IDï¼‰åˆ°Båˆ—ï¼ˆç¾å¾—å¾—é—¨åº—åï¼‰çš„æ˜ å°„
            const douyinIdToMendianName = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const mendianName = storeData.mendianData[i][1]; // Båˆ—ï¼ˆç¾å¾—å¾—é—¨åº—åï¼‰
                const douyinId = storeData.mendianData[i][5];     // Fåˆ—ï¼ˆæŠ–éŸ³IDï¼‰
                if (douyinId !== null && String(douyinId).trim() !== '' && mendianName !== null) {
                    douyinIdToMendianName[String(douyinId).trim()] = String(mendianName).trim();
                }
            }
            
            // å»ºç«‹"ç¾å¾—å¾—åº“å­˜"ä¸­(ä»“åº“åç§°, å•†å“æ¡ç )åˆ°åº“å­˜æ•°é‡çš„æ˜ å°„ï¼ˆå¯¹åº”Pythonç¬¬399-408è¡Œï¼‰
            // æ³¨æ„ï¼šPythonç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯åŸå§‹åº“å­˜æ–‡ä»¶ï¼Œä¸æ˜¯å¤„ç†åçš„æ–‡ä»¶
            const originalKucunData = getSheetData(workbooks['kucun']);
            const kucunMap = {};
            for (let i = 1; i < originalKucunData.length; i++) {
                const warehouseName = originalKucunData[i][0];  // Aåˆ—ï¼ˆä»“åº“åç§°ï¼‰
                const barcode = originalKucunData[i][3];         // Dåˆ—ï¼ˆå•†å“æ¡ç ï¼‰
                const stockCount = originalKucunData[i][7];      // Håˆ—ï¼ˆåº“å­˜æ€»æ•°ï¼‰
                if (warehouseName !== null && barcode !== null) {
                    const key = `${String(warehouseName).trim()}_${String(barcode).trim()}`;
                    kucunMap[key] = stockCount !== null ? stockCount : 0;
                }
            }
            
            // å¤„ç†æŠ–éŸ³æè´§åˆ¸æ•°æ®
            let processedCount = 0;
            for (let i = 1; i < processedDouyinData.length; i++) { // å‡è®¾ä»ç¬¬2è¡Œå¼€å§‹æœ‰æ•°æ®
                const poiId = processedDouyinData[i][5];      // Fåˆ—ï¼ˆPOIIDï¼‰
                const merchantCode = processedDouyinData[i][4]; // Eåˆ—ï¼ˆå•†å®¶ç¼–ç ï¼‰
                const douyinStock = processedDouyinData[i][7];  // Håˆ—ï¼ˆå¯¼å‡ºæ—¶å¯å”®åº“å­˜æ•°é‡ï¼‰
                
                if (poiId === null || merchantCode === null) {
                    continue;
                }
                
                // æ ¹æ®POIIDæ‰¾åˆ°ç¾å¾—å¾—é—¨åº—å
                const mendianName = douyinIdToMendianName[String(poiId).trim()];
                if (!mendianName) {
                    continue;
                }
                
                // æ ¹æ®ç¾å¾—å¾—é—¨åº—åå’Œå•†å®¶ç¼–ç æ‰¾åˆ°åº“å­˜æ•°é‡
                const key = `${mendianName}_${String(merchantCode).trim()}`;
                const kucunStock = kucunMap[key] || 0;
                
                // è®¡ç®—åº“å­˜å·®å¼‚
                let kucunStockNum = kucunStock === null ? 0 : parseFloat(kucunStock);
                let douyinStockNum = douyinStock === null ? 0 : parseFloat(douyinStock);
                
                try {
                    const difference = kucunStockNum - douyinStockNum;
                    
                    // æ ¹æ®å·®å¼‚å¡«å†™Iåˆ—å’ŒJåˆ—
                    if (difference > 0) {
                        processedDouyinData[i][8] = 'å¢';  // Iåˆ—
                        processedDouyinData[i][9] = difference;  // Jåˆ—ï¼ˆåº“å­˜å˜æ›´æ•°é‡ï¼‰
                        processedCount++;
                    } else if (difference < 0) {
                        processedDouyinData[i][8] = 'å‡';  // Iåˆ—
                        processedDouyinData[i][9] = Math.abs(difference);  // Jåˆ—ï¼ˆå–ç»å¯¹å€¼ï¼‰
                        processedCount++;
                    }
                    // å¦‚æœdifference == 0ï¼Œä¸åšä»»ä½•å¡«å†™
                    
                } catch (e) {
                    // å¦‚æœè½¬æ¢æ•°å­—å¤±è´¥ï¼Œè·³è¿‡è¿™ä¸€è¡Œ
                    continue;
                }
            }
            
            log(`å·²å®ŒæˆæŠ–éŸ³æè´§åˆ¸å¤„ç†ï¼Œå¤„ç†äº† ${processedCount} æ¡åº“å­˜å·®å¼‚è®°å½•`, 'success');
            return processedDouyinData;
        }

        // 9. æŠ–éŸ³æè´§åˆ¸ä¸ç¾å¾—å¾—åº“å­˜å¯¹æ¯”å¤„ç†ï¼ˆå¯¹åº”Pythonç¬¬455-559è¡Œï¼‰
        async function processDouyinComparison(workbooks, storeData, kucunData) {
            log('å¤„ç†æŠ–éŸ³æè´§åˆ¸ä¸ç¾å¾—å¾—åº“å­˜å¯¹æ¯”...', 'info');
            
            // 1. åœ¨"ç¾å¾—å¾—åº“å­˜_å¤„ç†ç»“æœ"çš„X2å•å…ƒæ ¼å¡«å†™"æŠ–éŸ³"ï¼ŒY2å•å…ƒæ ¼å¡«å†™"æŠ–éŸ³é—¨åº—"
            if (kucunData.length > 1) {
                kucunData[1][23] = 'æŠ–éŸ³';     // Xåˆ—ï¼ˆç¬¬24åˆ—ï¼‰
                kucunData[1][24] = 'æŠ–éŸ³é—¨åº—'; // Yåˆ—ï¼ˆç¬¬25åˆ—ï¼‰
            }
            
            // 2. å»ºç«‹"é—¨åº—å"Fåˆ—ï¼ˆæŠ–éŸ³IDï¼‰åˆ°Båˆ—ï¼ˆç¾å¾—å¾—åº—åï¼‰çš„æ˜ å°„
            const douyinIdToMendianName = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const mendianName = storeData.mendianData[i][1]; // Båˆ—ï¼ˆç¾å¾—å¾—åº—åï¼‰
                const douyinId = storeData.mendianData[i][5];     // Fåˆ—ï¼ˆæŠ–éŸ³IDï¼‰
                if (douyinId !== null && String(douyinId).trim() !== '' && mendianName !== null) {
                    douyinIdToMendianName[String(douyinId).trim()] = String(mendianName).trim();
                }
            }
            
            // 3. å»ºç«‹"é—¨åº—å"Båˆ—ï¼ˆç¾å¾—å¾—åº—åï¼‰åˆ°Gåˆ—çš„æ˜ å°„
            const mendianNameToGCol = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const mendianName = storeData.mendianData[i][1]; // Båˆ—ï¼ˆç¾å¾—å¾—åº—åï¼‰
                const gColVal = storeData.mendianData[i][6];     // Gåˆ—
                if (mendianName !== null && String(mendianName).trim() !== '') {
                    mendianNameToGCol[String(mendianName).trim()] = gColVal;
                }
            }
            
            // 4. è¯»å–"æŠ–éŸ³æè´§åˆ¸"æ•°æ®
            const douyinData = getSheetData(workbooks['douyin']);
            
            // 5. å»ºç«‹"ç¾å¾—å¾—åº“å­˜"ä¸­(ä»“åº“åç§°, å•†å“æ¡ç )çš„é›†åˆï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾ï¼ˆå¯¹åº”Pythonç¬¬509-516è¡Œï¼‰
            // æ³¨æ„ï¼šPythonç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯åŸå§‹åº“å­˜æ–‡ä»¶ï¼Œä¸æ˜¯å¤„ç†åçš„æ–‡ä»¶
            const originalKucunData = getSheetData(workbooks['kucun']);
            const kucunBarcodeSet = new Set();
            for (let i = 1; i < originalKucunData.length; i++) {
                const warehouseName = originalKucunData[i][0];  // Aåˆ—ï¼ˆä»“åº“åç§°ï¼‰
                const barcode = originalKucunData[i][3];         // Dåˆ—ï¼ˆå•†å“æ¡ç ï¼‰
                if (warehouseName !== null && barcode !== null) {
                    const key = `${String(warehouseName).trim()}_${String(barcode).trim()}`;
                    kucunBarcodeSet.add(key);
                }
            }
            
            // 6. å¤„ç†æŠ–éŸ³æè´§åˆ¸æ•°æ®ï¼Œå¯¹æ¯”ç¾å¾—å¾—åº“å­˜
            let matchCount = 0;
            for (let i = 1; i < douyinData.length; i++) { // å‡è®¾ä»ç¬¬2è¡Œå¼€å§‹æœ‰æ•°æ®
                const poiId = douyinData[i][5];      // Fåˆ—ï¼ˆPOIIDï¼‰
                const merchantCode = douyinData[i][4]; // Eåˆ—ï¼ˆå•†å®¶ç¼–ç ï¼‰
                
                if (poiId === null || merchantCode === null) {
                    continue;
                }
                
                // æ ¹æ®POIIDæ‰¾åˆ°ç¾å¾—å¾—é—¨åº—å
                const mendianName = douyinIdToMendianName[String(poiId).trim()];
                if (!mendianName) {
                    continue;
                }
                
                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨é‡å¤çš„å•†å“æ¡ç 
                const key = `${mendianName}_${String(merchantCode).trim()}`;
                if (kucunBarcodeSet.has(key)) {
                    matchCount++;
                    
                    // æ‰¾åˆ°é‡å¤ï¼Œåœ¨"ç¾å¾—å¾—åº“å­˜_å¤„ç†ç»“æœ"ä¸­æ ‡è®°
                    for (let j = 1; j < kucunData.length; j++) {
                        const kucunWarehouse = kucunData[j][0]; // Aåˆ—ï¼ˆä»“åº“åç§°ï¼‰
                        const kucunBarcode = kucunData[j][3];    // Dåˆ—ï¼ˆå•†å“æ¡ç ï¼‰
                        
                        if (kucunWarehouse !== null && kucunBarcode !== null &&
                            String(kucunWarehouse).trim() === mendianName &&
                            String(kucunBarcode).trim() === String(merchantCode).trim()) {
                            
                            // æ ‡è®°Xåˆ—ä¸º"æœ‰"
                            kucunData[j][23] = 'æœ‰'; // Xåˆ—
                            
                            // æ ‡è®°Yåˆ—ä¸ºé—¨åº—åGåˆ—çš„å†…å®¹
                            const gColContent = mendianNameToGCol[mendianName] || '';
                            kucunData[j][24] = gColContent; // Yåˆ—
                            break;
                        }
                    }
                }
            }
            
            log(`å·²å®ŒæˆæŠ–éŸ³æè´§åˆ¸ä¸ç¾å¾—å¾—åº“å­˜å¯¹æ¯”å¤„ç†ï¼Œæ ‡è®°äº† ${matchCount} ä¸ªé‡å¤å•†å“`, 'success');
            return kucunData;
        }

        // 9. äº¬ä¸œå¤–å–å¤„ç†ï¼ˆå¯¹åº”Pythonç¬¬640-911è¡Œï¼‰
        async function processJdData(workbooks, storeData, kucunData) {
            log('å¤„ç†äº¬ä¸œå¤–å–æ•°æ®...', 'info');
            
            // æ ‡è®°äº¬ä¸œå¤–å–å•†å“
            const markedKucunData = await markJdGoods(workbooks, kucunData);
            
            // å¤„ç†äº¬ä¸œå¤–å–æ¨¡ç‰ˆæ•°æ®
            const jdTemplateData = await processJdTemplate(workbooks, storeData, markedKucunData);
            
            return { markedKucunData, jdTemplateData };
        }

        // åœ¨ç¾å¾—å¾—åº“å­˜_å¤„ç†ç»“æœä¸­æ ‡è®°äº¬ä¸œå¤–å–
        async function markJdGoods(workbooks, kucunData) {
            log('æ ‡è®°äº¬ä¸œå¤–å–å•†å“...', 'info');
            
            // è®¾ç½®Z2å•å…ƒæ ¼æ ‡é¢˜ï¼ˆçº¢åº•é»‘å­—æ ·å¼ - å¯¹åº”Pythonç¬¬653-655è¡Œï¼‰
            // æ³¨æ„ï¼šJavaScriptç‰ˆæœ¬æ— æ³•ç›´æ¥è®¾ç½®Excelæ ·å¼ï¼Œä½†æ•°æ®é€»è¾‘å®Œå…¨ä¸€è‡´
            if (kucunData.length > 1) {
                kucunData[1][25] = 'äº¬ä¸œå¤–å–'; // Zåˆ—ï¼ˆç¬¬26åˆ—ï¼‰
            }
            
            // è·å–äº¬ä¸œå¤–å–å•†å“åº“Fåˆ—çš„æ‰€æœ‰æ¡ç 
            const jdGoodsData = getSheetData(workbooks['jd-goods']);
            const jdBarcodesSet = new Set();
            for (let i = 1; i < jdGoodsData.length; i++) {
                const val = jdGoodsData[i][5]; // Fåˆ—æ˜¯ç¬¬6åˆ—ï¼ˆç´¢å¼•5ï¼‰
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    jdBarcodesSet.add(String(val).trim());
                }
            }
            
            log(`ä»äº¬ä¸œå¤–å–å•†å“åº“Fåˆ—è¯»å–åˆ° ${jdBarcodesSet.size} ä¸ªæ¡ç `, 'info');
            
            // å¯¹æ¯”ç¾å¾—å¾—åº“å­˜_å¤„ç†ç»“æœDåˆ—å’Œäº¬ä¸œå¤–å–å•†å“åº“Fåˆ—
            let matchCount = 0;
            for (let i = 1; i < kucunData.length; i++) {
                const dVal = kucunData[i][3]; // Dåˆ—ï¼ˆå•†å“æ¡ç ï¼‰
                const zCell = kucunData[i][25]; // Zåˆ—ï¼ˆç¬¬26åˆ—ï¼‰
                
                if (dVal !== null && jdBarcodesSet.has(String(dVal).trim())) {
                    kucunData[i][25] = 'æœ‰'; // Zåˆ—æ ‡è®°"æœ‰"
                    matchCount++;
                }
            }
            
            log(`å·²å®Œæˆäº¬ä¸œå¤–å–æ ‡è®°ï¼šåœ¨Zåˆ—æ ‡è®°äº† ${matchCount} ä¸ªé‡åˆå•†å“`, 'success');
            return kucunData;
        }

        // å¤„ç†äº¬ä¸œå¤–å–æ¨¡ç‰ˆæ•°æ®
        async function processJdTemplate(workbooks, storeData, kucunData) {
            log('å¤„ç†äº¬ä¸œå¤–å–æ¨¡ç‰ˆæ•°æ®...', 'info');
            
            // è¯»å–é—¨åº—åIåˆ—çš„äº¬ä¸œé—¨åº—ç¼–å·
            const jdStoreIds = [];
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const val = storeData.mendianData[i][8]; // Iåˆ—æ˜¯ç¬¬9åˆ—ï¼ˆç´¢å¼•8ï¼‰
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    jdStoreIds.push(String(val).trim());
                }
            }
            
            log(`ä»é—¨åº—åIåˆ—è¯»å–åˆ° ${jdStoreIds.length} ä¸ªäº¬ä¸œé—¨åº—ç¼–å·`, 'info');
            
            // è¯»å–äº¬ä¸œå¤–å–å•†å“åº“Fåˆ—æ•°æ®ï¼ˆä»ç¬¬2è¡Œå¼€å§‹ï¼‰
            const jdGoodsData = getSheetData(workbooks['jd-goods']);
            const jdSkuData = [];
            for (let i = 1; i < jdGoodsData.length; i++) {
                const val = jdGoodsData[i][5]; // Fåˆ—æ˜¯ç¬¬6åˆ—ï¼ˆç´¢å¼•5ï¼‰
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    jdSkuData.push(String(val).trim());
                }
            }
            
            log(`ä»äº¬ä¸œå¤–å–å•†å“åº“Fåˆ—è¯»å–åˆ° ${jdSkuData.length} æ¡æœ‰æ•ˆå•†å®¶SKUæ•°æ®`, 'info');
            
            // è·å–äº¬ä¸œå¤–å–æ¨¡ç‰ˆæ•°æ®å¹¶æ‰©å±•
            const jdTemplateData = getSheetData(workbooks['jd-template']);
            
            // å®ç°ç¬›å¡å°”ç§¯ï¼šæ¯ä¸ªé—¨åº—ç¼–å·å¯¹åº”æ‰€æœ‰å•†å®¶SKU
            let rowIdx = 2; // ä»ç¬¬2è¡Œå¼€å§‹ï¼ˆç´¢å¼•1ï¼‰
            const totalRows = jdStoreIds.length * jdSkuData.length;
            log(`å°†ç”Ÿæˆ ${totalRows} è¡Œæ•°æ®ï¼ˆ${jdStoreIds.length}ä¸ªé—¨åº— Ã— ${jdSkuData.length}ä¸ªSKUï¼‰`, 'info');
            
            for (const storeId of jdStoreIds) {
                for (const skuValue of jdSkuData) {
                    // ç¡®ä¿è¡Œå­˜åœ¨
                    while (jdTemplateData.length <= rowIdx - 1) {
                        jdTemplateData.push(new Array(10).fill('')); // æ‰©å±•è¶³å¤Ÿçš„åˆ—
                    }
                    
                    // Aåˆ—å¡«å†™é—¨åº—ç¼–å·
                    jdTemplateData[rowIdx - 1][0] = storeId;
                    // Cåˆ—å¡«å†™å•†å®¶SKU
                    jdTemplateData[rowIdx - 1][2] = skuValue;
                    rowIdx++;
                }
            }
            
            log(`å·²å®Œæˆäº¬ä¸œå¤–å–æ¨¡ç‰ˆæ•°æ®ç”Ÿæˆï¼š${totalRows} è¡Œ`, 'success');
            
            // åŒæ­¥ç¾å¾—å¾—åº“å­˜åˆ°äº¬ä¸œå¤–å–æ¨¡ç‰ˆEåˆ—
            await syncJdInventory(workbooks, jdTemplateData, storeData, kucunData);
            
            return jdTemplateData;
        }

        // åŒæ­¥ç¾å¾—å¾—åº“å­˜åˆ°äº¬ä¸œå¤–å–æ¨¡ç‰ˆEåˆ—
        async function syncJdInventory(workbooks, jdTemplateData, storeData, kucunData) {
            log('åŒæ­¥åº“å­˜æ•°æ®åˆ°äº¬ä¸œå¤–å–æ¨¡ç‰ˆ...', 'info');
            
            // 1. å»ºç«‹"é—¨åº—å"Båˆ—ï¼ˆç¾å¾—å¾—åº—åï¼‰åˆ°Iåˆ—ï¼ˆäº¬ä¸œé—¨åº—ç¼–å·ï¼‰çš„æ˜ å°„
            const mendianNameToJdId = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const mendianName = storeData.mendianData[i][1]; // Båˆ—ï¼ˆç¾å¾—å¾—åº—åï¼‰
                const jdId = storeData.mendianData[i][8];        // Iåˆ—ï¼ˆäº¬ä¸œé—¨åº—ç¼–å·ï¼‰
                if (mendianName !== null && jdId !== null && 
                    String(mendianName).trim() !== '' && String(jdId).trim() !== '') {
                    mendianNameToJdId[String(mendianName).trim()] = String(jdId).trim();
                }
            }
            
            log(`å»ºç«‹äº† ${Object.keys(mendianNameToJdId).length} ä¸ªé—¨åº—åç§°åˆ°äº¬ä¸œé—¨åº—ç¼–å·çš„æ˜ å°„`, 'info');
            
            // 2. å»ºç«‹"ç¾å¾—å¾—åº“å­˜"ä¸­(ä»“åº“åç§°, å•†å“æ¡ç )åˆ°åº“å­˜æ•°é‡çš„æ˜ å°„ï¼ˆå¯¹åº”Pythonç¬¬749-758è¡Œï¼‰
            // æ³¨æ„ï¼šPythonç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯åŸå§‹åº“å­˜æ–‡ä»¶ï¼Œä¸æ˜¯å¤„ç†åçš„æ–‡ä»¶
            const originalKucunData = getSheetData(workbooks['kucun']);
            const kucunInventoryMap = {};
            for (let i = 1; i < originalKucunData.length; i++) {
                const warehouseName = originalKucunData[i][0];  // Aåˆ—ï¼ˆä»“åº“åç§°ï¼‰
                const barcode = originalKucunData[i][3];         // Dåˆ—ï¼ˆå•†å“æ¡ç ï¼‰
                const stockCount = originalKucunData[i][7];      // Håˆ—ï¼ˆåº“å­˜æ€»æ•°ï¼‰
                if (warehouseName !== null && barcode !== null) {
                    const key = `${String(warehouseName).trim()}_${String(barcode).trim()}`;
                    kucunInventoryMap[key] = stockCount !== null ? stockCount : 0;
                }
            }
            
            log(`å»ºç«‹äº† ${Object.keys(kucunInventoryMap).length} ä¸ªåº“å­˜æ•°æ®æ˜ å°„`, 'info');
            
            // 3. éå†äº¬ä¸œå¤–å–æ¨¡ç‰ˆï¼ŒåŒ¹é…å¹¶åŒæ­¥åº“å­˜æ•°æ®
            let matchedCount = 0;
            for (let i = 1; i < jdTemplateData.length; i++) { // ä»ç¬¬2è¡Œå¼€å§‹
                const jdStoreId = jdTemplateData[i][0]; // Aåˆ—ï¼ˆäº¬ä¸œé—¨åº—ç¼–å·ï¼‰
                const jdSku = jdTemplateData[i][2];     // Cåˆ—ï¼ˆå•†å®¶SKUï¼‰
                
                if (jdStoreId === null || jdSku === null) {
                    continue;
                }
                
                // æ ¹æ®äº¬ä¸œé—¨åº—ç¼–å·æ‰¾åˆ°ç¾å¾—å¾—åº—å
                let mendianName = null;
                for (const [name, id] of Object.entries(mendianNameToJdId)) {
                    if (String(id).trim() === String(jdStoreId).trim()) {
                        mendianName = name;
                        break;
                    }
                }
                
                if (!mendianName) {
                    continue;
                }
                
                // æ ¹æ®ç¾å¾—å¾—åº—åå’ŒSKUæŸ¥æ‰¾åº“å­˜
                const key = `${mendianName}_${String(jdSku).trim()}`;
                const inventory = kucunInventoryMap[key];
                
                if (inventory !== undefined) {
                    // å¡«å†™Eåˆ—ï¼ˆç°è´§åº“å­˜ï¼‰
                    jdTemplateData[i][4] = inventory; // Eåˆ—æ˜¯ç¬¬5åˆ—ï¼ˆç´¢å¼•4ï¼‰
                    matchedCount++;
                }
            }
            
            log(`å·²å®Œæˆåº“å­˜æ•°æ®åŒæ­¥ï¼šåŒ¹é…åˆ° ${matchedCount} æ¡åº“å­˜è®°å½•`, 'success');
            
            // 4. ä¸ºæ²¡æœ‰åº“å­˜æ•°æ®çš„è¡Œå¡«å†™"0"
            let zeroFillCount = 0;
            for (let i = 1; i < jdTemplateData.length; i++) { // ä»ç¬¬2è¡Œå¼€å§‹
                const eVal = jdTemplateData[i][4]; // Eåˆ—ï¼ˆç°è´§åº“å­˜ï¼‰
                if (eVal === null || eVal === undefined || String(eVal).trim() === '') {
                    jdTemplateData[i][4] = 0; // Eåˆ—å¡«å†™0
                    zeroFillCount++;
                }
            }
            log(`ä¸º ${zeroFillCount} è¡Œæ²¡æœ‰åº“å­˜æ•°æ®çš„è®°å½•å¡«å†™äº†0`, 'success');
            
            // 5. æ ¹æ®Eåˆ—åº“å­˜å€¼åœ¨Dåˆ—å¡«å†™é”€å”®çŠ¶æ€
            let availableCount = 0;
            let unavailableCount = 0;
            for (let i = 1; i < jdTemplateData.length; i++) { // ä»ç¬¬2è¡Œå¼€å§‹
                const eVal = jdTemplateData[i][4]; // Eåˆ—ï¼ˆç°è´§åº“å­˜ï¼‰
                const dCell = jdTemplateData[i][3]; // Dåˆ—ï¼ˆé”€å”®çŠ¶æ€ï¼‰
                
                try {
                    // å°è¯•è½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒ
                    if (eVal !== null && eVal !== undefined && String(eVal).trim() !== '') {
                        const stockValue = parseFloat(String(eVal).trim());
                        if (stockValue > 0) {
                            jdTemplateData[i][3] = 'å¯å”®';
                            availableCount++;
                        } else {
                            jdTemplateData[i][3] = 'ä¸å¯å”®';
                            unavailableCount++;
                        }
                    } else {
                        jdTemplateData[i][3] = 'ä¸å¯å”®';
                        unavailableCount++;
                    }
                } catch (e) {
                    // å¦‚æœæ— æ³•è½¬æ¢ä¸ºæ•°å­—ï¼Œé»˜è®¤ä¸ºä¸å¯å”®
                    jdTemplateData[i][3] = 'ä¸å¯å”®';
                    unavailableCount++;
                }
            }
            
            log(`é”€å”®çŠ¶æ€è®¾ç½®ï¼š${availableCount} è¡Œè®¾ä¸º'å¯å”®'ï¼Œ${unavailableCount} è¡Œè®¾ä¸º'ä¸å¯å”®'`, 'success');
        }


        // æ£€æŸ¥å¹¶åˆ†å‰²é¥¿äº†ä¹ˆæ–‡ä»¶
        async function checkAndSplitElemeFile(elemeData) {
            const totalRows = elemeData.length;
            log(`é¥¿äº†ä¹ˆè¡¨æ ¼æ€»è¡Œæ•°ï¼š${totalRows}`, 'info');
            
            if (totalRows > 60000) {
                log('é¥¿äº†ä¹ˆè¡¨æ ¼è¶…è¿‡60000è¡Œï¼Œå¼€å§‹åˆ†å‰²...', 'info');
                
                // åˆ›å»ºç¬¬äºŒä¸ªè¡¨æ ¼ï¼ˆåŒ…å«60001è¡ŒåŠä»¥åçš„æ•°æ®ï¼‰
                const eleme2Data = [];
                
                // å¤åˆ¶å‰ä¸¤è¡Œè¡¨å¤´åˆ°æ–°è¡¨æ ¼
                if (totalRows >= 2) {
                    eleme2Data.push([...elemeData[0]]);
                    eleme2Data.push([...elemeData[1]]);
                }
                
                // å°†ç¬¬60001è¡ŒåŠä»¥åçš„æ•°æ®ç§»åŠ¨åˆ°æ–°è¡¨æ ¼
                for (let i = 60001; i <= totalRows; i++) {
                    if (elemeData[i - 1]) {
                        eleme2Data.push([...elemeData[i - 1]]);
                    }
                }
                
                // åˆ é™¤åŸè¡¨æ ¼ä¸­60001è¡ŒåŠä»¥åçš„å†…å®¹
                elemeData.splice(60000);
                
                // æ·»åŠ ç¬¬äºŒä¸ªæ–‡ä»¶åˆ°ä¸‹è½½åˆ—è¡¨
                const eleme2Workbook = createWorkbook(eleme2Data, 'é¥¿äº†ä¹ˆæ•°æ®2');
                addDownloadItem('é¥¿äº†ä¹ˆ_å¤„ç†å_2.xlsx', eleme2Workbook);
                
                log(`å·²æˆåŠŸåˆ†å‰²é¥¿äº†ä¹ˆè¡¨æ ¼ï¼šåŸè¡¨æ ¼ä¿ç•™å‰60000è¡Œï¼Œç¬¬äºŒä¸ªè¡¨æ ¼åŒ…å«å‰©ä½™${totalRows - 60000}è¡Œ`, 'success');
            } else {
                log('é¥¿äº†ä¹ˆè¡¨æ ¼è¡Œæ•°æœªè¶…è¿‡60000è¡Œï¼Œæ— éœ€åˆ†å‰²', 'info');
            }
        }

        // æ£€æŸ¥å¹¶åˆ†å‰²äº¬ä¸œå¤–å–æ¨¡ç‰ˆæ–‡ä»¶
        async function checkAndSplitJdTemplateFile(jdTemplateData) {
            const totalRows = jdTemplateData.length;
            log(`äº¬ä¸œå¤–å–æ¨¡ç‰ˆæ€»è¡Œæ•°ï¼š${totalRows}`, 'info');
            
            if (totalRows > 100000) {
                log('äº¬ä¸œå¤–å–æ¨¡ç‰ˆè¶…è¿‡100000è¡Œï¼Œå¼€å§‹åˆ†å‰²...', 'info');
                
                // åˆ›å»ºç¬¬äºŒä¸ªè¡¨æ ¼ï¼ˆåŒ…å«100001è¡ŒåŠä»¥åçš„æ•°æ®ï¼‰
                const jdTemplate2Data = [];
                
                // å¤åˆ¶ç¬¬ä¸€è¡Œè¡¨å¤´åˆ°æ–°è¡¨æ ¼
                if (totalRows >= 1) {
                    jdTemplate2Data.push([...jdTemplateData[0]]);
                }
                
                // å°†ç¬¬100001è¡ŒåŠä»¥åçš„æ•°æ®ç§»åŠ¨åˆ°æ–°è¡¨æ ¼
                for (let i = 100001; i <= totalRows; i++) {
                    if (jdTemplateData[i - 1]) {
                        jdTemplate2Data.push([...jdTemplateData[i - 1]]);
                    }
                }
                
                // åˆ é™¤åŸè¡¨æ ¼ä¸­100001è¡ŒåŠä»¥åçš„å†…å®¹
                jdTemplateData.splice(100000);
                
                // æ·»åŠ ç¬¬äºŒä¸ªæ–‡ä»¶åˆ°ä¸‹è½½åˆ—è¡¨
                const jdTemplate2Workbook = createWorkbook(jdTemplate2Data, 'äº¬ä¸œå¤–å–æ¨¡ç‰ˆ2');
                addDownloadItem('äº¬ä¸œå¤–å–æ¨¡ç‰ˆ_å¤„ç†å_2.xlsx', jdTemplate2Workbook);
                
                log(`å·²æˆåŠŸåˆ†å‰²äº¬ä¸œå¤–å–æ¨¡ç‰ˆï¼šåŸè¡¨æ ¼ä¿ç•™å‰100000è¡Œï¼Œç¬¬äºŒä¸ªè¡¨æ ¼åŒ…å«å‰©ä½™${totalRows - 100000}è¡Œ`, 'success');
            } else {
                log('äº¬ä¸œå¤–å–æ¨¡ç‰ˆè¡Œæ•°æœªè¶…è¿‡100000è¡Œï¼Œæ— éœ€åˆ†å‰²', 'info');
            }
        }

        // ç”Ÿæˆç»“æœæ–‡ä»¶ - å®Œæ•´ç‰ˆæœ¬ï¼ŒæŒ‰ç…§Pythoné€»è¾‘ç”Ÿæˆæ‰€æœ‰æ–‡ä»¶
        async function generateResultFiles(workbooks, processedData) {
            log('ç”Ÿæˆç»“æœæ–‡ä»¶...', 'info');
            
            // 1. é—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯_å¤„ç†å.xlsx
            if (processedData.dstData) {
                const dstWorkbook = createWorkbook(processedData.dstData, 'é—¨åº—å•†å“ä¿¡æ¯');
                addDownloadItem('é—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯_å¤„ç†å.xlsx', dstWorkbook);
                log('å·²ç”Ÿæˆé—¨åº—ä¸å•†å“å”®å–ä¿¡æ¯_å¤„ç†å.xlsx', 'success');
            }
            
            // 2. ç¾å¾—å¾—åº“å­˜_å¤„ç†ç»“æœ.xlsx
            if (processedData.kucunData) {
                const kucunWorkbook = createWorkbook(processedData.kucunData, 'ç¾å¾—å¾—åº“å­˜');
                addDownloadItem('ç¾å¾—å¾—åº“å­˜_å¤„ç†ç»“æœ.xlsx', kucunWorkbook);
                log('å·²ç”Ÿæˆç¾å¾—å¾—åº“å­˜_å¤„ç†ç»“æœ.xlsx', 'success');
            }
            
            // 3. é¥¿äº†ä¹ˆ_å¤„ç†å.xlsx
            if (processedData.elemeData) {
                const elemeWorkbook = createWorkbook(processedData.elemeData, 'é¥¿äº†ä¹ˆæ•°æ®');
                addDownloadItem('é¥¿äº†ä¹ˆ_å¤„ç†å.xlsx', elemeWorkbook);
                log('å·²ç”Ÿæˆé¥¿äº†ä¹ˆ_å¤„ç†å.xlsx', 'success');
            }
            
            // 4. æŠ–éŸ³æè´§åˆ¸_å¤„ç†å.xlsx
            if (processedData.douyinData) {
                const douyinWorkbook = createWorkbook(processedData.douyinData, 'æŠ–éŸ³æè´§åˆ¸');
                addDownloadItem('æŠ–éŸ³æè´§åˆ¸_å¤„ç†å.xlsx', douyinWorkbook);
                log('å·²ç”ŸæˆæŠ–éŸ³æè´§åˆ¸_å¤„ç†å.xlsx', 'success');
            }
            
            // 5. äº¬ä¸œå¤–å–æ¨¡ç‰ˆ_å¤„ç†å.xlsx
            if (processedData.jdResult && processedData.jdResult.jdTemplateData) {
                const jdTemplateWorkbook = createWorkbook(processedData.jdResult.jdTemplateData, 'äº¬ä¸œå¤–å–æ¨¡ç‰ˆ');
            addDownloadItem('äº¬ä¸œå¤–å–æ¨¡ç‰ˆ_å¤„ç†å.xlsx', jdTemplateWorkbook);
                log('å·²ç”Ÿæˆäº¬ä¸œå¤–å–æ¨¡ç‰ˆ_å¤„ç†å.xlsx', 'success');
            }
            
            log('æ‰€æœ‰ç»“æœæ–‡ä»¶ç”Ÿæˆå®Œæˆ', 'success');
        }

        // ä¸‹è½½å…¨éƒ¨æ–‡ä»¶ä¸ºZIPå‹ç¼©åŒ…
        async function downloadAllAsZip() {
            if (Object.keys(processedFiles).length === 0) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶ï¼');
                return;
            }

            log('ğŸ“¦ å¼€å§‹åˆ›å»ºZIPå‹ç¼©åŒ…...', 'info');
            
            try {
                // åˆ›å»ºZIPå®ä¾‹
                const zip = new JSZip();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                
                // ä¸ºæ¯ä¸ªæ–‡ä»¶æ·»åŠ åˆ°ZIPä¸­
            Object.keys(processedFiles).forEach(filename => {
                    const workbook = processedFiles[filename];
                    const wbout = XLSX.write(workbook, {bookType: 'xlsx', type: 'array'});
                    zip.file(filename, wbout);
                    log(`ğŸ“ æ·»åŠ æ–‡ä»¶åˆ°å‹ç¼©åŒ…: ${filename}`, 'info');
                });
                
                log('ğŸ“¦ æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶...', 'info');
                
                // ç”ŸæˆZIPæ–‡ä»¶
                const zipBlob = await zip.generateAsync({type: 'blob'});
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Excelå¤„ç†ç»“æœ_${timestamp}.zip`;
                a.click();
                
                // æ¸…ç†URLå¯¹è±¡
                URL.revokeObjectURL(url);
                
                log('âœ… ZIPå‹ç¼©åŒ…ä¸‹è½½å®Œæˆï¼', 'success');
                log(`ğŸ“¦ æ–‡ä»¶åŒ…å« ${Object.keys(processedFiles).length} ä¸ªExcelæ–‡ä»¶`, 'info');
                
            } catch (error) {
                log(`âŒ åˆ›å»ºZIPæ–‡ä»¶å¤±è´¥: ${error.message}`, 'error');
                console.error('ZIPåˆ›å»ºé”™è¯¯:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“Š Excelæ•°æ®å¤„ç†å·¥å…·å·²å°±ç»ª', 'success');
            log('è¯·æŒ‰é¡ºåºä¸Šä¼ æ‰€éœ€çš„9ä¸ªExcelæ–‡ä»¶', 'info');
        });
    </script>
</body>
</html>
