<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel数据处理工具 - 网页版</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📊</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1200px; margin: 0 auto; background: white;
            border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden; display: flex; flex-direction: column;
            min-height: calc(100vh - 40px);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; text-align: center;
        }
        .header h1 { font-size: 32px; font-weight: 600; margin-bottom: 10px; }
        .main-content { flex: 1; padding: 40px; }
        .upload-section {
            background: #f8f9fa; border-radius: 12px; padding: 30px;
            margin-bottom: 30px; border: 2px dashed #cbd5e0;
            transition: all 0.3s;
        }
        .upload-section:hover { border-color: #667eea; background: #f7fafc; }
        .file-input-group {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .file-input-item { display: flex; flex-direction: column; }
        .file-input-item label { font-weight: 500; color: #4a5568; margin-bottom: 8px; }
        .file-input { position: absolute; left: -9999px; }
        .file-input-button {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 12px 20px; background: #667eea; color: white;
            border: none; border-radius: 8px; cursor: pointer;
            transition: all 0.3s; font-size: 14px; font-weight: 500;
            width: 100%; justify-content: center;
        }
        .file-input-button:hover { background: #5568d3; transform: translateY(-2px); }
        .file-name { margin-top: 8px; font-size: 12px; color: #666; word-break: break-all; }
        .file-name.has-file { color: #48bb78; font-weight: 500; }
        .process-section { text-align: center; margin: 40px 0; }
        .btn {
            padding: 15px 30px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 500; cursor: pointer;
            transition: all 0.3s; display: inline-flex; align-items: center;
            gap: 10px; margin: 0 10px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .progress-section { margin: 30px 0; display: none; }
        .progress-bar {
            width: 100%; height: 20px; background: #e2e8f0;
            border-radius: 10px; overflow: hidden; margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%; transition: width 0.3s;
        }
        .progress-text { text-align: center; color: #666; font-size: 14px; }
        .results-section { margin-top: 30px; display: none; }
        .results-section h3 { color: #2d3748; margin-bottom: 20px; }
        .download-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .download-item {
            background: #f8f9fa; padding: 15px; border-radius: 8px;
            border: 1px solid #e2e8f0; display: flex;
            justify-content: space-between; align-items: center;
        }
        .download-btn {
            padding: 8px 16px; background: #48bb78; color: white;
            border: none; border-radius: 6px; cursor: pointer;
            font-size: 12px; transition: background 0.3s;
        }
        .download-btn:hover { background: #38a169; }
        .log-section { margin-top: 30px; display: none; }
        .log-container {
            background: #1a202c; color: #e2e8f0; padding: 20px;
            border-radius: 8px; font-family: 'Courier New', monospace;
            font-size: 13px; line-height: 1.5; max-height: 300px; overflow-y: auto;
        }
        .log-entry { margin-bottom: 5px; }
        .log-entry.success { color: #48bb78; }
        .log-entry.error { color: #f56565; }
        .log-entry.info { color: #4299e1; }
        .instructions {
            background: #edf2f7; padding: 20px; border-radius: 8px; margin-bottom: 30px;
        }
        .instructions h3 { color: #2d3748; margin-bottom: 15px; }
        .instructions ul { list-style: none; padding: 0; }
        .instructions li {
            margin: 8px 0; padding-left: 20px; position: relative;
            color: #4a5568;
        }
        .instructions li:before {
            content: "•"; position: absolute; left: 0;
            color: #667eea; font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Excel数据处理工具</h1>
            <p>网页版 - 支持多文件批量处理和智能数据同步</p>
        </div>
        <div class="main-content">
            <div class="instructions">
                <h3>💡 使用说明</h3>
                <ul>
                    <li>选择一个包含Excel文件的文件夹</li>
                    <li>文件夹中的Excel文件需要以数字1-9开头命名</li>
                    <li>系统将自动识别并匹配对应的文件类型</li>
                    <li>处理完成后可下载结果文件</li>
                    <li>支持大文件自动分割（超过行数限制时）</li>
                </ul>
            </div>
            <div class="upload-section">
                <h2>📁 文件夹上传</h2>
                <div style="text-align: center; margin-bottom: 20px;">
                    <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;" accept=".xlsx,.xls">
                    <button class="btn btn-primary" onclick="document.getElementById('folderInput').click()" style="font-size: 18px; padding: 20px 40px;">
                        📂 选择包含Excel文件的文件夹
                    </button>
                    <div style="margin-top: 15px; color: #666; font-size: 14px;">
                        请确保文件夹中的Excel文件以数字1-9开头命名（如：1美得得库存.xlsx, 2门店名.xlsx等）
                    </div>
                </div>
                
                <div id="fileMapping" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: #2d3748;">📋 文件识别结果</h3>
                    <div class="file-mapping-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px;">
                        <div class="mapping-item" id="mapping-1" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">1️⃣ 美得得库存</div>
                                    <div id="file-1-name" style="font-size: 12px; color: #666; margin-top: 5px;">未找到</div>
                                </div>
                                <div id="file-1-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">缺失</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-2" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">2️⃣ 门店名</div>
                                    <div id="file-2-name" style="font-size: 12px; color: #666; margin-top: 5px;">未找到</div>
                                </div>
                                <div id="file-2-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">缺失</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-3" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">3️⃣ 美团商品库</div>
                                    <div id="file-3-name" style="font-size: 12px; color: #666; margin-top: 5px;">未找到</div>
                                </div>
                                <div id="file-3-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">缺失</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-4" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">4️⃣ 门店与商品售卖信息</div>
                                    <div id="file-4-name" style="font-size: 12px; color: #666; margin-top: 5px;">未找到</div>
                                </div>
                                <div id="file-4-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">缺失</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-5" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">5️⃣ 饿了么</div>
                                    <div id="file-5-name" style="font-size: 12px; color: #666; margin-top: 5px;">未找到</div>
                                </div>
                                <div id="file-5-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">缺失</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-6" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">6️⃣ 饿了么商品库</div>
                                    <div id="file-6-name" style="font-size: 12px; color: #666; margin-top: 5px;">未找到</div>
                                </div>
                                <div id="file-6-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">缺失</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-7" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">7️⃣ 抖音提货券</div>
                                    <div id="file-7-name" style="font-size: 12px; color: #666; margin-top: 5px;">未找到</div>
                                </div>
                                <div id="file-7-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">缺失</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-8" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">8️⃣ 京东外卖模版</div>
                                    <div id="file-8-name" style="font-size: 12px; color: #666; margin-top: 5px;">未找到</div>
                                </div>
                                <div id="file-8-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">缺失</div>
                            </div>
                        </div>
                        <div class="mapping-item" id="mapping-9" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">9️⃣ 京东外卖商品库</div>
                                    <div id="file-9-name" style="font-size: 12px; color: #666; margin-top: 5px;">未找到</div>
                                </div>
                                <div id="file-9-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f56565; color: white;">缺失</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="file-input-group" style="display: none;">
                    <div class="file-input-item">
                        <label>美得得库存.xlsx</label>
                        <input type="file" class="file-input" id="kucun" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('kucun').click()">📊 选择文件</button>
                        <div class="file-name" id="kucun-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>门店名.xlsx</label>
                        <input type="file" class="file-input" id="mendian" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('mendian').click()">🏪 选择文件</button>
                        <div class="file-name" id="mendian-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>美团商品库.xlsx</label>
                        <input type="file" class="file-input" id="mtwm-goods" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('mtwm-goods').click()">🛒 选择文件</button>
                        <div class="file-name" id="mtwm-goods-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>门店与商品售卖信息.xlsx</label>
                        <input type="file" class="file-input" id="dst" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('dst').click()">📋 选择文件</button>
                        <div class="file-name" id="dst-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>饿了么.xlsx</label>
                        <input type="file" class="file-input" id="eleme" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('eleme').click()">🍜 选择文件</button>
                        <div class="file-name" id="eleme-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>饿了么商品库.xlsx</label>
                        <input type="file" class="file-input" id="eleme-goods" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('eleme-goods').click()">🛍️ 选择文件</button>
                        <div class="file-name" id="eleme-goods-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>抖音提货券.xlsx</label>
                        <input type="file" class="file-input" id="douyin" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('douyin').click()">🎵 选择文件</button>
                        <div class="file-name" id="douyin-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>京东外卖模版.xlsx</label>
                        <input type="file" class="file-input" id="jd-template" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('jd-template').click()">🛒 选择文件</button>
                        <div class="file-name" id="jd-template-name"></div>
                    </div>
                    <div class="file-input-item">
                        <label>京东外卖商品库.xlsx</label>
                        <input type="file" class="file-input" id="jd-goods" accept=".xlsx">
                        <button class="file-input-button" onclick="document.getElementById('jd-goods').click()">📦 选择文件</button>
                        <div class="file-name" id="jd-goods-name"></div>
                    </div>
                </div>
            </div>
            <div class="process-section">
                <button class="btn btn-primary" onclick="processFiles()" id="processBtn">🚀 开始处理</button>
                <button class="btn btn-success" onclick="downloadAllAsZip()" id="downloadAllBtn" style="display: none;">📦 打包下载全部</button>
            </div>
            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">准备开始处理...</div>
            </div>
            <div class="results-section" id="resultsSection">
                <h3>📋 处理结果</h3>
                <div class="download-list" id="downloadList"></div>
            </div>
            <div class="log-section" id="logSection">
                <h3>📝 处理日志</h3>
                <div class="log-container" id="logContainer"></div>
            </div>
        </div>
    </div>
    <script>
        // 全局变量
        let uploadedFiles = {};
        let processedFiles = {};
        let fileMapping = {
            '1': 'kucun',
            '2': 'mendian', 
            '3': 'mtwm-goods',
            '4': 'dst',
            '5': 'eleme',
            '6': 'eleme-goods',
            '7': 'douyin',
            '8': 'jd-template',
            '9': 'jd-goods'
        };
        let fileNames = {
            '1': '美得得库存',
            '2': '门店名',
            '3': '美团商品库', 
            '4': '门店与商品售卖信息',
            '5': '饿了么',
            '6': '饿了么商品库',
            '7': '抖音提货券',
            '8': '京东外卖模版',
            '9': '京东外卖商品库'
        };

        // 文件夹上传监听器
        document.getElementById('folderInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            log(`📂 选择了文件夹，包含 ${files.length} 个文件`, 'info');
            
            // 重置文件映射显示
            resetFileMapping();
            
            // 处理文件
            files.forEach(file => {
                if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                    const firstChar = file.name.charAt(0);
                    if (fileMapping[firstChar]) {
                        uploadedFiles[fileMapping[firstChar]] = file;
                        updateFileMapping(firstChar, file.name);
                        log(`✅ 识别文件: ${file.name} → ${fileNames[firstChar]}`, 'success');
                    } else {
                        log(`⚠️ 无法识别文件: ${file.name} (文件名不是以1-9开头)`, 'warning');
                    }
                }
            });
            
            // 显示文件映射结果
            document.getElementById('fileMapping').style.display = 'block';
            
            // 检查是否所有必需文件都已上传
            const missingFiles = Object.keys(fileMapping).filter(num => !uploadedFiles[fileMapping[num]]);
            if (missingFiles.length === 0) {
                log('✅ 所有必需文件已找到，可以开始处理', 'success');
            } else {
                log(`⚠️ 缺少文件: ${missingFiles.map(num => fileNames[num]).join(', ')}`, 'warning');
            }
        });

        // 重置文件映射显示
        function resetFileMapping() {
            for (let i = 1; i <= 9; i++) {
                document.getElementById(`file-${i}-name`).textContent = '未找到';
                document.getElementById(`file-${i}-status`).textContent = '缺失';
                document.getElementById(`file-${i}-status`).style.background = '#f56565';
                document.getElementById(`mapping-${i}`).style.borderColor = '#e2e8f0';
            }
        }

        // 更新文件映射显示
        function updateFileMapping(number, fileName) {
            document.getElementById(`file-${number}-name`).textContent = fileName;
            document.getElementById(`file-${number}-status`).textContent = '已找到';
            document.getElementById(`file-${number}-status`).style.background = '#48bb78';
            document.getElementById(`mapping-${number}`).style.borderColor = '#48bb78';
        }

        // 日志函数
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logSection = document.getElementById('logSection');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            logSection.style.display = 'block';
        }

        // 更新进度
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // 显示进度条
        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('processBtn').disabled = true;
        }

        // 隐藏进度条
        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
        }

        // 读取Excel文件 - 改进版本，提高兼容性
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        
                        // 使用更宽松的读取选项提高兼容性
                        const workbook = XLSX.read(data, {
                            type: 'array',
                            cellDates: false,
                            cellNF: false,
                            cellText: false,
                            raw: false,
                            dateNF: 'yyyy-mm-dd',
                            sheetStubs: true,
                            bookDeps: false,
                            bookProps: false,
                            bookSheets: false,
                            bookVBA: false,
                            password: '',
                            WTF: false
                        });
                        
                        resolve(workbook);
                    } catch (error) {
                        log(`读取文件 ${file.name} 时出错: ${error.message}`, 'error');
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // 创建工作簿
        function createWorkbook(data, sheetName = 'Sheet1') {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            return wb;
        }

        // 获取工作表数据 - 改进版本，确保读取所有列
        function getSheetData(workbook, sheetName = null) {
            const sheet = sheetName ? workbook.Sheets[sheetName] : workbook.Sheets[workbook.SheetNames[0]];
            
            // 获取工作表范围
            let range = XLSX.utils.decode_range(sheet['!ref']);
            
            // 强制扩展范围，确保至少读取到第10列
            range.e.c = Math.max(range.e.c, 10);
            
            // 重新设置范围
            sheet['!ref'] = XLSX.utils.encode_range(range);
            
            // 使用更可靠的方法读取数据
            const data = [];
            for (let row = range.s.r; row <= range.e.r; row++) {
                const rowData = [];
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({r: row, c: col});
                    const cell = sheet[cellAddress];
                    rowData.push(cell ? cell.v : '');
                }
                data.push(rowData);
            }
            
            return data;
        }

        // 下载文件
        function downloadFile(workbook, filename) {
            const wbout = XLSX.write(workbook, {bookType: 'xlsx', type: 'array'});
            const blob = new Blob([wbout], {type: 'application/octet-stream'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 添加下载项到结果列表
        function addDownloadItem(filename, workbook) {
            const downloadList = document.getElementById('downloadList');
            const item = document.createElement('div');
            item.className = 'download-item';
            
            const wbout = XLSX.write(workbook, {bookType: 'xlsx', type: 'array'});
            const blob = new Blob([wbout], {type: 'application/octet-stream'});
            const size = (blob.size / 1024).toFixed(1) + ' KB';
            
            item.innerHTML = `
                <div class="file-info">
                    <div class="file-name">${filename}</div>
                    <div class="file-size">大小: ${size}</div>
                </div>
                <button class="download-btn" onclick="downloadFile(processedFiles['${filename}'], '${filename}')">下载</button>
            `;
            
            downloadList.appendChild(item);
            processedFiles[filename] = workbook;
        }

        // 主要处理函数 - 按照Python逻辑完整实现
        async function processFiles() {
            const missingFiles = Object.keys(fileMapping).filter(num => !uploadedFiles[fileMapping[num]]);
            if (missingFiles.length > 0) {
                const missingFileNames = missingFiles.map(num => fileNames[num]);
                alert(`请先上传所有必需的文件！\n缺少的文件：${missingFileNames.join(', ')}`);
                return;
            }

            showProgress();
            log('🚀 开始处理Excel文件...', 'info');

            try {
                updateProgress(5, '正在读取Excel文件...');
                const workbooks = {};
                for (const [id, file] of Object.entries(uploadedFiles)) {
                    log(`读取文件: ${file.name}`, 'info');
                    workbooks[id] = await readExcelFile(file);
                }

                updateProgress(10, '处理门店数据...');
                const storeData = await processStoreData(workbooks);

                updateProgress(15, '处理商品数据...');
                const goodsData = await processGoodsData(workbooks);

                updateProgress(20, '处理门店与商品售卖信息...');
                const dstData = await processDstData(workbooks, storeData, goodsData);

                updateProgress(30, '处理美得得库存数据...');
                const kucunData = await processKucunData(workbooks, storeData);

                updateProgress(35, '标记U列...');
                const markedKucunData = await markUColumn(workbooks, goodsData, kucunData);

                updateProgress(40, '同步库存数据...');
                const finalDstData = await syncInventoryData(workbooks, storeData, dstData, markedKucunData);

                updateProgress(50, '处理饿了么数据...');
                const elemeData = await processElemeData(workbooks, storeData, markedKucunData);

                updateProgress(55, '检查饿了么文件分割...');
                await checkAndSplitElemeFile(elemeData);

                updateProgress(60, '处理抖音提货券数据...');
                const douyinData = await processDouyinData(workbooks, storeData, markedKucunData);

                updateProgress(65, '处理抖音提货券与美得得库存对比...');
                const finalKucunData = await processDouyinComparison(workbooks, storeData, markedKucunData);

                updateProgress(70, '处理京东外卖数据...');
                const jdResult = await processJdData(workbooks, storeData, finalKucunData);

                updateProgress(75, '检查京东外卖模版文件分割...');
                await checkAndSplitJdTemplateFile(jdResult.jdTemplateData);

                updateProgress(85, '生成结果文件...');
                await generateResultFiles(workbooks, {
                    storeData,
                    goodsData,
                    dstData: finalDstData,
                    kucunData: finalKucunData,
                    elemeData,
                    douyinData,
                    jdResult
                });

                updateProgress(100, '处理完成！');
                log('✅ 所有文件处理完成！', 'success');

                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('downloadAllBtn').style.display = 'inline-flex';
                hideProgress();

            } catch (error) {
                log(`❌ 处理过程中出现错误: ${error.message}`, 'error');
                console.error('处理错误:', error);
                hideProgress();
            }
        }

        // 1. 读取门店ID（对应Python第31-38行）
        async function processStoreData(workbooks) {
            log('处理门店数据...', 'info');
            const mendianData = getSheetData(workbooks['mendian']);
            
            const mendianIds = [];
            // 从第2行开始，读取C列（第3列）
            for (let i = 1; i < mendianData.length; i++) {
                const val = mendianData[i][2]; // C列
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    mendianIds.push(String(val).trim());
                }
            }
            
            log(`找到 ${mendianIds.length} 个门店ID`, 'success');
            return { mendianIds, mendianData };
        }

        // 2. 读取美团商品库B列（从B3开始），并同步E、K、A、T列（对应Python第40-61行）
        async function processGoodsData(workbooks) {
            log('处理商品数据...', 'info');
            const goodsData = getSheetData(workbooks['mtwm-goods']);
            const goodsInfo = [];
            
            // 从第3行开始，适应实际文件结构
            for (let i = 2; i < goodsData.length; i++) {
                const bVal = goodsData[i][1];  // B列（条码）
                const eVal = goodsData[i][4];  // E列（可能为空）
                const oVal = goodsData[i][10]; // K列（可能为空）
                const aVal = goodsData[i][0];  // A列（sku_id）
                const tVal = goodsData[i][19]; // T列（可能为空）
                
                // 检查B列是否有有效条码数据
                if (bVal !== null && bVal !== undefined && 
                    String(bVal).trim() !== '' && 
                    !String(bVal).includes('条形码为国家编码网收录的条码') &&
                    !String(bVal).includes('条形码') && // 排除标题行
                    String(bVal).trim().length >= 8) { // 确保是有效的条码长度
                    
                    goodsInfo.push({
                        barcode: String(bVal).trim(),
                        e_col: eVal || '', // 如果E列为空，使用空字符串
                        o_col: oVal || '', // 如果K列为空，使用空字符串
                        a_col: aVal || '', // A列数据
                        t_col: tVal || ''  // 如果T列为空，使用空字符串
                    });
                }
            }
            
            log(`找到 ${goodsInfo.length} 个商品信息`, 'success');
            return goodsInfo;
        }

        // 3. 处理门店与商品售卖信息（对应Python第63-82行）
        async function processDstData(workbooks, storeData, goodsData) {
            log('处理门店与商品售卖信息...', 'info');
            const dstData = getSheetData(workbooks['dst']);
            
            // 从D5开始粘贴，实现笛卡尔积
            let rowIdx = 5; // 从第5行开始（索引为4）
            
            for (const mendianId of storeData.mendianIds) {
                for (const info of goodsData) {
                    // 确保行存在，如果不够就扩展
                    while (dstData.length <= rowIdx - 1) {
                        dstData.push(new Array(20).fill('')); // 扩展足够的列
                    }
                    
                    dstData[rowIdx - 1][0] = mendianId;           // A列写门店ID
                    dstData[rowIdx - 1][3] = info.barcode;        // D列写条码
                    dstData[rowIdx - 1][1] = info.e_col;          // B列写美团商品库E列
                    dstData[rowIdx - 1][2] = info.o_col;          // C列写美团商品库K列
                    dstData[rowIdx - 1][4] = info.a_col;          // E列写美团商品库A列
                    // J列不再填写（Python注释掉了）
                    
                    if (info.barcode) {  // D列有内容
                        dstData[rowIdx - 1][5] = 0;              // F列写0
                    }
                    rowIdx++;
                }
            }
            
            log('已完成门店ID与商品条码的批量粘贴', 'success');
            return dstData;
        }

        // 4. 处理美得得库存（对应Python第84-130行）
        async function processKucunData(workbooks, storeData) {
            log('处理美得得库存数据...', 'info');
            const kucunData = getSheetData(workbooks['kucun']);
            const processedKucunData = kucunData.map(row => [...row]);
            
            // 建立"门店名"B列到A列和D列的映射
            const bToA = {};
            const bToD = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const mendianA = storeData.mendianData[i][0];  // A列
                const mendianB = storeData.mendianData[i][1];  // B列
                const mendianD = storeData.mendianData[i][3];  // D列
                const key = mendianB !== null ? String(mendianB).trim() : '';
                if (key) {
                    bToA[key] = mendianA;
                    bToD[key] = mendianD;
                }
            }
            
            // 设置V2、W2单元格标题
            if (processedKucunData.length > 1) {
                processedKucunData[1][21] = '美团店名'; // V列
                processedKucunData[1][22] = '饿了么';    // W列
            }
            
            // 在V、W列写新名字，A列内容不变
            for (let i = 1; i < processedKucunData.length; i++) {
                const cell = processedKucunData[i][0]; // A列
                const key = cell !== null ? String(cell).trim() : '';
                
                if (key && bToA[key]) {
                    processedKucunData[i][21] = bToA[key]; // V列
                }
                if (key && bToD[key]) {
                    processedKucunData[i][22] = bToD[key]; // W列
                }
            }
            
            log('已生成新表格并完成A列替换', 'success');
            return processedKucunData;
        }

        // 5. 对比美得得库存D列和商品库B列，在U列标记（对应Python第132-158行）
        async function markUColumn(workbooks, goodsData, kucunData) {
            log('标记U列...', 'info');
            
            // 获取商品库所有条码
            const goodsBarcodesSet = new Set();
            for (const info of goodsData) {
                goodsBarcodesSet.add(info.barcode);
            }
            
            // 设置U列标题
            if (kucunData.length > 1) {
                kucunData[1][20] = '美团外卖/饿了么'; // U列
            }
            
            // 遍历D列，从第2行开始
            for (let i = 1; i < kucunData.length; i++) {
                const dVal = kucunData[i][3]; // D列
                if (dVal !== null && goodsBarcodesSet.has(String(dVal).trim())) {
                    kucunData[i][20] = '有'; // U列
                }
            }
            
            log('已完成U列标记', 'success');
            return kucunData;
        }


        // 6. 库存同步逻辑（对应Python第160-240行）
        async function syncInventoryData(workbooks, storeData, dstData, kucunData) {
            log('同步库存数据...', 'info');
            
            // 1. 读取"门店名"A列->C列（门店名->门店ID）映射
            const mendianNameToId = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const name = storeData.mendianData[i][0];  // A列
                const id = storeData.mendianData[i][2];    // C列
                if (name !== null && String(name).trim() !== '' && id !== null) {
                    mendianNameToId[String(name).trim()] = String(id).trim();
                }
            }
            
            // 2. 读取"门店与商品售卖信息"所有行，建立(门店ID, 条码)到行号的映射
            const dstIdBarcodeToRow = {};
            for (let i = 4; i < dstData.length; i++) { // 从第5行开始
                const dstId = dstData[i][0];    // A列
                const dstBarcode = dstData[i][3]; // D列
                if (dstId !== null && dstBarcode !== null) {
                    const key = `${String(dstId).trim()}_${String(dstBarcode).trim()}`;
                    dstIdBarcodeToRow[key] = i; // 存储行索引
                }
            }
            
            // 3. 遍历美得得库存，U列为"有"的行
            let syncCount = 0;
            for (let i = 1; i < kucunData.length; i++) {
                const uVal = kucunData[i][20]; // U列
                if (uVal === '有') {
                    const kucunMendian = kucunData[i][21]; // V列（门店名）
                    const kucunBarcode = kucunData[i][3];  // D列（条码）
                    const kucunKucun = kucunData[i][7];    // H列（库存数量）
                    
                    if (kucunMendian === null || kucunBarcode === null) {
                        continue;
                    }
                    
                    const mendianId = mendianNameToId[String(kucunMendian).trim()];
                    if (!mendianId) {
                        continue;
                    }
                    
                    // 查找"门店与商品售卖信息"中对应的行
                    const key = `${mendianId}_${String(kucunBarcode).trim()}`;
                    const dstRowIdx = dstIdBarcodeToRow[key];
                    if (dstRowIdx !== undefined) {
                        dstData[dstRowIdx][11] = kucunKucun; // L列（第12列）
                        syncCount++;
                    }
                }
            }
            
            log(`已完成库存数量同步到门店与商品售卖信息L列，同步了 ${syncCount} 条记录`, 'success');
            
            // 4. 遍历"门店与商品售卖信息"，D列有内容但L列没有的，在L列标记为"0"
            let zeroFillCount = 0;
            for (let i = 4; i < dstData.length; i++) { // 从第5行开始
                const dVal = dstData[i][3];  // D列
                const lVal = dstData[i][11]; // L列
                if (dVal !== null && String(dVal).trim() !== '' && 
                    (lVal === null || lVal === undefined || String(lVal).trim() === '')) {
                    dstData[i][11] = 0; // L列写0
                    zeroFillCount++;
                }
            }
            log(`已完成L列空缺补零，补零了 ${zeroFillCount} 条记录`, 'success');
            
            // 5. 将"门店与商品售卖信息"L列小于0的都改成0
            let negativeCount = 0;
            for (let i = 4; i < dstData.length; i++) { // 从第5行开始
                const lVal = dstData[i][11]; // L列
                try {
                    if (lVal !== null && lVal !== undefined && String(lVal).trim() !== '' && parseFloat(lVal) < 0) {
                        dstData[i][11] = 0;
                        negativeCount++;
                    }
                } catch (e) {
                    // 如果不是数字，跳过
                }
            }
            log(`已完成L列小于0的数值归零，归零了 ${negativeCount} 条记录`, 'success');
            
            // 6. 如果L列库存数据为0，F列填写为1
            let fColumnFillCount = 0;
            for (let i = 4; i < dstData.length; i++) { // 从第5行开始
                const lVal = dstData[i][11]; // L列（库存数量）
                try {
                    if (lVal !== null && lVal !== undefined && String(lVal).trim() !== '' && parseFloat(lVal) === 0) {
                        dstData[i][5] = 1; // F列写1
                        fColumnFillCount++;
                    }
                } catch (e) {
                    // 如果不是数字，跳过
                }
            }
            log(`已完成L列库存为0时F列填写1的处理，处理了 ${fColumnFillCount} 条记录`, 'success');
            
            // 7. 如果A列有内容但C列没有内容，在C列填写"个"
            let unitFillCount = 0;
            for (let i = 4; i < dstData.length; i++) { // 从第5行开始
                const aVal = dstData[i][0]; // A列（门店ID）
                const cVal = dstData[i][2]; // C列
                
                if (aVal !== null && String(aVal).trim() !== '' && 
                    (cVal === null || cVal === undefined || String(cVal).trim() === '')) {
                    dstData[i][2] = '个'; // C列填写"个"
                    unitFillCount++;
                }
            }
            log(`已完成C列空缺填充，填充了 ${unitFillCount} 条记录`, 'success');
            
            return dstData;
        }

        // 7. 饿了么数据处理（对应Python第242-378行）
        async function processElemeData(workbooks, storeData, kucunData) {
            log('处理饿了么数据...', 'info');
            
            // 读取饿了么门店ID（E列，第5列）
            const elemeIds = [];
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const val = storeData.mendianData[i][4]; // E列
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    elemeIds.push(String(val).trim());
                }
            }
            
            // 读取饿了么商品库数据
            const elemeGoodsData = getSheetData(workbooks['eleme-goods']);
            const barcodes = [];
            const eColVals = [];
            
            // 从饿了么商品库读取条码（A列，从A2开始）
            for (let i = 1; i < elemeGoodsData.length; i++) {
                const bVal = elemeGoodsData[i][0]; // A列
                barcodes.push(bVal !== null ? String(bVal).trim() : '');
            }
            
            // 从饿了么商品库读取B列内容（从B2开始）
            for (let i = 1; i < elemeGoodsData.length; i++) {
                const eVal = elemeGoodsData[i][1]; // B列
                eColVals.push(eVal !== null ? String(eVal).trim() : '');
            }
            
            // 获取饿了么表格数据并扩展
            const elemeData = getSheetData(workbooks['eleme']);
            
            // 从第3行开始批量写入
            let rowIdx = 3; // 从第3行开始（索引为2）
            
            for (const elemeId of elemeIds) {
                for (let i = 0; i < barcodes.length; i++) {
                    // 确保行存在
                    while (elemeData.length <= rowIdx - 1) {
                        elemeData.push(new Array(15).fill('')); // 扩展足够的列
                    }
                    
                    elemeData[rowIdx - 1][0] = elemeId;           // A列：门店ID
                    elemeData[rowIdx - 1][2] = barcodes[i];       // C列：条码
                    elemeData[rowIdx - 1][3] = eColVals[i];       // D列：饿了么商品库B列内容
                    rowIdx++;
                }
            }
            
            log(`已将商品库内容批量复制到饿了么表格，生成了 ${rowIdx - 3} 行数据`, 'success');
            
            // 同步美得得库存到饿了么H列，并A列有内容的J列写"上架"
            await syncElemeInventory(elemeData, storeData, kucunData);
            
            // 根据饿了么A列门店ID，从门店名表获取D列内容填写到饿了么B列
            await fillElemeStoreNames(elemeData, storeData);
            
            // 识别H列库存为"0"时，在J列填写"下架"
            await markElemeOffline(elemeData);
            
            return elemeData;
        }

        // 同步美得得库存到饿了么H列
        async function syncElemeInventory(elemeData, storeData, kucunData) {
            log('同步库存到饿了么表格...', 'info');
            
            // 1. 用"门店名.xlsx"D列（饿了么店名）和E列（饿了么ID）建立映射
            const elemeNameToId = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const elemeName = storeData.mendianData[i][3]; // D列（饿了么店名）
                const elemeId = storeData.mendianData[i][4];   // E列（饿了么门店ID）
                if (elemeName !== null && String(elemeName).trim() !== '' && elemeId !== null) {
                    elemeNameToId[String(elemeName).trim()] = String(elemeId).trim();
                }
            }
            
            // 2. 在"饿了么.xlsx"中，建立(门店ID, 条码)到行的映射
            const elemeIdBarcodeToRow = {};
            for (let i = 2; i < elemeData.length; i++) { // 从第3行开始
                const elemeId = elemeData[i][0];    // A列（饿了么门店ID）
                const elemeBarcode = elemeData[i][2]; // C列（条码）
                if (elemeId !== null && elemeBarcode !== null) {
                    const key = `${String(elemeId).trim()}_${String(elemeBarcode).trim()}`;
                    elemeIdBarcodeToRow[key] = i; // 存储行索引
                }
            }
            
            // 3. 遍历所有行，写入库存到"饿了么.xlsx"H列（对应Python第312-325行）
            let syncCount = 0;
            for (let i = 1; i < kucunData.length; i++) {
                const elemeName = kucunData[i][22]; // W列（第23列，饿了么店名）
                const barcode = kucunData[i][3];    // D列（第4列，条码）
                const kucunKucun = kucunData[i][7]; // H列（第8列，库存数量）
                
                if (elemeName === null || barcode === null) {
                    continue;
                }
                
                const elemeId = elemeNameToId[String(elemeName).trim()];
                if (!elemeId) {
                    continue;
                }
                
                const key = `${elemeId}_${String(barcode).trim()}`;
                const elemeRowIdx = elemeIdBarcodeToRow[key];
                if (elemeRowIdx !== undefined) {
                    elemeData[elemeRowIdx][7] = kucunKucun; // H列（第8列）
                    syncCount++;
                }
            }
            
            log(`已完成库存同步到饿了么H列，同步了 ${syncCount} 条记录`, 'success');
            
            // 4. A列有内容的，J列写"上架"
            for (let i = 2; i < elemeData.length; i++) { // 从第3行开始
                const aVal = elemeData[i][0]; // A列
                if (aVal !== null && String(aVal).trim() !== '') {
                    elemeData[i][9] = '上架'; // J列（第10列）
                }
            }
            
            // 5. 只有A列有内容的，H列才要补0
            for (let i = 2; i < elemeData.length; i++) { // 从第3行开始
                const aVal = elemeData[i][0]; // A列
                const hVal = elemeData[i][7]; // H列
                if (aVal !== null && String(aVal).trim() !== '') {
                    if (hVal === null || hVal === undefined || String(hVal).trim() === '') {
                        elemeData[i][7] = 0; // H列写0
                    }
                }
            }
            
            log('已完成饿了么表格H列空缺补零（仅A列有内容的行）', 'success');
        }

        // 根据饿了么A列门店ID填写B列店名
        async function fillElemeStoreNames(elemeData, storeData) {
            log('填写饿了么店名...', 'info');
            
            // 1. 建立"门店名.xlsx"E列（饿了么门店ID）到D列（饿了么店名）的映射
            const elemeIdToName = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const elemeId = storeData.mendianData[i][4];    // E列（饿了么门店ID）
                const elemeName = storeData.mendianData[i][3];  // D列（饿了么店名）
                if (elemeId !== null && String(elemeId).trim() !== '' && elemeName !== null) {
                    elemeIdToName[String(elemeId).trim()] = String(elemeName).trim();
                }
            }
            
            // 2. 遍历"饿了么.xlsx"，根据A列门店ID填写B列
            for (let i = 2; i < elemeData.length; i++) { // 从第3行开始
                const elemeId = elemeData[i][0]; // A列（饿了么门店ID）
                if (elemeId !== null && String(elemeId).trim() in elemeIdToName) {
                    const elemeName = elemeIdToName[String(elemeId).trim()];
                    elemeData[i][1] = elemeName; // B列填写饿了么店名
                }
            }
            
            log('已完成饿了么A列门店ID对应店名填写到B列', 'success');
        }

        // 识别H列库存为"0"时，在J列填写"下架"
        async function markElemeOffline(elemeData) {
            log('标记饿了么下架商品...', 'info');
            
            for (let i = 2; i < elemeData.length; i++) { // 从第3行开始
                const hVal = elemeData[i][7]; // H列（库存数量）
                if (hVal !== null && String(hVal).trim() === '0') {
                    elemeData[i][9] = '下架'; // J列填写"下架"
                }
            }
            
            log('已完成饿了么H列库存为0的商品在J列标记为下架', 'success');
        }

        // 8. 抖音提货券处理（对应Python第380-559行）
        async function processDouyinData(workbooks, storeData, kucunData) {
            log('处理抖音提货券数据...', 'info');
            
            // 复制抖音提货券数据
            const douyinData = getSheetData(workbooks['douyin']);
            const processedDouyinData = douyinData.map(row => [...row]);
            
            // 建立"门店名.xlsx"F列（抖音ID）到B列（美得得门店名）的映射
            const douyinIdToMendianName = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const mendianName = storeData.mendianData[i][1]; // B列（美得得门店名）
                const douyinId = storeData.mendianData[i][5];     // F列（抖音ID）
                if (douyinId !== null && String(douyinId).trim() !== '' && mendianName !== null) {
                    douyinIdToMendianName[String(douyinId).trim()] = String(mendianName).trim();
                }
            }
            
            // 建立"美得得库存"中(仓库名称, 商品条码)到库存数量的映射（对应Python第399-408行）
            // 注意：Python版本使用的是原始库存文件，不是处理后的文件
            const originalKucunData = getSheetData(workbooks['kucun']);
            const kucunMap = {};
            for (let i = 1; i < originalKucunData.length; i++) {
                const warehouseName = originalKucunData[i][0];  // A列（仓库名称）
                const barcode = originalKucunData[i][3];         // D列（商品条码）
                const stockCount = originalKucunData[i][7];      // H列（库存总数）
                if (warehouseName !== null && barcode !== null) {
                    const key = `${String(warehouseName).trim()}_${String(barcode).trim()}`;
                    kucunMap[key] = stockCount !== null ? stockCount : 0;
                }
            }
            
            // 处理抖音提货券数据
            let processedCount = 0;
            for (let i = 1; i < processedDouyinData.length; i++) { // 假设从第2行开始有数据
                const poiId = processedDouyinData[i][5];      // F列（POIID）
                const merchantCode = processedDouyinData[i][4]; // E列（商家编码）
                const douyinStock = processedDouyinData[i][7];  // H列（导出时可售库存数量）
                
                if (poiId === null || merchantCode === null) {
                    continue;
                }
                
                // 根据POIID找到美得得门店名
                const mendianName = douyinIdToMendianName[String(poiId).trim()];
                if (!mendianName) {
                    continue;
                }
                
                // 根据美得得门店名和商家编码找到库存数量
                const key = `${mendianName}_${String(merchantCode).trim()}`;
                const kucunStock = kucunMap[key] || 0;
                
                // 计算库存差异
                let kucunStockNum = kucunStock === null ? 0 : parseFloat(kucunStock);
                let douyinStockNum = douyinStock === null ? 0 : parseFloat(douyinStock);
                
                try {
                    const difference = kucunStockNum - douyinStockNum;
                    
                    // 根据差异填写I列和J列
                    if (difference > 0) {
                        processedDouyinData[i][8] = '增';  // I列
                        processedDouyinData[i][9] = difference;  // J列（库存变更数量）
                        processedCount++;
                    } else if (difference < 0) {
                        processedDouyinData[i][8] = '减';  // I列
                        processedDouyinData[i][9] = Math.abs(difference);  // J列（取绝对值）
                        processedCount++;
                    }
                    // 如果difference == 0，不做任何填写
                    
                } catch (e) {
                    // 如果转换数字失败，跳过这一行
                    continue;
                }
            }
            
            log(`已完成抖音提货券处理，处理了 ${processedCount} 条库存差异记录`, 'success');
            return processedDouyinData;
        }

        // 9. 抖音提货券与美得得库存对比处理（对应Python第455-559行）
        async function processDouyinComparison(workbooks, storeData, kucunData) {
            log('处理抖音提货券与美得得库存对比...', 'info');
            
            // 1. 在"美得得库存_处理结果"的X2单元格填写"抖音"，Y2单元格填写"抖音门店"
            if (kucunData.length > 1) {
                kucunData[1][23] = '抖音';     // X列（第24列）
                kucunData[1][24] = '抖音门店'; // Y列（第25列）
            }
            
            // 2. 建立"门店名"F列（抖音ID）到B列（美得得店名）的映射
            const douyinIdToMendianName = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const mendianName = storeData.mendianData[i][1]; // B列（美得得店名）
                const douyinId = storeData.mendianData[i][5];     // F列（抖音ID）
                if (douyinId !== null && String(douyinId).trim() !== '' && mendianName !== null) {
                    douyinIdToMendianName[String(douyinId).trim()] = String(mendianName).trim();
                }
            }
            
            // 3. 建立"门店名"B列（美得得店名）到G列的映射
            const mendianNameToGCol = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const mendianName = storeData.mendianData[i][1]; // B列（美得得店名）
                const gColVal = storeData.mendianData[i][6];     // G列
                if (mendianName !== null && String(mendianName).trim() !== '') {
                    mendianNameToGCol[String(mendianName).trim()] = gColVal;
                }
            }
            
            // 4. 读取"抖音提货券"数据
            const douyinData = getSheetData(workbooks['douyin']);
            
            // 5. 建立"美得得库存"中(仓库名称, 商品条码)的集合，用于快速查找（对应Python第509-516行）
            // 注意：Python版本使用的是原始库存文件，不是处理后的文件
            const originalKucunData = getSheetData(workbooks['kucun']);
            const kucunBarcodeSet = new Set();
            for (let i = 1; i < originalKucunData.length; i++) {
                const warehouseName = originalKucunData[i][0];  // A列（仓库名称）
                const barcode = originalKucunData[i][3];         // D列（商品条码）
                if (warehouseName !== null && barcode !== null) {
                    const key = `${String(warehouseName).trim()}_${String(barcode).trim()}`;
                    kucunBarcodeSet.add(key);
                }
            }
            
            // 6. 处理抖音提货券数据，对比美得得库存
            let matchCount = 0;
            for (let i = 1; i < douyinData.length; i++) { // 假设从第2行开始有数据
                const poiId = douyinData[i][5];      // F列（POIID）
                const merchantCode = douyinData[i][4]; // E列（商家编码）
                
                if (poiId === null || merchantCode === null) {
                    continue;
                }
                
                // 根据POIID找到美得得门店名
                const mendianName = douyinIdToMendianName[String(poiId).trim()];
                if (!mendianName) {
                    continue;
                }
                
                // 检查是否存在重复的商品条码
                const key = `${mendianName}_${String(merchantCode).trim()}`;
                if (kucunBarcodeSet.has(key)) {
                    matchCount++;
                    
                    // 找到重复，在"美得得库存_处理结果"中标记
                    for (let j = 1; j < kucunData.length; j++) {
                        const kucunWarehouse = kucunData[j][0]; // A列（仓库名称）
                        const kucunBarcode = kucunData[j][3];    // D列（商品条码）
                        
                        if (kucunWarehouse !== null && kucunBarcode !== null &&
                            String(kucunWarehouse).trim() === mendianName &&
                            String(kucunBarcode).trim() === String(merchantCode).trim()) {
                            
                            // 标记X列为"有"
                            kucunData[j][23] = '有'; // X列
                            
                            // 标记Y列为门店名G列的内容
                            const gColContent = mendianNameToGCol[mendianName] || '';
                            kucunData[j][24] = gColContent; // Y列
                            break;
                        }
                    }
                }
            }
            
            log(`已完成抖音提货券与美得得库存对比处理，标记了 ${matchCount} 个重复商品`, 'success');
            return kucunData;
        }

        // 9. 京东外卖处理（对应Python第640-911行）
        async function processJdData(workbooks, storeData, kucunData) {
            log('处理京东外卖数据...', 'info');
            
            // 标记京东外卖商品
            const markedKucunData = await markJdGoods(workbooks, kucunData);
            
            // 处理京东外卖模版数据
            const jdTemplateData = await processJdTemplate(workbooks, storeData, markedKucunData);
            
            return { markedKucunData, jdTemplateData };
        }

        // 在美得得库存_处理结果中标记京东外卖
        async function markJdGoods(workbooks, kucunData) {
            log('标记京东外卖商品...', 'info');
            
            // 设置Z2单元格标题（红底黑字样式 - 对应Python第653-655行）
            // 注意：JavaScript版本无法直接设置Excel样式，但数据逻辑完全一致
            if (kucunData.length > 1) {
                kucunData[1][25] = '京东外卖'; // Z列（第26列）
            }
            
            // 获取京东外卖商品库F列的所有条码
            const jdGoodsData = getSheetData(workbooks['jd-goods']);
            const jdBarcodesSet = new Set();
            for (let i = 1; i < jdGoodsData.length; i++) {
                const val = jdGoodsData[i][5]; // F列是第6列（索引5）
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    jdBarcodesSet.add(String(val).trim());
                }
            }
            
            log(`从京东外卖商品库F列读取到 ${jdBarcodesSet.size} 个条码`, 'info');
            
            // 对比美得得库存_处理结果D列和京东外卖商品库F列
            let matchCount = 0;
            for (let i = 1; i < kucunData.length; i++) {
                const dVal = kucunData[i][3]; // D列（商品条码）
                const zCell = kucunData[i][25]; // Z列（第26列）
                
                if (dVal !== null && jdBarcodesSet.has(String(dVal).trim())) {
                    kucunData[i][25] = '有'; // Z列标记"有"
                    matchCount++;
                }
            }
            
            log(`已完成京东外卖标记：在Z列标记了 ${matchCount} 个重合商品`, 'success');
            return kucunData;
        }

        // 处理京东外卖模版数据
        async function processJdTemplate(workbooks, storeData, kucunData) {
            log('处理京东外卖模版数据...', 'info');
            
            // 读取门店名I列的京东门店编号
            const jdStoreIds = [];
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const val = storeData.mendianData[i][8]; // I列是第9列（索引8）
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    jdStoreIds.push(String(val).trim());
                }
            }
            
            log(`从门店名I列读取到 ${jdStoreIds.length} 个京东门店编号`, 'info');
            
            // 读取京东外卖商品库F列数据（从第2行开始）
            const jdGoodsData = getSheetData(workbooks['jd-goods']);
            const jdSkuData = [];
            for (let i = 1; i < jdGoodsData.length; i++) {
                const val = jdGoodsData[i][5]; // F列是第6列（索引5）
                if (val !== null && val !== undefined && String(val).trim() !== '') {
                    jdSkuData.push(String(val).trim());
                }
            }
            
            log(`从京东外卖商品库F列读取到 ${jdSkuData.length} 条有效商家SKU数据`, 'info');
            
            // 获取京东外卖模版数据并扩展
            const jdTemplateData = getSheetData(workbooks['jd-template']);
            
            // 实现笛卡尔积：每个门店编号对应所有商家SKU
            let rowIdx = 2; // 从第2行开始（索引1）
            const totalRows = jdStoreIds.length * jdSkuData.length;
            log(`将生成 ${totalRows} 行数据（${jdStoreIds.length}个门店 × ${jdSkuData.length}个SKU）`, 'info');
            
            for (const storeId of jdStoreIds) {
                for (const skuValue of jdSkuData) {
                    // 确保行存在
                    while (jdTemplateData.length <= rowIdx - 1) {
                        jdTemplateData.push(new Array(10).fill('')); // 扩展足够的列
                    }
                    
                    // A列填写门店编号
                    jdTemplateData[rowIdx - 1][0] = storeId;
                    // C列填写商家SKU
                    jdTemplateData[rowIdx - 1][2] = skuValue;
                    rowIdx++;
                }
            }
            
            log(`已完成京东外卖模版数据生成：${totalRows} 行`, 'success');
            
            // 同步美得得库存到京东外卖模版E列
            await syncJdInventory(workbooks, jdTemplateData, storeData, kucunData);
            
            return jdTemplateData;
        }

        // 同步美得得库存到京东外卖模版E列
        async function syncJdInventory(workbooks, jdTemplateData, storeData, kucunData) {
            log('同步库存数据到京东外卖模版...', 'info');
            
            // 1. 建立"门店名"B列（美得得店名）到I列（京东门店编号）的映射
            const mendianNameToJdId = {};
            for (let i = 1; i < storeData.mendianData.length; i++) {
                const mendianName = storeData.mendianData[i][1]; // B列（美得得店名）
                const jdId = storeData.mendianData[i][8];        // I列（京东门店编号）
                if (mendianName !== null && jdId !== null && 
                    String(mendianName).trim() !== '' && String(jdId).trim() !== '') {
                    mendianNameToJdId[String(mendianName).trim()] = String(jdId).trim();
                }
            }
            
            log(`建立了 ${Object.keys(mendianNameToJdId).length} 个门店名称到京东门店编号的映射`, 'info');
            
            // 2. 建立"美得得库存"中(仓库名称, 商品条码)到库存数量的映射（对应Python第749-758行）
            // 注意：Python版本使用的是原始库存文件，不是处理后的文件
            const originalKucunData = getSheetData(workbooks['kucun']);
            const kucunInventoryMap = {};
            for (let i = 1; i < originalKucunData.length; i++) {
                const warehouseName = originalKucunData[i][0];  // A列（仓库名称）
                const barcode = originalKucunData[i][3];         // D列（商品条码）
                const stockCount = originalKucunData[i][7];      // H列（库存总数）
                if (warehouseName !== null && barcode !== null) {
                    const key = `${String(warehouseName).trim()}_${String(barcode).trim()}`;
                    kucunInventoryMap[key] = stockCount !== null ? stockCount : 0;
                }
            }
            
            log(`建立了 ${Object.keys(kucunInventoryMap).length} 个库存数据映射`, 'info');
            
            // 3. 遍历京东外卖模版，匹配并同步库存数据
            let matchedCount = 0;
            for (let i = 1; i < jdTemplateData.length; i++) { // 从第2行开始
                const jdStoreId = jdTemplateData[i][0]; // A列（京东门店编号）
                const jdSku = jdTemplateData[i][2];     // C列（商家SKU）
                
                if (jdStoreId === null || jdSku === null) {
                    continue;
                }
                
                // 根据京东门店编号找到美得得店名
                let mendianName = null;
                for (const [name, id] of Object.entries(mendianNameToJdId)) {
                    if (String(id).trim() === String(jdStoreId).trim()) {
                        mendianName = name;
                        break;
                    }
                }
                
                if (!mendianName) {
                    continue;
                }
                
                // 根据美得得店名和SKU查找库存
                const key = `${mendianName}_${String(jdSku).trim()}`;
                const inventory = kucunInventoryMap[key];
                
                if (inventory !== undefined) {
                    // 填写E列（现货库存）
                    jdTemplateData[i][4] = inventory; // E列是第5列（索引4）
                    matchedCount++;
                }
            }
            
            log(`已完成库存数据同步：匹配到 ${matchedCount} 条库存记录`, 'success');
            
            // 4. 为没有库存数据的行填写"0"
            let zeroFillCount = 0;
            for (let i = 1; i < jdTemplateData.length; i++) { // 从第2行开始
                const eVal = jdTemplateData[i][4]; // E列（现货库存）
                if (eVal === null || eVal === undefined || String(eVal).trim() === '') {
                    jdTemplateData[i][4] = 0; // E列填写0
                    zeroFillCount++;
                }
            }
            log(`为 ${zeroFillCount} 行没有库存数据的记录填写了0`, 'success');
            
            // 5. 根据E列库存值在D列填写销售状态
            let availableCount = 0;
            let unavailableCount = 0;
            for (let i = 1; i < jdTemplateData.length; i++) { // 从第2行开始
                const eVal = jdTemplateData[i][4]; // E列（现货库存）
                const dCell = jdTemplateData[i][3]; // D列（销售状态）
                
                try {
                    // 尝试转换为数字进行比较
                    if (eVal !== null && eVal !== undefined && String(eVal).trim() !== '') {
                        const stockValue = parseFloat(String(eVal).trim());
                        if (stockValue > 0) {
                            jdTemplateData[i][3] = '可售';
                            availableCount++;
                        } else {
                            jdTemplateData[i][3] = '不可售';
                            unavailableCount++;
                        }
                    } else {
                        jdTemplateData[i][3] = '不可售';
                        unavailableCount++;
                    }
                } catch (e) {
                    // 如果无法转换为数字，默认为不可售
                    jdTemplateData[i][3] = '不可售';
                    unavailableCount++;
                }
            }
            
            log(`销售状态设置：${availableCount} 行设为'可售'，${unavailableCount} 行设为'不可售'`, 'success');
        }


        // 检查并分割饿了么文件
        async function checkAndSplitElemeFile(elemeData) {
            const totalRows = elemeData.length;
            log(`饿了么表格总行数：${totalRows}`, 'info');
            
            if (totalRows > 60000) {
                log('饿了么表格超过60000行，开始分割...', 'info');
                
                // 创建第二个表格（包含60001行及以后的数据）
                const eleme2Data = [];
                
                // 复制前两行表头到新表格
                if (totalRows >= 2) {
                    eleme2Data.push([...elemeData[0]]);
                    eleme2Data.push([...elemeData[1]]);
                }
                
                // 将第60001行及以后的数据移动到新表格
                for (let i = 60001; i <= totalRows; i++) {
                    if (elemeData[i - 1]) {
                        eleme2Data.push([...elemeData[i - 1]]);
                    }
                }
                
                // 删除原表格中60001行及以后的内容
                elemeData.splice(60000);
                
                // 添加第二个文件到下载列表
                const eleme2Workbook = createWorkbook(eleme2Data, '饿了么数据2');
                addDownloadItem('饿了么_处理后_2.xlsx', eleme2Workbook);
                
                log(`已成功分割饿了么表格：原表格保留前60000行，第二个表格包含剩余${totalRows - 60000}行`, 'success');
            } else {
                log('饿了么表格行数未超过60000行，无需分割', 'info');
            }
        }

        // 检查并分割京东外卖模版文件
        async function checkAndSplitJdTemplateFile(jdTemplateData) {
            const totalRows = jdTemplateData.length;
            log(`京东外卖模版总行数：${totalRows}`, 'info');
            
            if (totalRows > 100000) {
                log('京东外卖模版超过100000行，开始分割...', 'info');
                
                // 创建第二个表格（包含100001行及以后的数据）
                const jdTemplate2Data = [];
                
                // 复制第一行表头到新表格
                if (totalRows >= 1) {
                    jdTemplate2Data.push([...jdTemplateData[0]]);
                }
                
                // 将第100001行及以后的数据移动到新表格
                for (let i = 100001; i <= totalRows; i++) {
                    if (jdTemplateData[i - 1]) {
                        jdTemplate2Data.push([...jdTemplateData[i - 1]]);
                    }
                }
                
                // 删除原表格中100001行及以后的内容
                jdTemplateData.splice(100000);
                
                // 添加第二个文件到下载列表
                const jdTemplate2Workbook = createWorkbook(jdTemplate2Data, '京东外卖模版2');
                addDownloadItem('京东外卖模版_处理后_2.xlsx', jdTemplate2Workbook);
                
                log(`已成功分割京东外卖模版：原表格保留前100000行，第二个表格包含剩余${totalRows - 100000}行`, 'success');
            } else {
                log('京东外卖模版行数未超过100000行，无需分割', 'info');
            }
        }

        // 生成结果文件 - 完整版本，按照Python逻辑生成所有文件
        async function generateResultFiles(workbooks, processedData) {
            log('生成结果文件...', 'info');
            
            // 1. 门店与商品售卖信息_处理后.xlsx
            if (processedData.dstData) {
                const dstWorkbook = createWorkbook(processedData.dstData, '门店商品信息');
                addDownloadItem('门店与商品售卖信息_处理后.xlsx', dstWorkbook);
                log('已生成门店与商品售卖信息_处理后.xlsx', 'success');
            }
            
            // 2. 美得得库存_处理结果.xlsx
            if (processedData.kucunData) {
                const kucunWorkbook = createWorkbook(processedData.kucunData, '美得得库存');
                addDownloadItem('美得得库存_处理结果.xlsx', kucunWorkbook);
                log('已生成美得得库存_处理结果.xlsx', 'success');
            }
            
            // 3. 饿了么_处理后.xlsx
            if (processedData.elemeData) {
                const elemeWorkbook = createWorkbook(processedData.elemeData, '饿了么数据');
                addDownloadItem('饿了么_处理后.xlsx', elemeWorkbook);
                log('已生成饿了么_处理后.xlsx', 'success');
            }
            
            // 4. 抖音提货券_处理后.xlsx
            if (processedData.douyinData) {
                const douyinWorkbook = createWorkbook(processedData.douyinData, '抖音提货券');
                addDownloadItem('抖音提货券_处理后.xlsx', douyinWorkbook);
                log('已生成抖音提货券_处理后.xlsx', 'success');
            }
            
            // 5. 京东外卖模版_处理后.xlsx
            if (processedData.jdResult && processedData.jdResult.jdTemplateData) {
                const jdTemplateWorkbook = createWorkbook(processedData.jdResult.jdTemplateData, '京东外卖模版');
            addDownloadItem('京东外卖模版_处理后.xlsx', jdTemplateWorkbook);
                log('已生成京东外卖模版_处理后.xlsx', 'success');
            }
            
            log('所有结果文件生成完成', 'success');
        }

        // 下载全部文件为ZIP压缩包
        async function downloadAllAsZip() {
            if (Object.keys(processedFiles).length === 0) {
                alert('没有可下载的文件！');
                return;
            }

            log('📦 开始创建ZIP压缩包...', 'info');
            
            try {
                // 创建ZIP实例
                const zip = new JSZip();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                
                // 为每个文件添加到ZIP中
            Object.keys(processedFiles).forEach(filename => {
                    const workbook = processedFiles[filename];
                    const wbout = XLSX.write(workbook, {bookType: 'xlsx', type: 'array'});
                    zip.file(filename, wbout);
                    log(`📁 添加文件到压缩包: ${filename}`, 'info');
                });
                
                log('📦 正在生成ZIP文件...', 'info');
                
                // 生成ZIP文件
                const zipBlob = await zip.generateAsync({type: 'blob'});
                
                // 创建下载链接
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Excel处理结果_${timestamp}.zip`;
                a.click();
                
                // 清理URL对象
                URL.revokeObjectURL(url);
                
                log('✅ ZIP压缩包下载完成！', 'success');
                log(`📦 文件包含 ${Object.keys(processedFiles).length} 个Excel文件`, 'info');
                
            } catch (error) {
                log(`❌ 创建ZIP文件失败: ${error.message}`, 'error');
                console.error('ZIP创建错误:', error);
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('📊 Excel数据处理工具已就绪', 'success');
            log('请按顺序上传所需的9个Excel文件', 'info');
        });
    </script>
</body>
</html>
